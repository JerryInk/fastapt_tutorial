# **–ù–µ–¥–µ–ª—è 7: –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (SQL)**

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–õ–µ–∫—Ü–∏—è 7.1: –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É —Å –ë–î –≤ FastAPI](#–ª–µ–∫—Ü–∏—è-71-–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-—Ä–∞–±–æ—Ç—É-—Å-–±–¥-–≤-fastapi)
   - –ü–æ—á–µ–º—É –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
   - –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
   - SQLAlchemy 2.0 - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
   - –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy
2. [–õ–µ–∫—Ü–∏—è 7.2: –†–∞–±–æ—Ç–∞ —Å –ë–î –≤ FastAPI (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)](#–ª–µ–∫—Ü–∏—è-72-—Ä–∞–±–æ—Ç–∞-—Å-–±–¥-–≤-fastapi-crud-–æ–ø–µ—Ä–∞—Ü–∏–∏)
   - –ü–∞—Ç—Ç–µ—Ä–Ω Repository + Service
   - –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (Business Logic)
   - RESTful API endpoints
   - –†–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
3. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é 7](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ-–∑–∞–¥–∞–Ω–∏–µ-–Ω–∞-–Ω–µ–¥–µ–ª—é-7)

---

## **–õ–µ–∫—Ü–∏—è 7.1: –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É —Å –ë–î –≤ FastAPI**

**–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∏–Ω–¥–µ–∫—Å—ã —É—Å–∫–æ—Ä—è—é—Ç –ø–æ–∏—Å–∫
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –ë–î –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### **1. –ü–æ—á–µ–º—É –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç?**

**–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ –ë–î:**
```python
# –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù: –î–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
users_in_memory = []
books_in_memory = []

@app.post("/users/")
async def create_user(user_data: UserCreate):
    user_id = len(users_in_memory) + 1
    user = {"id": user_id, **user_data.model_dump()}
    users_in_memory.append(user)  # üí• –î–∞–Ω–Ω—ã–µ –∏—Å—á–µ–∑–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ!
    return user

# –ü—Ä–æ–±–ª–µ–º—ã:
# 1. –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
# 2. –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
# 3. –ù–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
# 4. –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
# 5. –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
# 6. –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
```

### **2. –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î**

**–ê–Ω–∞–ª–æ–≥–∏—è:** –†–∞–±–æ—Ç–∞ —Å –ë–î –ø–æ—Ö–æ–∂–∞ –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É:
- **SQLAlchemy ORM** ‚Äî –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç, –≥–¥–µ –∫–∞–∫–∞—è –∫–Ω–∏–≥–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫)
- **SQLAlchemy Core** ‚Äî –∫–∞–∫ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Ç–∞–ª–æ–≥—É (–±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è)
- **Raw SQL** ‚Äî –∫–∞–∫ —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª–∫–∞–º (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞:**
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** ‚Äî ORM –ø—Ä–æ—â–µ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî Raw SQL –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî Core –¥–∞–µ—Ç –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ—Å—Ç–æ—Ç–æ–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ async** ‚Äî –≤–∞–∂–Ω–æ –¥–ª—è FastAPI

#### **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤:**

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π/–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –£—Ä–æ–≤–µ–Ω—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ FastAPI |
|------------|----------------------|---------|-----------|-------------------|-------------------------|
| **SQLAlchemy Core** | –û–±–∞ | –ù–∏–∑–∫–∏–π | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –†–µ–¥–∫–æ, –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **SQLAlchemy ORM** | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –ß–∞—Å—Ç–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç async –∞–¥–∞–ø—Ç–µ—Ä–∞ |
| **SQLAlchemy 2.0 (async)** | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | **–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** |
| **Tortoise-ORM** | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –í—ã—Å–æ–∫–∏–π | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –•–æ—Ä–æ—à–æ, –Ω–æ –º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–µ–Ω |
| **databases** | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –ù–∏–∑–∫–∏–π | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –•–æ—Ä–æ—à–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ |
| **asyncpg/aiosqlite** | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π | –ù–∏–∑–∫–∏–π | –í—ã—Å–æ–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –î–ª—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ |

#### **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫—É—Ä—Å–∞:**

**–î–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:**
```bash
# SQLite - –ø—Ä–æ—Å—Ç–∞—è —Ñ–∞–π–ª–æ–≤–∞—è –ë–î
pip install sqlalchemy aiosqlite

# –ò–ª–∏ PostgreSQL –¥–ª—è production-–ø–æ–¥–æ–±–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
pip install sqlalchemy asyncpg psycopg2-binary
```

**–î–ª—è production –ø—Ä–æ–µ–∫—Ç–æ–≤:**
```bash
# SQLAlchemy 2.0 + async –¥—Ä–∞–π–≤–µ—Ä
pip install "sqlalchemy>=2.0" asyncpg

# + Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
pip install alembic

# + —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
pip install python-dotenv pydantic-settings
```

### **3. SQLAlchemy 2.0 - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**

**–ü–æ—á–µ–º—É SQLAlchemy 2.0:**
- –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ async/await –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π API
- –õ—É—á—à–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è IDE –∏ mypy
- –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ

**–û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç 1.x:**

**1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `async_sessionmaker` –≤–º–µ—Å—Ç–æ `sessionmaker` –¥–ª—è async**

–í SQLAlchemy 1.x –¥–ª—è async –Ω—É–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏:
```python
# SQLAlchemy 1.x (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–ø–æ—Å–æ–±)
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.asyncio import AsyncSession

SessionLocal = sessionmaker(
    class_=AsyncSession,
    bind=engine,
    expire_on_commit=False
)
```

–í SQLAlchemy 2.0+ —ç—Ç–æ —É–ø—Ä–æ—â–µ–Ω–æ:
```python
# SQLAlchemy 2.0+ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)
from sqlalchemy.ext.asyncio import async_sessionmaker, AsyncSession

AsyncSessionLocal = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–æ–ª–µ–µ —è–≤–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π API
- –õ—É—á—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- –ú–µ–Ω—å—à–µ –ø—É—Ç–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É sync –∏ async —Å–µ—Å—Å–∏—è–º–∏

**2. `create_async_engine` –Ω–µ —Ç—Ä–µ–±—É–µ—Ç `future=True`**

–í SQLAlchemy 1.x –Ω—É–∂–Ω–æ –±—ã–ª–æ —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å `future=True` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ API:
```python
# SQLAlchemy 1.x
from sqlalchemy.ext.asyncio import create_async_engine

engine = create_async_engine(
    DATABASE_URL,
    future=True  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ API
)
```

–í SQLAlchemy 2.0+ —ç—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
```python
# SQLAlchemy 2.0+
from sqlalchemy.ext.asyncio import create_async_engine

engine = create_async_engine(
    DATABASE_URL,
    # future=True –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω - —ç—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –ú–µ–Ω—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ù–æ–≤—ã–π API —Å—Ç–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
- –ú–µ–Ω—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –æ—à–∏–±–æ–∫

**3. –ë–æ–ª–µ–µ —è–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**

–í SQLAlchemy 1.x —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥–ª–∏ –±—ã—Ç—å –Ω–µ—è–≤–Ω—ã–º–∏:
```python
# SQLAlchemy 1.x - –Ω–µ—è–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
session = SessionLocal()
user = User(name="John")
session.add(user)
session.commit()  # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

–í SQLAlchemy 2.0+ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —è–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```python
# SQLAlchemy 2.0+ - —è–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
async with AsyncSessionLocal() as session:
    async with session.begin():  # –Ø–≤–Ω–æ–µ –Ω–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        user = User(name="John")
        session.add(user)
        # –ö–æ–º–º–∏—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —è–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
- –ü–æ–Ω—è—Ç–Ω–µ–µ, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
- –õ–µ–≥—á–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ú–µ–Ω—å—à–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤
- –õ—É—á—à–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–æ–≤**

–í SQLAlchemy 1.x —Ç–∏–ø–∏–∑–∞—Ü–∏—è –±—ã–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π:
```python
# SQLAlchemy 1.x - —Å–ª–∞–±–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
from sqlalchemy.orm import Session

def get_user(session: Session, user_id: int):
    # IDE –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –≤–µ—Ä–Ω–µ—Ç—Å—è User
    return session.query(User).filter(User.id == user_id).first()
```

–í SQLAlchemy 2.0+ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞:
```python
# SQLAlchemy 2.0+ - —É–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

async def get_user(session: AsyncSession, user_id: int) -> User | None:
    # IDE –∑–Ω–∞–µ—Ç, —á—Ç–æ –≤–µ—Ä–Ω–µ—Ç—Å—è User | None
    result = await session.execute(select(User).where(User.id == user_id))
    return result.scalar_one_or_none()  # –¢–∏–ø: User | None
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏:**
- –õ—É—á—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ IDE (–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤)
- –†–∞–±–æ—Ç–∞ —Å mypy –∏ –¥—Ä—É–≥–∏–º–∏ type checkers
- –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ –Ω–∞ —ç—Ç–∞–ø–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ SQLAlchemy 2.0:**
- **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API** ‚Äî –æ–¥–∏–Ω —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã –¥–ª—è sync –∏ async
- **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `select()` –≤–º–µ—Å—Ç–æ `query()`
- **–£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

#### **–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ SQLAlchemy 2.0:**
1. **–ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ async/await** ‚Äî –Ω–µ –Ω—É–∂–Ω—ã –æ–±—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏
2. **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π API** ‚Äî –º–µ–Ω—å—à–µ "–º–∞–≥–∏–∏", –±–æ–ª—å—à–µ —è–≤–Ω–æ—Å—Ç–∏
3. **–ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è** ‚Äî –ª—É—á—à–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ IDE –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
4. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
5. **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö Python –ø—Ä–∞–∫—Ç–∏–∫

#### **–ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
- **Engine** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î
- **Session** ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- **Base** ‚Äî –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π

```python
# app/core/database.py
from typing import AsyncGenerator
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine, async_sessionmaker
from sqlalchemy.orm import DeclarativeBase
from app.core.config import settings

class Base(DeclarativeBase):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π SQLAlchemy
    
    –í—Å–µ –º–æ–¥–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞.
    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç SQLAlchemy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã.
    """
    pass

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å postgresql+asyncpg:// –∏–ª–∏ sqlite+aiosqlite://
engine = create_async_engine(
    settings.DATABASE_URL,
    echo=settings.DEBUG,  # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    # pool_size - —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
    # max_overflow - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–≤–µ—Ä—Ö pool_size
    pool_pre_ping=True,  # –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    # –í SQLAlchemy 2.0+ future=True –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π
# async_sessionmaker —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
AsyncSessionLocal = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,  # –ù–µ –∏—Å—Ç–µ–∫–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ (—É–¥–æ–±–Ω–æ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö)
    autocommit=False,  # –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞–º–∏
    autoflush=False,  # –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ flush (–æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î)
)

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ë–î
    
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        @app.get("/items/")
        async def get_items(db: AsyncSession = Depends(get_db)):
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º db –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
            result = await db.execute(select(Item))
            return result.scalars().all()
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
    """
    async with AsyncSessionLocal() as session:
        try:
            yield session
            await session.commit()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        except Exception:
            await session.rollback()  # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
            raise
        finally:
            await session.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é
```

### **4. –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy**

**–ß—Ç–æ —Ç–∞–∫–æ–µ –º–æ–¥–µ–ª—å SQLAlchemy:**
- –ö–ª–∞—Å—Å Python, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∑–∞–ø—Ä–æ—Å—ã
- –£–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ –æ–±—ä–µ–∫—Ç—ã Python

**–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É SQLAlchemy –º–æ–¥–µ–ª—è–º–∏ –∏ Pydantic –º–æ–¥–µ–ª—è–º–∏:**
- **SQLAlchemy –º–æ–¥–µ–ª–∏** (`app/models/`) ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î, —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î
- **Pydantic –º–æ–¥–µ–ª–∏** (`app/schemas/`) ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö API, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

#### **–ë–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏:**
```python
# app/models/base.py
from sqlalchemy import Column, Integer, Boolean, DateTime, func
from sqlalchemy.orm import DeclarativeBase, declared_attr
from datetime import datetime, timezone

class Base(DeclarativeBase):
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏
    
    –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—â–∏–µ –ø–æ–ª—è: id, created_at, updated_at
    """
    
    @declared_attr
    def __tablename__(cls) -> str:
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã: User ‚Üí users
        
        –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö, —É–∫–∞–∑–∞–≤ __tablename__ —è–≤–Ω–æ.
        """
        return cls.__name__.lower() + 's'
    
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        nullable=False
    )
    updated_at = Column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
        nullable=True
    )

class SoftDeleteMixin:
    """Mixin –¥–ª—è –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    
    –í–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î –ø–æ–º–µ—á–∞–µ–º –µ—ë –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—É—é.
    –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
    - –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è
    - –ù–µ –Ω–∞—Ä—É—à–∞—é—Ç—Å—è –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    """
    is_deleted = Column(Boolean, default=False, nullable=False, index=True)
    deleted_at = Column(DateTime(timezone=True), nullable=True)
    
    def soft_delete(self):
        """–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏"""
        self.is_deleted = True
        self.deleted_at = datetime.now(timezone.utc)
    
    def restore(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏"""
        self.is_deleted = False
        self.deleted_at = None
```

#### **–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```python
# app/models/user.py
from sqlalchemy import Column, String, Boolean, DateTime, Enum, Text, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.dialects.postgresql import UUID
import enum
from datetime import datetime
from app.models.base import Base, SoftDeleteMixin

class UserRole(str, enum.Enum):
    """–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    ADMIN = "admin"
    LIBRARIAN = "librarian"
    READER = "reader"
    GUEST = "guest"

class User(Base, SoftDeleteMixin):
    """–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    __tablename__ = "users"
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    email = Column(String(255), unique=True, index=True, nullable=False)
    username = Column(String(100), unique=True, index=True, nullable=False)
    hashed_password = Column(String(255), nullable=False)
    full_name = Column(String(200), nullable=True)
    
    # –†–æ–ª—å –∏ —Å—Ç–∞—Ç—É—Å
    role = Column(Enum(UserRole), default=UserRole.READER, nullable=False)
    is_active = Column(Boolean, default=True, nullable=False)
    is_verified = Column(Boolean, default=False, nullable=False)
    
    # –ü—Ä–æ—Ñ–∏–ª—å
    bio = Column(Text, nullable=True)
    avatar_url = Column(String(500), nullable=True)
    phone = Column(String(20), nullable=True)
    
    # –î–∞—Ç—ã
    last_login = Column(DateTime, nullable=True)
    email_verified_at = Column(DateTime, nullable=True)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
    # –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ –∫–Ω–∏–≥
    books = relationship("Book", back_populates="owner", lazy="selectin")
    
    # –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ –∑–∞–∫–∞–∑–æ–≤
    orders = relationship("Order", back_populates="user", lazy="selectin")
    
    # –ò–Ω–¥–µ–∫—Å—ã
    __table_args__ = (
        # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        Index('idx_user_active_role', 'is_active', 'role'),
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —á–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ª—É—á—à–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
        # –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –°–£–ë–î
    )
    
    # –°–≤–æ–π—Å—Ç–≤–∞
    @property
    def is_admin(self):
        return self.role == UserRole.ADMIN
    
    @property
    def display_name(self):
        return self.full_name or self.username
    
    # –ú–µ—Ç–æ–¥—ã
    def verify_email(self):
        """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email"""
        self.is_verified = True
        self.email_verified_at = datetime.now(timezone.utc)
    
    def update_last_login(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞"""
        self.last_login = datetime.now(timezone.utc)
```

#### **–ú–æ–¥–µ–ª—å –∫–Ω–∏–≥–∏ —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏:**
```python
# app/models/book.py
from sqlalchemy import (
    Column, String, Integer, Float, Boolean, DateTime, 
    Text, ForeignKey, Enum, Table, Index
)
from sqlalchemy.orm import relationship
from sqlalchemy.dialects.postgresql import JSONB, UUID
import enum
from datetime import datetime
from app.models.base import Base, SoftDeleteMixin

# –°–≤—è–∑—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º (–∫–Ω–∏–≥–∏-–∞–≤—Ç–æ—Ä—ã)
book_authors = Table(
    'book_authors',
    Base.metadata,
    Column('book_id', ForeignKey('books.id'), primary_key=True),
    Column('author_id', ForeignKey('authors.id'), primary_key=True),
    Column('created_at', DateTime(timezone=True), default=lambda: datetime.now(timezone.utc)),
)

# –°–≤—è–∑—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–Ω–∏–≥–∏-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
book_categories = Table(
    'book_categories',
    Base.metadata,
    Column('book_id', ForeignKey('books.id'), primary_key=True),
    Column('category_id', ForeignKey('categories.id'), primary_key=True),
)

class BookStatus(str, enum.Enum):
    """–°—Ç–∞—Ç—É—Å—ã –∫–Ω–∏–≥–∏"""
    AVAILABLE = "available"
    BORROWED = "borrowed"
    RESERVED = "reserved"
    MAINTENANCE = "maintenance"
    LOST = "lost"

class Book(Base, SoftDeleteMixin):
    """–ú–æ–¥–µ–ª—å –∫–Ω–∏–≥–∏"""
    
    __tablename__ = "books"
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    title = Column(String(500), nullable=False, index=True)
    isbn = Column(String(17), unique=True, nullable=False)  # ISBN-13
    isbn10 = Column(String(10), unique=True, nullable=True)  # ISBN-10
    
    # –û–ø–∏—Å–∞–Ω–∏–µ
    description = Column(Text, nullable=True)
    short_description = Column(String(1000), nullable=True)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    publication_year = Column(Integer, nullable=False)
    publisher = Column(String(255), nullable=True)
    language = Column(String(2), default="ru", nullable=False)  # ISO 639-1
    pages = Column(Integer, nullable=True)
    
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å
    status = Column(Enum(BookStatus), default=BookStatus.AVAILABLE, nullable=False)
    condition_rating = Column(Integer, default=5)  # 1-5
    
    # –¶–µ–Ω–∞ –∏ –∞—Ä–µ–Ω–¥–∞
    price = Column(Float, nullable=False)  # –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏
    daily_rent_price = Column(Float, nullable=True)  # –¶–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã –≤ –¥–µ–Ω—å
    deposit_amount = Column(Float, nullable=True)  # –ó–∞–ª–æ–≥
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    total_copies = Column(Integer, default=1, nullable=False)
    available_copies = Column(Integer, default=1, nullable=False)
    
    # –†–µ–π—Ç–∏–Ω–≥–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    average_rating = Column(Float, default=0.0)
    rating_count = Column(Integer, default=0)
    view_count = Column(Integer, default=0)
    borrow_count = Column(Integer, default=0)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    owner_id = Column(Integer, ForeignKey('users.id'), nullable=True)
    location_id = Column(Integer, ForeignKey('locations.id'), nullable=True)
    
    # –°–ª–æ–∂–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
    metadata = Column(JSONB, nullable=True)  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    owner = relationship("User", back_populates="books", lazy="selectin")
    location = relationship("Location", lazy="selectin")
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏–µ –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å –∞–≤—Ç–æ—Ä–∞–º–∏
    authors = relationship(
        "Author", 
        secondary=book_authors,
        back_populates="books",
        lazy="selectin"
    )
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏–µ –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
    categories = relationship(
        "Category",
        secondary=book_categories,
        back_populates="books",
        lazy="selectin"
    )
    
    # –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º —Å –∑–∞–∫–∞–∑–∞–º–∏
    orders = relationship("Order", back_populates="book", lazy="selectin")
    
    # –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º —Å –æ—Ç–∑—ã–≤–∞–º–∏
    reviews = relationship("Review", back_populates="book", lazy="selectin")
    
    # –ò–Ω–¥–µ–∫—Å—ã
    __table_args__ = (
        # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
        Index('idx_book_title_author', 'title'),
        
        # –ò–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        Index('idx_book_status_year', 'status', 'publication_year'),
        
        # –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥ (PostgreSQL)
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
        # Index('idx_book_available', 'available_copies', 'status', 
        #       postgresql_where=text('available_copies > 0')),
        
        # –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (PostgreSQL)
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ª—É—á—à–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
        # –∏–∑-–∑–∞ —Å–ª–æ–∂–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞, –∑–∞–≤–∏—Å—è—â–µ–≥–æ –æ—Ç –°–£–ë–î
        # Index(
        #     'idx_book_fts',
        #     func.to_tsvector(
        #         'russian',
        #         func.coalesce(title, '') + ' ' + func.coalesce(description, '')
        #     ),
        #     postgresql_using='gin'
        # ),
    )
    
    # –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    @property
    def is_available(self):
        return (
            self.status == BookStatus.AVAILABLE 
            and self.available_copies > 0
        )
    
    @property
    def borrow_ratio(self):
        if self.total_copies > 0:
            return self.borrow_count / self.total_copies
        return 0
    
    # –ú–µ—Ç–æ–¥—ã
    def borrow(self):
        """–í–∑—è—Ç—å –∫–Ω–∏–≥—É –≤ –∞—Ä–µ–Ω–¥—É"""
        if not self.is_available:
            raise ValueError("–ö–Ω–∏–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã")
        
        self.available_copies -= 1
        if self.available_copies == 0:
            self.status = BookStatus.BORROWED
        
        self.borrow_count += 1
    
    def return_book(self):
        """–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É"""
        self.available_copies += 1
        if self.status == BookStatus.BORROWED:
            self.status = BookStatus.AVAILABLE
```

#### **–ú–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π:**
```python
# app/models/order.py
from sqlalchemy import (
    Column, String, Integer, Float, Boolean, DateTime, 
    Enum, ForeignKey, Numeric, Text
)
from sqlalchemy.orm import relationship
from sqlalchemy.dialects.postgresql import UUID, JSONB
import enum
from datetime import datetime, timedelta
from decimal import Decimal
from app.models.base import Base

class OrderStatus(str, enum.Enum):
    """–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞"""
    PENDING = "pending"      # –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    CONFIRMED = "confirmed"  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
    PROCESSING = "processing" # –í –æ–±—Ä–∞–±–æ—Ç–∫–µ
    SHIPPED = "shipped"      # –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
    DELIVERED = "delivered"  # –î–æ—Å—Ç–∞–≤–ª–µ–Ω
    CANCELLED = "cancelled"  # –û—Ç–º–µ–Ω–µ–Ω
    RETURNED = "returned"    # –í–æ–∑–≤—Ä–∞—â–µ–Ω

class PaymentMethod(str, enum.Enum):
    """–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã"""
    CASH = "cash"
    CARD = "card"
    ONLINE = "online"
    BANK_TRANSFER = "bank_transfer"

class OrderType(str, enum.Enum):
    """–¢–∏–ø—ã –∑–∞–∫–∞–∑–∞"""
    PURCHASE = "purchase"    # –ü–æ–∫—É–ø–∫–∞
    RENTAL = "rental"        # –ê—Ä–µ–Ω–¥–∞

class Order(Base):
    """–ú–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–∞"""
    
    __tablename__ = "orders"
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    order_number = Column(String(50), unique=True, nullable=False, index=True)
    order_type = Column(Enum(OrderType), nullable=False)
    status = Column(Enum(OrderStatus), default=OrderStatus.PENDING, nullable=False)
    
    # –î–∞—Ç—ã
    order_date = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)
    required_date = Column(DateTime(timezone=True), nullable=True)  # –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –∑–∞–∫–∞–∑
    shipped_date = Column(DateTime(timezone=True), nullable=True)   # –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
    delivered_date = Column(DateTime(timezone=True), nullable=True) # –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
    
    # –î–ª—è –∞—Ä–µ–Ω–¥—ã
    rental_start_date = Column(DateTime(timezone=True), nullable=True)
    rental_end_date = Column(DateTime(timezone=True), nullable=True)
    actual_return_date = Column(DateTime(timezone=True), nullable=True)
    
    # –°—Ç–æ–∏–º–æ—Å—Ç—å
    subtotal = Column(Numeric(10, 2), nullable=False, default=0)  # –°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤
    tax_amount = Column(Numeric(10, 2), nullable=False, default=0) # –ù–∞–ª–æ–≥
    shipping_cost = Column(Numeric(10, 2), nullable=False, default=0) # –î–æ—Å—Ç–∞–≤–∫–∞
    discount_amount = Column(Numeric(10, 2), nullable=False, default=0) # –°–∫–∏–¥–∫–∞
    total_amount = Column(Numeric(10, 2), nullable=False, default=0) # –ò—Ç–æ–≥–æ
    
    # –û–ø–ª–∞—Ç–∞
    payment_method = Column(Enum(PaymentMethod), nullable=True)
    payment_status = Column(Boolean, default=False, nullable=False)  # –û–ø–ª–∞—á–µ–Ω–æ?
    payment_date = Column(DateTime, nullable=True)
    transaction_id = Column(String(100), nullable=True)
    
    # –î–æ—Å—Ç–∞–≤–∫–∞
    shipping_address = Column(Text, nullable=True)
    shipping_city = Column(String(100), nullable=True)
    shipping_zip = Column(String(20), nullable=True)
    shipping_country = Column(String(100), nullable=True)
    
    # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    notes = Column(Text, nullable=True)
    cancellation_reason = Column(Text, nullable=True)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    book_id = Column(Integer, ForeignKey('books.id'), nullable=False)
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    user = relationship("User", back_populates="orders", lazy="selectin")
    book = relationship("Book", back_populates="orders", lazy="selectin")
    
    # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (JSON)
    status_history = Column(JSONB, default=list)
    
    # –ò–Ω–¥–µ–∫—Å—ã
    __table_args__ = (
        # –î–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Index('idx_order_user_status', 'user_id', 'status', 'order_date'),
        
        # –î–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –¥–∞—Ç–∞–º
        Index('idx_order_date_type', 'order_date', 'order_type'),
        
        # –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞
        Index('idx_order_number', 'order_number', postgresql_ops={'order_number': 'text_pattern_ops'}),
    )
    
    # –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    @property
    def is_overdue(self):
        """–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –ª–∏ –∞—Ä–µ–Ω–¥–∞"""
        if self.order_type != OrderType.RENTAL:
            return False
        
        if not self.rental_end_date or self.status != OrderStatus.SHIPPED:
            return False
        
        return datetime.now(timezone.utc) > self.rental_end_date
    
    @property
    def overdue_days(self):
        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏"""
        if not self.is_overdue:
            return 0
        
        return (datetime.now(timezone.utc) - self.rental_end_date).days
    
    @property
    def overdue_fee(self):
        """–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É"""
        if not self.is_overdue:
            return Decimal('0.00')
        
        daily_fee = self.book.daily_rent_price * Decimal('1.5')  # 150% –æ—Ç –¥–Ω–µ–≤–Ω–æ–π –∞—Ä–µ–Ω–¥—ã
        return daily_fee * Decimal(str(self.overdue_days))
    
    # –ú–µ—Ç–æ–¥—ã
    def generate_order_number(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞"""
        if not self.order_number:
            timestamp = datetime.now(timezone.utc).strftime("%Y%m%d%H%M%S")
            user_id_part = str(self.user_id).zfill(6)
            self.order_number = f"ORD-{timestamp}-{user_id_part}"
    
    def add_status_history(self, status, notes=None, changed_by=None):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤"""
        history_entry = {
            "status": status,
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "notes": notes,
            "changed_by": changed_by
        }
        
        if not self.status_history:
            self.status_history = []
        
        self.status_history.append(history_entry)
        self.status = status
    
    def calculate_total(self):
        """–†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã"""
        # –ë–∞–∑–æ–≤–∞—è —Å—É–º–º–∞
        if self.order_type == OrderType.PURCHASE:
            self.subtotal = self.book.price
        elif self.order_type == OrderType.RENTAL and self.book.daily_rent_price:
            rental_days = (self.rental_end_date - self.rental_start_date).days
            self.subtotal = self.book.daily_rent_price * rental_days
        
        # –ò—Ç–æ–≥ —Å —É—á–µ—Ç–æ–º –Ω–∞–ª–æ–≥–æ–≤ –∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        self.total_amount = (
            self.subtotal + 
            self.tax_amount + 
            self.shipping_cost - 
            self.discount_amount
        )
```

---

## **–õ–µ–∫—Ü–∏—è 7.2: –†–∞–±–æ—Ç–∞ —Å –ë–î –≤ FastAPI (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)**

### **1. –ü–∞—Ç—Ç–µ—Ä–Ω Repository + Service**

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã Repository –∏ Service:**
- **Repository** ‚Äî –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ë–î, —Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ SQL
- **Service** ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** ‚Äî –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –º–µ–Ω—è—Ç—å

**–ê–Ω–∞–ª–æ–≥–∏—è:** 
- **Repository** ‚Äî –∫–∞–∫ —Å–∫–ª–∞–¥, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç, –≥–¥–µ —á—Ç–æ –ª–µ–∂–∏—Ç
- **Service** ‚Äî –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –∏ –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤–∞—Ç—å

#### **–ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
```python
# app/repositories/base.py
from typing import Generic, TypeVar, Type, Optional, List, Dict, Any
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, delete, func
from sqlalchemy.exc import SQLAlchemyError
from app.models.base import Base

ModelType = TypeVar("ModelType", bound=Base)

class BaseRepository(Generic[ModelType]):
    """–ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏"""
    
    def __init__(self, model: Type[ModelType], db: AsyncSession):
        self.model = model
        self.db = db
    
    async def create(self, **kwargs) -> ModelType:
        """–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å"""
        try:
            instance = self.model(**kwargs)
            self.db.add(instance)
            await self.db.commit()
            await self.db.refresh(instance)
            return instance
        except SQLAlchemyError as e:
            await self.db.rollback()
            raise e
    
    async def get(self, id: int) -> Optional[ModelType]:
        """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ ID"""
        query = select(self.model).where(self.model.id == id)
        result = await self.db.execute(query)
        return result.scalar_one_or_none()
    
    async def get_multi(
        self, 
        skip: int = 0, 
        limit: int = 100,
        **filters
    ) -> List[ModelType]:
        """–ü–æ–ª—É—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
        query = select(self.model)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        for key, value in filters.items():
            if hasattr(self.model, key):
                if value is not None:
                    query = query.where(getattr(self.model, key) == value)
        
        query = query.offset(skip).limit(limit)
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def update(self, id: int, **kwargs) -> Optional[ModelType]:
        """–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"""
        try:
            query = (
                update(self.model)
                .where(self.model.id == id)
                .values(**kwargs)
                .returning(self.model)
            )
            result = await self.db.execute(query)
            await self.db.commit()
            
            if result:
                return result.scalar_one()
            return None
        except SQLAlchemyError as e:
            await self.db.rollback()
            raise e
    
    async def delete(self, id: int) -> bool:
        """–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å"""
        try:
            query = delete(self.model).where(self.model.id == id)
            result = await self.db.execute(query)
            await self.db.commit()
            return result.rowcount > 0
        except SQLAlchemyError as e:
            await self.db.rollback()
            raise e
    
    async def count(self, **filters) -> int:
        """–ü–æ–¥—Å—á–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
        query = select(func.count()).select_from(self.model)
        
        for key, value in filters.items():
            if hasattr(self.model, key) and value is not None:
                query = query.where(getattr(self.model, key) == value)
        
        result = await self.db.execute(query)
        return result.scalar()
    
    async def exists(self, **filters) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏"""
        query = select(self.model).limit(1)
        
        for key, value in filters.items():
            if hasattr(self.model, key) and value is not None:
                query = query.where(getattr(self.model, key) == value)
        
        result = await self.db.execute(query)
        return result.first() is not None
```

#### **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–Ω–∏–≥:**
```python
# app/repositories/book_repository.py
from typing import List, Optional, Dict, Any
from sqlalchemy import select, and_, or_, func, desc, asc
from sqlalchemy.orm import selectinload, joinedload
from app.repositories.base import BaseRepository
from app.models.book import Book, BookStatus
from app.models.user import User
from app.models.author import Author

class BookRepository(BaseRepository[Book]):
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏"""
    
    def __init__(self, db):
        super().__init__(Book, db)
    
    async def get_with_details(self, book_id: int) -> Optional[Book]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥—É —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–∞–≤—Ç–æ—Ä—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)"""
        query = (
            select(Book)
            .options(
                selectinload(Book.authors),
                selectinload(Book.categories),
                selectinload(Book.owner),
                selectinload(Book.location),
            )
            .where(Book.id == book_id)
        )
        result = await self.db.execute(query)
        return result.scalar_one_or_none()
    
    async def search_books(
        self,
        search_query: Optional[str] = None,
        category_ids: Optional[List[int]] = None,
        author_ids: Optional[List[int]] = None,
        min_price: Optional[float] = None,
        max_price: Optional[float] = None,
        status: Optional[BookStatus] = None,
        only_available: bool = False,
        sort_by: str = "created_at",
        sort_order: str = "desc",
        skip: int = 0,
        limit: int = 100
    ) -> List[Book]:
        """–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π"""
        query = (
            select(Book)
            .options(
                selectinload(Book.authors).load_only(Author.id, Author.name),
                selectinload(Book.categories),
            )
        )
        
        # –ë–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è
        conditions = [Book.is_deleted == False]
        
        # –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        if search_query:
            search_conditions = [
                Book.title.ilike(f"%{search_query}%"),
                Book.description.ilike(f"%{search_query}%"),
                Book.isbn.ilike(f"%{search_query}%"),
            ]
            conditions.append(or_(*search_conditions))
        
        # –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        if category_ids:
            # –î–ª—è —Å–≤—è–∑–∏ –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º –Ω—É–∂–Ω–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å
            subquery = (
                select(Book.id)
                .join(book_categories)
                .where(book_categories.c.category_id.in_(category_ids))
            )
            conditions.append(Book.id.in_(subquery))
        
        # –§–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä–∞–º
        if author_ids:
            subquery = (
                select(Book.id)
                .join(book_authors)
                .where(book_authors.c.author_id.in_(author_ids))
            )
            conditions.append(Book.id.in_(subquery))
        
        # –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ
        if min_price is not None:
            conditions.append(Book.price >= min_price)
        if max_price is not None:
            conditions.append(Book.price <= max_price)
        
        # –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
        if status:
            conditions.append(Book.status == status)
        
        # –¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
        if only_available:
            conditions.extend([
                Book.available_copies > 0,
                Book.status == BookStatus.AVAILABLE
            ])
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ —É—Å–ª–æ–≤–∏—è
        query = query.where(and_(*conditions))
        
        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        sort_column = getattr(Book, sort_by, Book.created_at)
        if sort_order.lower() == "desc":
            query = query.order_by(desc(sort_column))
        else:
            query = query.order_by(asc(sort_column))
        
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        query = query.offset(skip).limit(limit)
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def get_popular_books(
        self, 
        limit: int = 10,
        days: int = 30
    ) -> List[Book]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π"""
        from app.models.order import Order, OrderType
        
        # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥
        subquery = (
            select(
                Order.book_id,
                func.count(Order.id).label('order_count')
            )
            .where(
                and_(
                    Order.order_type == OrderType.PURCHASE,
                    # –î–ª—è PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ–º func.now() - timedelta
                    # –î–ª—è MySQL –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å func.date_sub(func.now(), days)
                    Order.order_date >= func.now() - func.make_interval(days=days)
                )
            )
            .group_by(Order.book_id)
            .subquery()
        )
        
        query = (
            select(Book)
            .outerjoin(subquery, Book.id == subquery.c.book_id)
            .order_by(
                desc(func.coalesce(subquery.c.order_count, 0)),
                desc(Book.view_count)
            )
            .limit(limit)
        )
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def get_books_by_author(
        self, 
        author_id: int,
        only_available: bool = False
    ) -> List[Book]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–∞"""
        query = (
            select(Book)
            .join(book_authors)
            .where(book_authors.c.author_id == author_id)
        )
        
        if only_available:
            query = query.where(
                and_(
                    Book.available_copies > 0,
                    Book.status == BookStatus.AVAILABLE
                )
            )
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def update_book_status(
        self, 
        book_id: int, 
        status: BookStatus,
        changed_by: Optional[int] = None
    ) -> Optional[Book]:
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–Ω–∏–≥–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π"""
        book = await self.get(book_id)
        if not book:
            return None
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å
        old_status = book.status
        book.status = status
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        if hasattr(book, 'status_history'):
            history_entry = {
                "old_status": old_status,
                "new_status": status,
                "changed_at": datetime.now(timezone.utc).isoformat(),
                "changed_by": changed_by
            }
            
            if not book.status_history:
                book.status_history = []
            book.status_history.append(history_entry)
        
        await self.db.commit()
        await self.db.refresh(book)
        
        return book
    
    async def borrow_book(
        self, 
        book_id: int, 
        user_id: int,
        days: int = 14
    ) -> Optional[Book]:
        """–í–∑—è—Ç—å –∫–Ω–∏–≥—É –≤ –∞—Ä–µ–Ω–¥—É"""
        book = await self.get_with_details(book_id)
        if not book or not book.is_available:
            return None
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º SQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–∞–ø–∏—Å–∏
            async with self.db.begin():
                # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (SELECT FOR UPDATE)
                from sqlalchemy import select
                query = select(Book).where(Book.id == book_id).with_for_update()
                result = await self.db.execute(query)
                locked_book = result.scalar_one_or_none()
                
                if not locked_book or not locked_book.is_available:
                    raise ValueError("–ö–Ω–∏–≥–∞ —É–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
                
                # –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ø–∏–π
                locked_book.available_copies -= 1
                locked_book.borrow_count += 1
                
                if locked_book.available_copies == 0:
                    locked_book.status = BookStatus.BORROWED
                
                # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –∑–∞–∫–∞–∑–µ
                from app.models.order import Order, OrderType
                order = Order(
                    book_id=book_id,
                    user_id=user_id,
                    order_type=OrderType.RENTAL,
                    rental_start_date=datetime.now(timezone.utc),
                    rental_end_date=datetime.now(timezone.utc) + timedelta(days=days),
                    total_amount=locked_book.daily_rent_price * days
                )
                
                self.db.add(order)
                
                return locked_book
                
        except Exception as e:
            await self.db.rollback()
            raise e
```

### **2. –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (Business Logic)**

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω Service —Å–ª–æ–π:**
- –°–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–µ–∂–¥—É SQLAlchemy –∏ Pydantic –º–æ–¥–µ–ª—è–º–∏

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- Service –Ω–µ –∑–Ω–∞–µ—Ç –æ HTTP (–Ω–µ—Ç Request/Response)
- Service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- Service –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–æ–±—ä–µ–∫—Ç—ã, –Ω–µ HTTP –æ—Ç–≤–µ—Ç—ã

```python
# app/services/book_service.py
from typing import List, Optional, Dict, Any
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import HTTPException, status
from datetime import datetime, timedelta, timezone

from app.repositories.book_repository import BookRepository
from app.schemas.book import BookCreate, BookUpdate, BookResponse
from app.models.book import Book, BookStatus
from app.services.base import BaseService

class BookService(BaseService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.repository = BookRepository(db)
        super().__init__(db)
    
    async def create_book(
        self, 
        book_data: BookCreate,
        created_by: int
    ) -> BookResponse:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ISBN
        existing_book = await self.repository.get_by_isbn(book_data.isbn)
        if existing_book:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="–ö–Ω–∏–≥–∞ —Å —Ç–∞–∫–∏–º ISBN —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            )
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Pydantic –º–æ–¥–µ–ª–∏ ‚Üí SQLAlchemy –º–æ–¥–µ–ª—å
        db_book = await self.repository.create(
            **book_data.model_dump(),
            created_by=created_by,
            created_at=datetime.now(timezone.utc)
        )
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ SQLAlchemy –º–æ–¥–µ–ª—å ‚Üí Pydantic –º–æ–¥–µ–ª—å
        return BookResponse.model_validate(db_book)
    
    async def get_book(self, book_id: int) -> BookResponse:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥—É –ø–æ ID"""
        book = await self.repository.get_with_details(book_id)
        
        if not book:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"–ö–Ω–∏–≥–∞ —Å ID {book_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            )
        
        if book.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_410_GONE,
                detail="–ö–Ω–∏–≥–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞"
            )
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
        book.view_count += 1
        await self.db.commit()
        
        return BookResponse.model_validate(book)
    
    async def search_books(
        self,
        search_query: Optional[str] = None,
        categories: Optional[List[str]] = None,
        min_price: Optional[float] = None,
        max_price: Optional[float] = None,
        only_available: bool = False,
        page: int = 1,
        size: int = 20,
        sort_by: str = "created_at",
        sort_order: str = "desc"
    ) -> Dict[str, Any]:
        """–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
        skip = (page - 1) * size
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–Ω–∏–≥–∏
        books = await self.repository.search_books(
            search_query=search_query,
            category_ids=categories,
            min_price=min_price,
            max_price=max_price,
            only_available=only_available,
            sort_by=sort_by,
            sort_order=sort_order,
            skip=skip,
            limit=size
        )
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total = await self.repository.count(
            search_query=search_query,
            category_ids=categories,
            min_price=min_price,
            max_price=max_price,
            only_available=only_available
        )
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º SQLAlchemy –º–æ–¥–µ–ª–∏ –≤ Pydantic –º–æ–¥–µ–ª–∏
        book_responses = [
            BookResponse.model_validate(book) 
            for book in books
        ]
        
        return {
            "items": book_responses,
            "total": total,
            "page": page,
            "size": size,
            "pages": (total + size - 1) // size  # ceil division
        }
    
    async def update_book(
        self, 
        book_id: int, 
        book_data: BookUpdate,
        updated_by: int
    ) -> BookResponse:
        """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏
        existing_book = await self.repository.get(book_id)
        if not existing_book:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"–ö–Ω–∏–≥–∞ —Å ID {book_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            )
        
        if existing_book.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_410_GONE,
                detail="–ù–µ–ª—å–∑—è –æ–±–Ω–æ–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—É—é –∫–Ω–∏–≥—É"
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ISBN –µ—Å–ª–∏ –æ–Ω –º–µ–Ω—è–µ—Ç—Å—è
        if book_data.isbn and book_data.isbn != existing_book.isbn:
            book_with_isbn = await self.repository.get_by_isbn(book_data.isbn)
            if book_with_isbn:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail="–ö–Ω–∏–≥–∞ —Å —Ç–∞–∫–∏–º ISBN —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–∏–≥—É
        updated_book = await self.repository.update(
            book_id,
            **book_data.model_dump(exclude_unset=True),
            updated_by=updated_by,
            updated_at=datetime.now(timezone.utc)
        )
        
        if not updated_book:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–∏–≥—É"
            )
        
        return BookResponse.model_validate(updated_book)
    
    async def delete_book(self, book_id: int, deleted_by: int) -> bool:
        """–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∏"""
        book = await self.repository.get(book_id)
        if not book:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"–ö–Ω–∏–≥–∞ —Å ID {book_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            )
        
        if book.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="–ö–Ω–∏–≥–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞"
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã –Ω–∞ —ç—Ç—É –∫–Ω–∏–≥—É
        from app.repositories.order_repository import OrderRepository
        order_repo = OrderRepository(self.db)
        
        active_orders = await order_repo.get_active_orders_for_book(book_id)
        if active_orders:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏"
            )
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
        await self.repository.update(
            book_id,
            is_deleted=True,
            deleted_at=datetime.now(timezone.utc),
            deleted_by=deleted_by
        )
        
        return True
    
    async def borrow_book(
        self, 
        book_id: int, 
        user_id: int,
        days: int = 14
    ) -> Dict[str, Any]:
        """–í–∑—è—Ç—å –∫–Ω–∏–≥—É –≤ –∞—Ä–µ–Ω–¥—É"""
        book = await self.repository.borrow_book(book_id, user_id, days)
        
        if not book:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="–ö–Ω–∏–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã"
            )
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑
        from app.repositories.order_repository import OrderRepository
        order_repo = OrderRepository(self.db)
        
        latest_order = await order_repo.get_latest_order_for_book_and_user(
            book_id, user_id
        )
        
        return {
            "book": BookResponse.model_validate(book),
            "order": latest_order,
            "message": f"–ö–Ω–∏–≥–∞ '{book.title}' —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ {days} –¥–Ω–µ–π"
        }
    
    async def get_book_statistics(self, book_id: int) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–Ω–∏–≥–µ"""
        book = await self.repository.get_with_details(book_id)
        if not book:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"–ö–Ω–∏–≥–∞ —Å ID {book_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            )
        
        from app.repositories.order_repository import OrderRepository
        order_repo = OrderRepository(self.db)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–∫–∞–∑–æ–≤
        order_stats = await order_repo.get_book_order_statistics(book_id)
        
        return {
            "book": BookResponse.model_validate(book),
            "statistics": {
                "total_orders": order_stats.get("total", 0),
                "purchases": order_stats.get("purchases", 0),
                "rentals": order_stats.get("rentals", 0),
                "average_rating": book.average_rating,
                "view_count": book.view_count,
                "borrow_count": book.borrow_count,
                "availability_ratio": book.borrow_ratio,
                "available_copies": book.available_copies,
                "total_copies": book.total_copies,
            },
            "popularity_score": self._calculate_popularity_score(book)
        }
    
    def _calculate_popularity_score(self, book: Book) -> float:
        """–†–∞—Å—á–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∫–Ω–∏–≥–∏"""
        # –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
        score = (
            book.view_count * 0.3 +
            book.borrow_count * 0.5 +
            book.average_rating * 20 * 0.2
        )
        return round(score, 2)
```

### **3. RESTful API endpoints**

**–°–≤—è–∑—å —Å–ª–æ–µ–≤:**
```
HTTP Request ‚Üí Endpoint ‚Üí Service ‚Üí Repository ‚Üí Database
                ‚Üì           ‚Üì         ‚Üì
            HTTPException  Business   SQL
                          Logic      Queries
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- Endpoints —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã
- –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ Service
- –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –≤ Repository
- Endpoints –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç HTTP ‚Üî Pydantic –º–æ–¥–µ–ª–∏

```python
# app/api/v1/endpoints/books.py
from fastapi import APIRouter, Depends, HTTPException, status, Query
from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.deps import get_db, get_current_user
from app.schemas.book import BookCreate, BookUpdate, BookResponse, BookSearchResult
from app.services.book_service import BookService
from app.models.user import UserRole

router = APIRouter(prefix="/books", tags=["books"])

@router.get("/", response_model=BookSearchResult)
async def get_books(
    q: Optional[str] = Query(None, description="–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å"),
    category: Optional[List[str]] = Query(None, description="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"),
    min_price: Optional[float] = Query(None, ge=0, description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞"),
    max_price: Optional[float] = Query(None, ge=0, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞"),
    only_available: bool = Query(False, description="–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ"),
    page: int = Query(1, ge=1, description="–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã"),
    size: int = Query(20, ge=1, le=100, description="–†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã"),
    sort_by: str = Query("created_at", description="–ü–æ–ª–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"),
    sort_order: str = Query("desc", regex="^(asc|desc)$"),
    db: AsyncSession = Depends(get_db),
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    book_service = BookService(db)
    
    result = await book_service.search_books(
        search_query=q,
        categories=category,
        min_price=min_price,
        max_price=max_price,
        only_available=only_available,
        page=page,
        size=size,
        sort_by=sort_by,
        sort_order=sort_order
    )
    
    return result

@router.get("/{book_id}", response_model=BookResponse)
async def get_book(
    book_id: int,
    db: AsyncSession = Depends(get_db),
):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ"""
    book_service = BookService(db)
    return await book_service.get_book(book_id)

@router.post("/", response_model=BookResponse, status_code=status.HTTP_201_CREATED)
async def create_book(
    book_data: BookCreate,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user),
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π –∏ –∞–¥–º–∏–Ω–æ–≤)"""
    if current_user["role"] not in [UserRole.ADMIN, UserRole.LIBRARIAN]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏"
        )
    
    book_service = BookService(db)
    return await book_service.create_book(book_data, current_user["id"])

@router.put("/{book_id}", response_model=BookResponse)
async def update_book(
    book_id: int,
    book_data: BookUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user),
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π –∏ –∞–¥–º–∏–Ω–æ–≤)"""
    if current_user["role"] not in [UserRole.ADMIN, UserRole.LIBRARIAN]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏"
        )
    
    book_service = BookService(db)
    return await book_service.update_book(book_id, book_data, current_user["id"])

@router.delete("/{book_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_book(
    book_id: int,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user),
):
    """–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    if current_user["role"] != UserRole.ADMIN:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –∫–Ω–∏–≥–∏"
        )
    
    book_service = BookService(db)
    success = await book_service.delete_book(book_id, current_user["id"])
    
    if not success:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É"
        )
    
    return None

@router.post("/{book_id}/borrow", status_code=status.HTTP_200_OK)
async def borrow_book(
    book_id: int,
    days: int = Query(14, ge=1, le=60, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã"),
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user),
):
    """–í–∑—è—Ç—å –∫–Ω–∏–≥—É –≤ –∞—Ä–µ–Ω–¥—É"""
    book_service = BookService(db)
    return await book_service.borrow_book(book_id, current_user["id"], days)

@router.get("/{book_id}/statistics")
async def get_book_statistics(
    book_id: int,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user),
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–Ω–∏–≥–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π –∏ –∞–¥–º–∏–Ω–æ–≤)"""
    if current_user["role"] not in [UserRole.ADMIN, UserRole.LIBRARIAN]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
        )
    
    book_service = BookService(db)
    return await book_service.get_book_statistics(book_id)

@router.get("/popular/", response_model=List[BookResponse])
async def get_popular_books(
    limit: int = Query(10, ge=1, le=50, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥"),
    days: int = Query(30, ge=1, le=365, description="–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π"),
    db: AsyncSession = Depends(get_db),
):
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏"""
    book_service = BookService(db)
    books = await book_service.repository.get_popular_books(limit, days)
    return [BookResponse.model_validate(book) for book in books]
```

### **4. –†–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**

**–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:**
- –ù–∞–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω–æ–µ —Ü–µ–ª–æ–µ
- –õ–∏–±–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω—ã, –ª–∏–±–æ –≤—Å–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

**ACID —Å–≤–æ–π—Å—Ç–≤–∞:**
- **Atomicity** (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å) ‚Äî –≤—Å–µ –∏–ª–∏ –Ω–∏—á–µ–≥–æ
- **Consistency** (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å) ‚Äî –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤ –≤–∞–ª–∏–¥–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- **Isolation** (–ò–∑–æ–ª—è—Ü–∏—è) ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É
- **Durability** (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å) ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤)
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥, —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –û–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

```python
# app/core/database.py (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
from contextlib import asynccontextmanager
from typing import AsyncGenerator
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker

class DatabaseManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏"""
    
    def __init__(self, session_factory: async_sessionmaker):
        self.session_factory = session_factory
    
    @asynccontextmanager
    async def transaction(self) -> AsyncGenerator[AsyncSession, None]:
        """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
        async with self.session_factory() as session:
            try:
                yield session
                await session.commit()
            except Exception:
                await session.rollback()
                raise
    
    async def in_transaction(self, func, *args, **kwargs):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
        async with self.transaction() as session:
            return await func(session, *args, **kwargs)
    
    @asynccontextmanager
    async def nested_transaction(self, session: AsyncSession):
        """–í–ª–æ–∂–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (savepoint)"""
        async with session.begin_nested():
            try:
                yield
            except Exception:
                await session.rollback()
                raise

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å–µ
class OrderService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db_manager = db_manager
    
    async def create_complex_order(self, order_data: dict):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏"""
        
        async def create_order_transaction(session: AsyncSession):
            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
            from sqlalchemy import select
            for item in order_data["items"]:
                query = select(Book).where(Book.id == item["book_id"])
                result = await session.execute(query)
                book = result.scalar_one_or_none()
                if not book or book.available_copies < item["quantity"]:
                    raise HTTPException(400, f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–ø–∏–π –∫–Ω–∏–≥–∏ {item['book_id']}")
            
            # 2. –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
            order = Order(user_id=order_data["user_id"])
            session.add(order)
            await session.flush()  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞
            
            # 3. –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
            from sqlalchemy import select
            total_amount = 0
            for item in order_data["items"]:
                # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (SELECT FOR UPDATE)
                query = select(Book).where(Book.id == item["book_id"]).with_for_update()
                result = await session.execute(query)
                book = result.scalar_one_or_none()
                
                if not book:
                    raise HTTPException(400, f"–ö–Ω–∏–≥–∞ {item['book_id']} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                
                book.available_copies -= item["quantity"]
                
                # –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞
                order_item = OrderItem(
                    order_id=order.id,
                    book_id=item["book_id"],
                    quantity=item["quantity"],
                    price=book.price
                )
                session.add(order_item)
                
                total_amount += book.price * item["quantity"]
            
            # 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
            order.total_amount = total_amount
            
            # 5. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ
            payment = Payment(
                order_id=order.id,
                amount=total_amount,
                status="pending"
            )
            session.add(payment)
            
            # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã—à–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            # –ï—Å–ª–∏ –ª—é–±–∞—è –∏–∑ –Ω–∏—Ö —É–ø–∞–¥–µ—Ç, –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—è—Ç—Å—è
            
            # 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
            # –í–∞–∂–Ω–æ: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
            # —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–∞—Ö
            await session.commit()
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞
            await send_order_notification(order.id)
            
            return order
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å—é –ª–æ–≥–∏–∫—É –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        return await self.db_manager.in_transaction(create_order_transaction)
```

---

## **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é 7:**

### **–ß–∞—Å—Ç—å 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π**

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL:**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker
   - –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö `library_db`
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ `.env` —Ñ–∞–π–ª–µ

2. **–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω—É—é –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ä–æ–ª–∏: —á–∏—Ç–∞—Ç–µ–ª—å, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
   - –ö–Ω–∏–≥–∏ (—Å –∞–≤—Ç–æ—Ä–∞–º–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏, –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏)
   - –ê–≤—Ç–æ—Ä—ã (–±–∏–æ–≥—Ä–∞—Ñ–∏—è, —Ñ–æ—Ç–æ, —Å—Å—ã–ª–∫–∏)
   - –ó–∞–∫–∞–∑—ã (–ø–æ–∫—É–ø–∫–∏ –∏ –∞—Ä–µ–Ω–¥–∞)
   - –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏
   - –®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É

3. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–≤—è–∑–∏:**
   - –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ó–∞–∫–∞–∑—ã
   - –ú–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º: –ö–Ω–∏–≥–∏ ‚Üî –ê–≤—Ç–æ—Ä—ã, –ö–Ω–∏–≥–∏ ‚Üî –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
   - –û–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ü—Ä–æ—Ñ–∏–ª—å

### **–ß–∞—Å—Ç—å 2: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã**

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π:**
   - –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
   - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –º–µ—Ç–æ–¥–∞–º–∏:
     - `BookRepository.get_books_by_author()`
     - `OrderRepository.get_user_orders()`
     - `UserRepository.search_users()`

2. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π:**
   - `BookService` —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –¥–ª—è –∫–Ω–∏–≥
   - `OrderService` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–∫–∞–∑–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
   - `UserService` —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

3. **–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
   - –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ —Å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–∏—Å–∫–æ–º
   - –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å JOIN –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏

### **–ß–∞—Å—Ç—å 3: REST API endpoints**

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ CRUD endpoints –¥–ª—è:**
   - –ö–Ω–∏–≥ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π, –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è)
   - –ó–∞–∫–∞–∑–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞, –∏—Å—Ç–æ—Ä–∏—è)

2. **–î–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ endpoints:**
   - `POST /books/{id}/borrow` - –≤–∑—è—Ç—å –∫–Ω–∏–≥—É –≤ –∞—Ä–µ–Ω–¥—É
   - `POST /books/{id}/return` - –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É
   - `GET /users/{id}/statistics` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `GET /reports/sales` - –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º

3. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
   - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–∞
   - –í–æ–∑–≤—Ä–∞—Ç –∫–Ω–∏–≥–∏ —Å —Ä–∞—Å—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–∞
   - –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### **–ß–∞—Å—Ç—å 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –∏–Ω–¥–µ–∫—Å—ã**

1. **–î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è:**
   - –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞
   - –°–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `selectinload()` –≤–º–µ—Å—Ç–æ `joinedload()` –≥–¥–µ –Ω—É–∂–Ω–æ
   - –î–æ–±–∞–≤—å—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü

### **–ë–æ–Ω—É—Å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:**

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å Alembic:**
   - –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
   - –î–æ–±–∞–≤—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

2. **–î–æ–±–∞–≤—å—Ç–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é:**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ master-slave —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ —á—Ç–µ–Ω–∏–µ –∏–∑ —Ä–µ–ø–ª–∏–∫, –∑–∞–ø–∏—Å—å –≤ –º–∞—Å—Ç–µ—Ä

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   - –î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

---

## **–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –Ω–µ–¥–µ–ª–∏ 7:**

1. **SQLAlchemy 2.0 + async** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –≤ FastAPI
   - –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ async/await
   - –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –õ—É—á—à–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

2. **–ú–æ–¥–µ–ª–∏ SQLAlchemy** –æ–ø–∏—Å—ã–≤–∞—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î, **Pydantic –º–æ–¥–µ–ª–∏** ‚Äî –¥–∞–Ω–Ω—ã–µ API
   - SQLAlchemy –º–æ–¥–µ–ª–∏ (`app/models/`) ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î
   - Pydantic –º–æ–¥–µ–ª–∏ (`app/schemas/`) ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è API

3. **Repository Pattern** –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ë–î, **Service Pattern** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
   - Repository ‚Äî –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î
   - Service ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è

4. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
   - ACID —Å–≤–æ–π—Å—Ç–≤–∞
   - –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –ò–∑–æ–ª—è—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

5. **–ò–Ω–¥–µ–∫—Å—ã** –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –£—Å–∫–æ—Ä—è—é—Ç –ø–æ–∏—Å–∫
   - –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤

6. **–û—Ç–Ω–æ—à–µ–Ω–∏—è** (relationships) —É–ø—Ä–æ—â–∞—é—Ç —Ä–∞–±–æ—Ç—É —Å–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   - –û–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º, –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º
   - –õ–µ–Ω–∏–≤–∞—è –∏ –∂–∞–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

7. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
   - –ù–µ –±–ª–æ–∫–∏—Ä—É—é—Ç event loop
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**–ü—Ä–∞–≤–∏–ª–∞ —Ö–æ—Ä–æ—à–µ–≥–æ —Ç–æ–Ω–∞:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã (`async with`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ë–î –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –†–∞–∑–¥–µ–ª—è–π—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã –ë–î
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ timezone-aware datetime (`datetime.now(timezone.utc)`)
- –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å–µ—Å—Å–∏–∏ –≤ finally –±–ª–æ–∫–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π