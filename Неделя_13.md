# **–ù–µ–¥–µ–ª—è 13: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã - –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, —Ñ–∞–π–ª—ã, CORS, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

## **üìë –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ**

1. [–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å](#—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è-—á–∞—Å—Ç—å)
   - [1. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ FastAPI](#1-—Ñ–æ–Ω–æ–≤—ã–µ-–∑–∞–¥–∞—á–∏-–≤-fastapi)
   - [2. –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏](#2-—Ä–∞–±–æ—Ç–∞-—Å-—Ñ–∞–π–ª–∞–º–∏)
   - [3. CORS (Cross-Origin Resource Sharing)](#3-cors-cross-origin-resource-sharing)
   - [4. –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#4-–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
2. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è-—á–∞—Å—Ç—å)
   - [1. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (Background Tasks)](#1-—Ñ–æ–Ω–æ–≤—ã–µ-–∑–∞–¥–∞—á–∏-background-tasks)
   - [2. –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏](#2-—Ä–∞–±–æ—Ç–∞-—Å-—Ñ–∞–π–ª–∞–º–∏-1)
   - [3. CORS (Cross-Origin Resource Sharing)](#3-cors-cross-origin-resource-sharing-1)
   - [4. –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#4-–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-1)
3. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é 13](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ-–∑–∞–¥–∞–Ω–∏–µ-–Ω–∞-–Ω–µ–¥–µ–ª—é-13)
4. [–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏](#–∫—Ä–∏—Ç–µ—Ä–∏–∏-–æ—Ü–µ–Ω–∫–∏)
5. [–ò—Ç–æ–≥ –Ω–µ–¥–µ–ª–∏ 13](#–∏—Ç–æ–≥-–Ω–µ–¥–µ–ª–∏-13)

---

## **üìö –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**

### **1. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ FastAPI**

#### **–ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏?**

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –≥–¥–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º –≥–æ—Ç–æ–≤–∏—Ç—å –µ–¥—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –ü–æ–∫–∞ –æ–Ω –≥–æ—Ç–æ–≤–∏—Ç, –¥—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –∂–¥—É—Ç, –∞ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π. –í —Ö–æ—Ä–æ—à–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑ –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –µ–≥–æ –Ω–∞ –∫—É—Ö–Ω—é, –≥–¥–µ –ø–æ–≤–∞—Ä–∞ –≥–æ—Ç–æ–≤—è—Ç –±–ª—é–¥–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –û—Ñ–∏—Ü–∏–∞–Ω—Ç —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞, –∞ –µ–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–∑–∂–µ.

**–í –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö:** API endpoint - —ç—Ç–æ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç, –∞ –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ email, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤) - —ç—Ç–æ –≥–æ—Ç–æ–≤–∫–∞. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ - —ç—Ç–æ "–∫—É—Ö–Ω—è", –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É.

#### **–ü—Ä–æ–±–ª–µ–º–∞: –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç API**

**–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:** –ö–æ–≥–¥–∞ endpoint –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ email, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤), –∫–ª–∏–µ–Ω—Ç –≤—ã–Ω—É–∂–¥–µ–Ω –∂–¥–∞—Ç—å –∏—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- **–ü–ª–æ—Ö–æ–º—É UX (–¥–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞)** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–∑–∞–≥—Ä—É–∑–∫—É" –≤–º–µ—Å—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- **–¢–∞–π–º–∞—É—Ç–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤** - –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã (–æ–±—ã—á–Ω–æ 30-60 —Å–µ–∫—É–Ω–¥)
- **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã** - –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ –æ–¥–∏–Ω –¥–æ–ª–≥–∏–π –∑–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
- **–ü—Ä–æ–±–ª–µ–º–∞–º —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º** - —Å–µ—Ä–≤–µ—Ä –Ω–µ –º–æ–∂–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã, —Ç–∞–∫ –∫–∞–∫ –∑–∞–Ω—è—Ç –æ–∂–∏–¥–∞–Ω–∏–µ–º

```python
# –ü–†–û–ë–õ–ï–ú–ê: –î–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
@app.post("/send-email/")
async def send_email_report():
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (10 —Å–µ–∫—É–Ω–¥)
    report_data = await generate_report()  # ‚è≥ 10 —Å–µ–∫—É–Ω–¥!
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ email (5 —Å–µ–∫—É–Ω–¥)
    await send_email(report_data)  # ‚è≥ 5 —Å–µ–∫—É–Ω–¥!
    
    return {"message": "–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"}  # üö´ –ö–ª–∏–µ–Ω—Ç –∂–¥–∞–ª 15 —Å–µ–∫—É–Ω–¥!
    # –ü—Ä–æ–±–ª–µ–º–∞: –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
    # –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç - –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É
    # –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (Background Tasks) FastAPI. –û–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.

```python
# –†–ï–®–ï–ù–ò–ï: –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
from fastapi import BackgroundTasks

@app.post("/send-email/")
async def send_email_report(background_tasks: BackgroundTasks):
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω
    # –ó–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
    background_tasks.add_task(send_email_async, user_id=123)
    
    return {"message": "–û—Ç—á–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ñ–æ–Ω–µ"}  # ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç!
    # –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
    # - –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É
    # - –î–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ
    # - –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç - –∫–ª–∏–µ–Ω—Ç —É–∂–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç
```

**–í–∞–∂–Ω–æ:** Background Tasks FastAPI –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç–æ–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–µ, —á—Ç–æ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –î–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (Celery, RQ, ARQ).

#### **–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á:**

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** - –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Redis, RabbitMQ)
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –∑–∞–¥–∞—á–∏ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
4. **–û–¥–Ω–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤:**

| –ü–æ–¥—Ö–æ–¥ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|--------|-----------|------------|------------------|---------------|
| **FastAPI BackgroundTasks** | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è | –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏, –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã |
| **Celery + Redis/RabbitMQ** | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | Production, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ |
| **ARQ (Redis)** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ Redis |
| **RQ (Redis)** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –ü—Ä–æ—Å—Ç—ã–µ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ Redis |

#### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏:**
- ‚úÖ **–û—Ç–ø—Ä–∞–≤–∫–∞ email/SMS** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–≤–∏–¥–µ–æ** - –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∂–µ
- ‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤/PDF** - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–∏–Ω—É—Ç—ã
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API** - –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –º–æ–≥—É—Ç –æ—Ç–≤–µ—á–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

#### **–ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚ùå **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞, –Ω—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ—á–µ—Ä–µ–¥–∏)
- ‚ùå **–û–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - BackgroundTasks —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- ‚ùå **–¶–µ–ø–æ—á–∫–∏ –∑–∞–≤–∏—Å–∏–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** - —Å–ª–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
- ‚ùå **–í—ã—á–∏—Å–ª–µ–Ω–∏—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–µ–Ω —Å—Ä–∞–∑—É** - –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∂–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ–º–æ–∂–µ—Ç

### **2. –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏**

#### **–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏?**

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ö—Ä–∞–Ω–∏—Ç –∫–Ω–∏–≥–∏, –Ω–æ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –∫–æ–ø–∏—è–º–∏, –æ–±–ª–æ–∂–∫–∞–º–∏, —Å–∫–∞–Ω–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü. –ù—É–∂–Ω–æ —É–º–µ—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏ (–∑–∞–≥—Ä—É–∑–∫–∞), –≤—ã–¥–∞–≤–∞—Ç—å –∏—Ö —á–∏—Ç–∞—Ç–µ–ª—è–º (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ), —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è), –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä).

**–í –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç –∞–≤–∞—Ç–∞—Ä—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ –æ—Ç–¥–∞–≤–∞—Ç—å —ç—Ç–∏ —Ñ–∞–π–ª—ã.

#### **–¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤** - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ HTTP multipart/form-data
2. **–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ HTTP response (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–ª–∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ)
3. **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤** - –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ, –≤ –æ–±–ª–∞–∫–µ, –≤ –ë–î)
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤** - –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä

#### **–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏:**

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞, —Ä–∞–∑–º–µ—Ä–∞, —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `aiofiles` –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/–¥–∞—Ç–∞–º
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - —Å–∂–∞—Ç–∏–µ, –º–∏–Ω–∏–∞—Ç—é—Ä—ã, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

#### **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**

| –°–ø–æ—Å–æ–± | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ | –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|--------|-------------|------------|--------------|
| **–õ–æ–∫–∞–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** | –ü—Ä–æ—Å—Ç–æ—Ç–∞, —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞, –Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä), –±—ç–∫–∞–ø—ã (–Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å), —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è | –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã |
| **–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3, Yandex Object Storage)** | –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è, CDN –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –°—Ç–æ–∏–º–æ—Å—Ç—å (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ + —Ç—Ä–∞—Ñ–∏–∫), —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ—Å—Ç—É–ø–∞ | Production, –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã, –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (BLOB)** | –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ—Ç–∞ –±—ç–∫–∞–ø–æ–≤ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ë–î –Ω–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤), —Ä–∞–∑–º–µ—Ä –ë–î, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π | –ú–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã (<1MB), –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| **CDN** | –°–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ | –°—Ç–æ–∏–º–æ—Å—Ç—å, –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã, –º–µ–¥–∏–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç |

#### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–∞–º–∏:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞** - –∑–∞—â–∏—Ç–∞ –æ—Ç DoS –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã
3. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤–∏—Ä—É—Å—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
4. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–º–µ–Ω–∞** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ path traversal –∞—Ç–∞–∫
5. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞** - –∫–æ–Ω—Ç—Ä–æ–ª—å, –∫—Ç–æ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å/—Å–∫–∞—á–∏–≤–∞—Ç—å —Ñ–∞–π–ª—ã
6. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### **3. CORS (Cross-Origin Resource Sharing)**

#### **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω CORS?**

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å –ø—Ä–∞–≤–∏–ª–æ–º "—Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç–µ–ª–∏ —Å —á–∏—Ç–∞—Ç–µ–ª—å—Å–∫–∏–º –±–∏–ª–µ—Ç–æ–º –º–æ–≥—É—Ç –±—Ä–∞—Ç—å –∫–Ω–∏–≥–∏". –ù–æ —á—Ç–æ –µ—Å–ª–∏ —á–∏—Ç–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤–∑—è—Ç—å –∫–Ω–∏–≥—É –∏–∑ –¥—Ä—É–≥–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏? –ù—É–∂–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (CORS) –æ—Ç —Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç–µ–ª—å –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥—É.

**–í –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö:** –ë—Ä–∞—É–∑–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏ (origin'–∞–º–∏) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. CORS - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å–µ—Ä–≤–µ—Ä—É —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.

#### **–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Same-Origin Policy:**

**Same-Origin Policy (SOP)** - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ origin'–∞–º–∏. Origin –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:
- **–ü—Ä–æ—Ç–æ–∫–æ–ª** (http/https)
- **–î–æ–º–µ–Ω** (localhost:3000 vs localhost:8000)
- **–ü–æ—Ä—Ç** (3000 vs 8000)

**–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–∑–Ω—ã—Ö origin'–æ–≤:**
```
http://localhost:3000  ‚â†  http://localhost:8000  (—Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã)
https://example.com    ‚â†  http://example.com      (—Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã)
https://api.example.com ‚â† https://app.example.com (—Ä–∞–∑–Ω—ã–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã)
```

```
–ë—Ä–∞—É–∑–µ—Ä: http://localhost:3000 ‚Üí API: http://localhost:8000
         ‚Üë                           ‚Üë
    –†–∞–∑–Ω—ã–µ origin               –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤!
    
–ü—Ä–æ–±–ª–µ–º–∞: –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ origin'–∞–º–∏
–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS –∏ CSRF –∞—Ç–∞–∫.
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?** –ë–µ–∑ SOP –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ `evil.com` –º–æ–≥ –±—ã –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–∞—à–µ–º—É API –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ. SOP –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–∫–∏–µ –∞—Ç–∞–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** CORS (Cross-Origin Resource Sharing) - –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å–µ—Ä–≤–µ—Ä—É —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å –¥—Ä—É–≥–∏—Ö origin'–æ–≤ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏. –°–µ—Ä–≤–µ—Ä —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫–æ–º—É –¥–æ–≤–µ—Ä—è—Ç—å.

#### **CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏:**

**Preflight –∑–∞–ø—Ä–æ—Å (OPTIONS):** –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è "—Å–ª–æ–∂–Ω—ã—Ö" –∑–∞–ø—Ä–æ—Å–æ–≤ (POST —Å JSON, PUT, DELETE, –∑–∞–ø—Ä–æ—Å—ã —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏).

```http
# –ó–∞–ø—Ä–æ—Å —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π (preflight)
OPTIONS /api/endpoint HTTP/1.1
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Content-Type

# –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
HTTP/1.1 204 No Content
Access-Control-Allow-Origin: http://localhost:3000  # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π origin
Access-Control-Allow-Methods: GET, POST, PUT, DELETE  # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
Access-Control-Allow-Headers: Content-Type, Authorization  # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
Access-Control-Max-Age: 86400  # –í—Ä–µ–º—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è preflight –æ—Ç–≤–µ—Ç–∞ (24 —á–∞—Å–∞)
Access-Control-Allow-Credentials: true  # –†–∞–∑—Ä–µ—à–∏—Ç—å cookies –∏ authorization headers
```

**–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- `Access-Control-Allow-Origin: *` - —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å–µ origin'—ã, –Ω–æ **–ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç** —Å `Access-Control-Allow-Credentials: true` (–∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- –î–ª—è credentials –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π origin** (–Ω–µ `*`)
- Preflight –∑–∞–ø—Ä–æ—Å—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–∞ –≤—Ä–µ–º—è, —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤ `Access-Control-Max-Age` (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- **–ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã** (GET, POST —Å form-data) –Ω–µ —Ç—Ä–µ–±—É—é—Ç preflight
- **–°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** (PUT, DELETE, POST —Å JSON, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏) —Ç—Ä–µ–±—É—é—Ç preflight

#### **–ü—Ä–∏–Ω—Ü–∏–ø—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS:**

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏** - —Ä–∞–∑—Ä–µ—à–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ origin'—ã, –º–µ—Ç–æ–¥—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å credentials** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `allow_credentials=True` —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –∏ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ origin'—ã
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ preflight** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ `max_age` –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ preflight –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–†–∞–∑–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π** - –≤ development –º–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ, –≤ production - —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–æ–º–µ–Ω—ã

### **4. –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

#### **–ó–∞—á–µ–º –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ?**

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–∏—Ç –¥–æ–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏. –û–Ω –Ω–µ –∑–Ω–∞–µ—Ç, –≤—ã–¥–µ—Ä–∂–∞—Ç –ª–∏ —Å—Ç–µ–Ω—ã –Ω–∞–≥—Ä—É–∑–∫—É, –Ω–µ –ø—Ä–æ—Ç–µ—á–µ—Ç –ª–∏ –∫—Ä—ã—à–∞, –Ω–µ –∑–∞–∫–ª–∏–Ω–∏—Ç –ª–∏ –¥–≤–µ—Ä—å. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–¥–∞—á–µ–π –æ–±—ä–µ–∫—Ç–∞.

**–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:** –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º. –≠—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

#### **–ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

–ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤. –û—Å–Ω–æ–≤–∞–Ω–∏–µ —à–∏—Ä–æ–∫–æ–µ (–º–Ω–æ–≥–æ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤), –≤–µ—Ä—à–∏–Ω–∞ —É–∑–∫–∞—è (–º–∞–ª–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤).

```
       üèîÔ∏è  E2E —Ç–µ—Å—Ç—ã (10%) - –º–µ–¥–ª–µ–Ω–Ω—ã–µ, –¥–æ—Ä–æ–≥–∏–µ, –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–ª–Ω—ã–π flow
      üèîÔ∏èüèîÔ∏è  –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (20%) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    üèîÔ∏èüèîÔ∏èüèîÔ∏è  Unit —Ç–µ—Å—Ç—ã (70%) - –±—ã—Å—Ç—Ä—ã–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
```

**Unit —Ç–µ—Å—Ç—ã (70%):**
- **–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç:** –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏/–º–µ—Ç–æ–¥—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- **–°–∫–æ—Ä–æ—Å—Ç—å:** –ë—ã—Å—Ç—Ä—ã–µ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏ –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **–ü—Ä–∏–º–µ—Ä:** –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è, –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ë—ã—Å—Ç—Ä—ã–µ, –¥–µ—à–µ–≤—ã–µ, –ª–µ–≥–∫–æ –ø–∏—Å–∞—Ç—å, –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥—è—Ç –±–∞–≥–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (20%):**
- **–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç:** –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (API + –ë–î, —Å–µ—Ä–≤–∏—Å + —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
- **–°–∫–æ—Ä–æ—Å—Ç—å:** –ú–µ–¥–ª–µ–Ω–Ω–µ–µ unit —Ç–µ—Å—Ç–æ–≤ (—Å–µ–∫—É–Ω–¥—ã)
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—É—é –ë–î (–Ω–æ —Ç–µ—Å—Ç–æ–≤—É—é), —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- **–ü—Ä–∏–º–µ—Ä:** –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API, —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –Ω–∞—Ö–æ–¥—è—Ç –ø—Ä–æ–±–ª–µ–º—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**E2E —Ç–µ—Å—Ç—ã (10%):**
- **–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç:** –ü–æ–ª–Ω—ã–π flow –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞
- **–°–∫–æ—Ä–æ—Å—Ç—å:** –°–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ (–º–∏–Ω—É—Ç—ã)
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ –∏—Ö –∏–º–∏—Ç–∞—Ü–∏—é
- **–ü—Ä–∏–º–µ—Ä:** –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç, –Ω–∞—Ö–æ–¥—è—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏

**–ü–æ—á–µ–º—É —Ç–∞–∫–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è?** 
- **Unit —Ç–µ—Å—Ç—ã** –Ω–∞—Ö–æ–¥—è—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –±–∞–≥–æ–≤ (70-80%), –æ–Ω–∏ –±—ã—Å—Ç—Ä—ã–µ –∏ –¥–µ—à–µ–≤—ã–µ
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –Ω–∞—Ö–æ–¥—è—Ç –ø—Ä–æ–±–ª–µ–º—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **E2E —Ç–µ—Å—Ç—ã** –¥–æ—Ä–æ–≥–∏–µ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å

#### **–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ö–æ—Ä–æ—à–∏—Ö —Ç–µ—Å—Ç–æ–≤:**

1. **F.I.R.S.T. –ø—Ä–∏–Ω—Ü–∏–ø:**
   - **F**ast - –±—ã—Å—Ç—Ä—ã–µ (unit —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∑–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
   - **I**solated - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö)
   - **R**epeatable - –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ)
   - **S**elf-validating - —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ (—Ç–µ—Å—Ç —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
   - **T**imely - —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ (—Ç–µ—Å—Ç—ã –ø–∏—à—É—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–æ–¥–æ–º, –Ω–µ –ø–æ—Å–ª–µ)

2. **AAA (Arrange-Act-Assert):**
   ```python
   def test_user_creation():
       # Arrange - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
       # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –º–æ–∫–∏, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
       user_data = {"username": "test", "email": "test@example.com"}
       
       # Act - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
       # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é/–º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ—Å—Ç–∏—Ä—É–µ–º
       result = create_user(user_data)
       
       # Assert - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
       # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º
       assert result.username == "test"
       assert result.email == "test@example.com"
   ```
   
   **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ AAA:**
   - **–ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞** - –≤—Å–µ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
   - **–õ–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è** - –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ —ç—Ç–∞–ø—ã
   - **–õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏, –≥–¥–µ –æ—à–∏–±–∫–∞** - –µ—Å–ª–∏ —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç, —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ (Arrange, Act –∏–ª–∏ Assert)
   - **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è** - –≤—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ, –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

#### **–¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤ –≤ FastAPI:**

1. **Unit —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Å–µ—Ä–≤–∏—Å—ã, —É—Ç–∏–ª–∏—Ç—ã
2. **API —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä—É—é—Ç endpoints —á–µ—Ä–µ–∑ `TestClient` –∏–ª–∏ `httpx.AsyncClient`
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä—É—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ë–î, –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
4. **E2E —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä—É—é—Ç –ø–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

- **pytest** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **pytest-asyncio** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ async —Ç–µ—Å—Ç–æ–≤
- **TestClient** (FastAPI) - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
- **httpx.AsyncClient** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
- **unittest.mock** - –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **pytest-cov** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏

---

## **üîß –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**

### **1. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (Background Tasks)**

#### **–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Å FastAPI BackgroundTasks:**

FastAPI –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ `BackgroundTasks`. –≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤.

```python
# app/core/background_tasks.py
import asyncio
import logging
from typing import Dict, Any, Optional
from datetime import datetime, timezone
import aiofiles
import json
from pathlib import Path

logger = logging.getLogger(__name__)

# ===== –ü–†–û–°–¢–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –§–û–ù–û–í–´–• –ó–ê–î–ê–ß =====

async def send_email_task(
    to_email: str,
    subject: str,
    template_name: str,
    context: Dict[str, Any]
):
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email
    
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.
    –û–Ω–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
    
    Args:
        to_email: Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        subject: –¢–µ–º–∞ –ø–∏—Å—å–º–∞
        template_name: –ò–º—è —à–∞–±–ª–æ–Ω–∞ email (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
        context: –°–ª–æ–≤–∞—Ä—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —à–∞–±–ª–æ–Ω
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
        - –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ aiosmtplib –∏–ª–∏ fastapi-mail –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–∂–Ω–∞: –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–ø–∞–¥–µ—Ç, –∫–ª–∏–µ–Ω—Ç —É–∂–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç
        - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á
    """
    logger.info(f"Sending email to {to_email}: {subject}")
    
    try:
        # –ß—Ç–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ email –∏–∑ —Ñ–∞–π–ª–∞
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º aiofiles –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        template_path = Path(f"templates/emails/{template_name}.html")
        async with aiofiles.open(template_path, "r", encoding="utf-8") as f:
            template_content = await f.read()
        
        # –ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —à–∞–±–ª–æ–Ω–µ
        # –®–∞–±–ª–æ–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å {{ user_name }}, {{ current_date }} –∏ —Ç.–¥.
        for key, value in context.items():
            template_content = template_content.replace(f"{{{{ {key} }}}}", str(value))
        
        # –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ aiosmtplib –∏–ª–∏ fastapi-mail –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ - –∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∑–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã)
        await asyncio.sleep(2)
        logger.info(f"Email sent to {to_email}")
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
        # –í production –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î –∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        log_entry = {
            "to": to_email,
            "subject": subject,
            "sent_at": datetime.now(timezone.utc).isoformat(),  # UTC –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
            "status": "sent"
        }
        
        log_path = Path("logs/email_logs.json")
        log_path.parent.mkdir(exist_ok=True)  # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        async with aiofiles.open(log_path, "a", encoding="utf-8") as f:
            await f.write(json.dumps(log_entry) + "\n")
            
    except Exception as e:
        # –í–∞–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏, —Ç–∞–∫ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç
        # –∏ –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á–∞ —É–ø–∞–ª–∞
        logger.error(f"Failed to send email to {to_email}: {e}", exc_info=True)

async def generate_report_task(
    user_id: int,
    report_type: str,
    date_from: datetime,
    date_to: datetime
):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ–Ω–µ
    
    –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª–≥–æ (—Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –º–∏–Ω—É—Ç—ã),
    –ø–æ—ç—Ç–æ–º—É –µ—ë –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ —Ñ–æ–Ω–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å API.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç—á–µ—Ç
        report_type: –¢–∏–ø –æ—Ç—á–µ—Ç–∞ (daily, weekly, monthly)
        date_from: –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞ –æ—Ç—á–µ—Ç–∞
        date_to: –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞ –æ—Ç—á–µ—Ç–∞
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
        - –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        - –û—Ç—á–µ—Ç—ã –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î –∏–ª–∏ —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
        - –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥–æ—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ email –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    """
    logger.info(f"Generating {report_type} report for user {user_id}")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –¥–æ–ª–≥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç:
    # 1. –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (SELECT —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –¥–∞—Ç–∞–º)
    # 2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (COUNT, SUM, AVG –∏ —Ç.–¥.)
    # 3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ (JSON, CSV, PDF, Excel)
    await asyncio.sleep(5)
    
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞
    report_data = {
        "user_id": user_id,
        "report_type": report_type,
        "period": {
            "from": date_from.isoformat(),  # ISO —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
            "to": date_to.isoformat()
        },
        "generated_at": datetime.now(timezone.utc).isoformat(),  # UTC –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        "statistics": {
            "books_borrowed": 15,
            "books_returned": 12,
            "overdue_books": 3,
            "total_fees": 1500.50
        }
    }
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º timestamp –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    report_filename = f"reports/{user_id}_{report_type}_{datetime.now(timezone.utc).timestamp()}.json"
    Path("reports").mkdir(exist_ok=True)  # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    async with aiofiles.open(report_filename, "w", encoding="utf-8") as f:
        await f.write(json.dumps(report_data, indent=2))  # –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSON
    
    logger.info(f"Report generated: {report_filename}")

async def cleanup_old_files_task(days_old: int = 30):
    """–û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤"""
    logger.info(f"Cleaning up files older than {days_old} days")
    
    from datetime import timedelta
    cutoff_date = datetime.now(timezone.utc) - timedelta(days=days_old)
    
    temp_dir = Path("temp")
    if temp_dir.exists():
        for file_path in temp_dir.glob("**/*"):
            if file_path.is_file():
                # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞
                # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: fromtimestamp –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è,
                # –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å timezone.utc –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å cutoff_date
                mtime = datetime.fromtimestamp(file_path.stat().st_mtime, tz=timezone.utc)
                if mtime < cutoff_date:
                    file_path.unlink()
                    logger.info(f"Deleted temp file: {file_path}")
    
    logger.info("Cleanup completed")
```

#### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ FastAPI endpoints:**

```python
# app/api/v1/endpoints/background_tasks.py
import logging
from fastapi import APIRouter, BackgroundTasks, Depends, HTTPException, status
from typing import Optional
from datetime import datetime, timedelta, timezone

from app.api.deps import get_current_active_user
from app.core.background_tasks import (
    send_email_task,
    generate_report_task,
    cleanup_old_files_task
)

router = APIRouter(prefix="/background-tasks", tags=["background-tasks"])
logger = logging.getLogger(__name__)

@router.post("/send-email")
async def schedule_email(
    to_email: str,
    subject: str,
    template_name: str,
    background_tasks: BackgroundTasks,
    current_user: dict = Depends(get_current_active_user)
):
    """
    –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ email –≤ —Ñ–æ–Ω–µ
    
    –≠—Ç–æ—Ç endpoint —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É, –∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ email
    –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞.
    
    Args:
        to_email: Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        subject: –¢–µ–º–∞ –ø–∏—Å—å–º–∞
        template_name: –ò–º—è —à–∞–±–ª–æ–Ω–∞ email
        background_tasks: FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∂–µ–∫—Ç–∏—Ç BackgroundTasks
        current_user: –¢–µ–∫—É—â–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
    
    Returns:
        JSON —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
        - –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏ email
        - –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ email —É–ø–∞–¥–µ—Ç, –∫–ª–∏–µ–Ω—Ç —É–∂–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç
        - –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å TaskTracker
    """
    # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email (–≤ production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Pydantic EmailStr)
    if "@" not in to_email:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email"
        )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω
    # –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
    # FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ background_tasks –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ response
    background_tasks.add_task(
        send_email_task,
        to_email=to_email,
        subject=subject,
        template_name=template_name,
        context={
            "user_name": current_user["username"],
            "current_date": datetime.now(timezone.utc).strftime("%d.%m.%Y")  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
        }
    )
    
    # –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏ email
    return {
        "success": True,
        "message": "Email –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ"
    }

@router.post("/generate-report")
async def generate_user_report(
    report_type: str,
    date_from: Optional[datetime] = None,
    date_to: Optional[datetime] = None,
    background_tasks: BackgroundTasks = BackgroundTasks(),
    current_user: dict = Depends(get_current_active_user)
):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ–Ω–µ"""
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if not date_from:
        date_from = datetime.now(timezone.utc) - timedelta(days=30)
    if not date_to:
        date_to = datetime.now(timezone.utc)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω
    background_tasks.add_task(
        generate_report_task,
        user_id=current_user["id"],
        report_type=report_type,
        date_from=date_from,
        date_to=date_to
    )
    
    return {
        "success": True,
        "message": "–û—Ç—á–µ—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ–Ω–µ",
        "report_type": report_type,
        "period": {
            "from": date_from.isoformat(),
            "to": date_to.isoformat()
        }
    }

@router.post("/cleanup")
async def schedule_cleanup(
    days_old: int = 30,
    background_tasks: BackgroundTasks = BackgroundTasks(),
    current_user: dict = Depends(get_current_active_user)
):
    """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
    background_tasks.add_task(
        cleanup_old_files_task,
        days_old=days_old
    )
    
    return {
        "success": True,
        "message": "–û—á–∏—Å—Ç–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞",
        "days_old": days_old
    }
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- –ú–∏–Ω–∏–º—É–º –∫–æ–¥–∞
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å FastAPI
- –ù–µ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–¥–∞—á
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞
- –ó–∞–¥–∞—á–∏ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

#### **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç–∞—Ç—É—Å–æ–≤:

```python
# app/core/task_tracker.py (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
import uuid
from typing import Dict
from datetime import datetime, timezone
import logging

logger = logging.getLogger(__name__)

class TaskTracker:
    """
    –ü—Ä–æ—Å—Ç–æ–π —Ç—Ä–µ–∫–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á
    
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:
    - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
    - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ó–∞–¥–∞—á–∏ –≤—Å–µ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ FastAPI BackgroundTasks.
    –≠—Ç–æ—Ç –∫–ª–∞—Å—Å —Ç–æ–ª—å–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Ö —Å—Ç–∞—Ç—É—Å.
    """
    
    def __init__(self):
        self.tasks: Dict[str, dict] = {}
    
    def create_task(self, task_type: str) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç –µ—ë ID"""
        task_id = f"{task_type}_{uuid.uuid4().hex[:8]}"
        self.tasks[task_id] = {
            "type": task_type,
            "status": "pending",
            "created_at": datetime.now(timezone.utc),
            "completed_at": None,
            "error": None
        }
        logger.info(f"Task created: {task_id} ({task_type})")
        return task_id
    
    def mark_completed(self, task_id: str):
        """–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é"""
        if task_id in self.tasks:
            self.tasks[task_id]["status"] = "completed"
            self.tasks[task_id]["completed_at"] = datetime.now(timezone.utc)
            logger.info(f"Task completed: {task_id}")
    
    def mark_failed(self, task_id: str, error: str):
        """–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—É—é"""
        if task_id in self.tasks:
            self.tasks[task_id]["status"] = "failed"
            self.tasks[task_id]["error"] = error
            self.tasks[task_id]["completed_at"] = datetime.now(timezone.utc)
            logger.error(f"Task failed: {task_id} - {error}")
    
    def get_status(self, task_id: str) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏"""
        return self.tasks.get(task_id)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—Ä–µ–∫–µ—Ä–∞
task_tracker = TaskTracker()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞:
# app/api/v1/endpoints/background_tasks.py (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
from fastapi import APIRouter, BackgroundTasks, Depends, HTTPException, status
from datetime import datetime, timezone
from app.api.deps import get_current_active_user
from app.core.background_tasks import send_email_task
from app.core.task_tracker import task_tracker

router = APIRouter(prefix="/background-tasks", tags=["background-tasks"])

@router.post("/send-email-with-tracking")
async def schedule_email_with_tracking(
    to_email: str,
    subject: str,
    template_name: str,
    background_tasks: BackgroundTasks,
    current_user: dict = Depends(get_current_active_user)
):
    """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞"""
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ç—Ä–µ–∫–µ—Ä–µ
    task_id = task_tracker.create_task("send_email")
    
    # –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    async def tracked_send_email():
        try:
            await send_email_task(
                to_email=to_email,
                subject=subject,
                template_name=template_name,
                context={
                    "user_name": current_user["username"],
                    "current_date": datetime.now(timezone.utc).strftime("%d.%m.%Y")
                }
            )
            task_tracker.mark_completed(task_id)
        except Exception as e:
            task_tracker.mark_failed(task_id, str(e))
            raise
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω
    background_tasks.add_task(tracked_send_email)
    
    return {
        "success": True,
        "message": "Email –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ",
        "task_id": task_id
    }

@router.get("/status/{task_id}")
async def get_task_status(task_id: str):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
    task_data = task_tracker.get_status(task_id)
    
    if not task_data:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"–ó–∞–¥–∞—á–∞ {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        )
    
    return {
        "task_id": task_id,
        "status": task_data["status"],
        "type": task_data["type"],
        "created_at": task_data["created_at"].isoformat(),
        "completed_at": task_data["completed_at"].isoformat() if task_data["completed_at"] else None,
        "error": task_data.get("error")
    }
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:**
- –ù—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á
- –ù—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ù—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞:**
- –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ email, –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤)
- –ù–µ –Ω—É–∂–µ–Ω —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ

**–î–ª—è production:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –æ—á–µ—Ä–µ–¥–µ–π:
- **Celery** - –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
- **ARQ** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –Ω–∞ Redis
- **RQ** - –ø—Ä–æ—Å—Ç–∞—è –æ—á–µ—Ä–µ–¥—å –Ω–∞ Redis

---

### **2. –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏**

#### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —É—Ç–∏–ª–∏—Ç—ã:**

```python
# app/core/file_storage.py
import shutil
import hashlib
import mimetypes
import logging
from pathlib import Path
from typing import Optional, Tuple, BinaryIO, Dict, Any
from fastapi import UploadFile, HTTPException
import aiofiles
import aiofiles.os
from PIL import Image
import io

logger = logging.getLogger(__name__)

class FileStorage:
    """
    –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è.
    –í production —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ:
    - AWS S3 / Yandex Object Storage –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
    - CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    - –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    """
    
    def __init__(self, base_path: str = "uploads"):
        self.base_path = Path(base_path)
        self.base_path.mkdir(parents=True, exist_ok=True)
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
        self.directories = {
            "images": self.base_path / "images",
            "documents": self.base_path / "documents",
            "avatars": self.base_path / "avatars",
            "reports": self.base_path / "reports",
            "temp": self.base_path / "temp"
        }
        
        for directory in self.directories.values():
            directory.mkdir(exist_ok=True)
    
    def get_file_path(self, category: str, filename: str) -> Path:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É"""
        if category not in self.directories:
            raise ValueError(f"Unknown category: {category}")
        
        return self.directories[category] / filename
    
    async def save_upload_file(
        self,
        upload_file: UploadFile,
        category: str,
        max_size_mb: int = 10,
        allowed_extensions: Optional[list] = None
    ) -> Dict[str, Any]:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        content = await upload_file.read()
        file_size = len(content)
        
        if file_size > max_size_mb * 1024 * 1024:
            raise HTTPException(
                status_code=400,
                detail=f"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_size_mb}MB"
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        original_filename = upload_file.filename
        file_extension = Path(original_filename).suffix.lower()
        
        if allowed_extensions and file_extension not in allowed_extensions:
            raise HTTPException(
                status_code=400,
                detail=f"–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: {', '.join(allowed_extensions)}"
            )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º MD5 —Ö–µ—à —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
        # (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∏–º—è)
        file_hash = hashlib.md5(content).hexdigest()[:16]
        safe_filename = f"{file_hash}{file_extension}"
        
        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UUID –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        # from uuid import uuid4
        # safe_filename = f"{uuid4().hex}{file_extension}"
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ MIME —Ç–∏–ø–∞
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: MIME —Ç–∏–ø –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
        mime_type = upload_file.content_type or mimetypes.guess_type(original_filename)[0]
        
        if not category:
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ MIME —Ç–∏–ø—É
            if mime_type and mime_type.startswith("image/"):
                category = "images"
            elif mime_type and ("pdf" in mime_type or "document" in mime_type):
                category = "documents"
            else:
                category = "documents"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        file_path = self.get_file_path(category, safe_filename)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ñ–∞–π–ª
        # –ë–ª–∞–≥–æ–¥–∞—Ä—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∏–º—è
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å –º–µ—Å—Ç–æ –∏ –∏–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        if await aiofiles.os.path.exists(file_path):
            # –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º
            logger.info(f"File already exists, reusing: {file_path}")
            return await self.get_file_info(file_path, original_filename)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        async with aiofiles.open(file_path, "wb") as f:
            await f.write(content)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞
        file_info = await self.get_file_info(file_path, original_filename)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä)
        if category == "images":
            await self.process_image(file_path, content)
        
        logger.info(f"File saved: {file_path} ({file_size} bytes)")
        
        return file_info
    
    async def get_file_info(self, file_path: Path, original_filename: str) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ"""
        stat = await aiofiles.os.stat(file_path)
        
        return {
            "filename": original_filename,
            "stored_filename": file_path.name,
            "path": str(file_path),
            "size": stat.st_size,
            "created_at": stat.st_ctime,
            "modified_at": stat.st_mtime,
            "mime_type": mimetypes.guess_type(file_path)[0] or "application/octet-stream",
            "url": f"/api/files/{file_path.relative_to(self.base_path)}"
        }
    
    async def process_image(self, file_path: Path, image_content: bytes):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä)
        
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Pillow —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º
        run_in_executor –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
        """
        try:
            # –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            # –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ run_in_executor –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:
            # loop = asyncio.get_event_loop()
            # image = await loop.run_in_executor(None, Image.open, io.BytesIO(image_content))
            image = Image.open(io.BytesIO(image_content))
            
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            original_width, original_height = image.size
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
            thumbnail_sizes = [
                (100, 100),   # –ú–∞–ª–µ–Ω—å–∫–∞—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞
                (300, 300),   # –°—Ä–µ–¥–Ω—è—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞
                (600, 600),   # –ë–æ–ª—å—à–∞—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞
            ]
            
            for width, height in thumbnail_sizes:
                # –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                thumbnail = image.copy()
                thumbnail.thumbnail((width, height), Image.Resampling.LANCZOS)
                
                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                thumbnail_path = file_path.parent / "thumbnails" / f"{width}x{height}_{file_path.name}"
                thumbnail_path.parent.mkdir(exist_ok=True)
                
                # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ WebP –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                if file_path.suffix.lower() != '.webp':
                    thumbnail_path = thumbnail_path.with_suffix('.webp')
                
                thumbnail.save(thumbnail_path, "WEBP", quality=85)
                logger.info(f"Thumbnail created: {thumbnail_path}")
            
            # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if file_path.suffix.lower() in ['.jpg', '.jpeg']:
                image.save(file_path, "JPEG", optimize=True, quality=85)
            elif file_path.suffix.lower() == '.png':
                image.save(file_path, "PNG", optimize=True)
            
        except Exception as e:
            logger.error(f"Image processing error: {e}")
            # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ —É–¥–∞–ª–∞—Å—å
    
    async def delete_file(self, file_path: str) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞"""
        path = Path(file_path)
        
        if not await aiofiles.os.path.exists(path):
            return False
        
        try:
            await aiofiles.os.remove(path)
            
            # –£–¥–∞–ª–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä (–µ—Å–ª–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
            if path.parent.name == "images":
                thumbnails_dir = path.parent / "thumbnails"
                if await aiofiles.os.path.exists(thumbnails_dir):
                    for thumbnail in thumbnails_dir.glob(f"*_{path.name}"):
                        await aiofiles.os.remove(thumbnail)
            
            logger.info(f"File deleted: {path}")
            return True
            
        except Exception as e:
            logger.error(f"File deletion error: {e}")
            return False
    
    async def get_file(self, file_path: str) -> Optional[Tuple[bytes, str]]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"""
        path = Path(file_path)
        
        if not await aiofiles.os.path.exists(path):
            return None
        
        async with aiofiles.open(path, "rb") as f:
            content = await f.read()
        
        mime_type = mimetypes.guess_type(path)[0] or "application/octet-stream"
        
        return content, mime_type

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
file_storage = FileStorage()

# –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
from typing import List
import logging

logger = logging.getLogger(__name__)

class FileUploadValidator:
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤"""
    
    @staticmethod
    async def validate_image_file(
        file: UploadFile,
        max_size_mb: int = 5,
        allowed_formats: List[str] = [".jpg", ".jpeg", ".png", ".gif", ".webp"]
    ):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í FastAPI UploadFile - —ç—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç,
        –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ —á—Ç–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME —Ç–∏–ø–∞
        if file.content_type not in ["image/jpeg", "image/png", "image/gif", "image/webp"]:
            raise HTTPException(400, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        if not file.filename:
            raise HTTPException(400, "–ò–º—è —Ñ–∞–π–ª–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
            
        filename = file.filename.lower()
        if not any(filename.endswith(ext) for ext in allowed_formats):
            raise HTTPException(400, f"–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ: {', '.join(allowed_formats)}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (—á–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)
        content = await file.read()
        file_size = len(content)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª–æ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        await file.seek(0)
        
        if file_size > max_size_mb * 1024 * 1024:
            raise HTTPException(400, f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º: {max_size_mb}MB")
        
        return file
    
    @staticmethod
    async def validate_pdf_file(file: UploadFile, max_size_mb: int = 10):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è PDF —Ñ–∞–π–ª–æ–≤"""
        if file.content_type != "application/pdf":
            raise HTTPException(400, "–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF")
        
        if not file.filename:
            raise HTTPException(400, "–ò–º—è —Ñ–∞–π–ª–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
            
        filename = file.filename.lower()
        if not filename.endswith(".pdf"):
            raise HTTPException(400, "–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .pdf")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        content = await file.read()
        file_size = len(content)
        await file.seek(0)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª–æ
        
        if file_size > max_size_mb * 1024 * 1024:
            raise HTTPException(400, f"PDF —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_size_mb}MB")
        
        return file
```

#### **Endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏:**
```python
# app/api/v1/endpoints/files.py
import os
import logging
from fastapi import (
    APIRouter, UploadFile, File, Form, 
    HTTPException, status, Response, Depends
)
from fastapi.responses import FileResponse, StreamingResponse
from typing import List, Optional
from pathlib import Path
import io

from app.api.deps import get_current_active_user, require_librarian
from app.core.file_storage import file_storage, FileUploadValidator
from app.schemas.file import FileInfo, FileUploadResponse

router = APIRouter(prefix="/files", tags=["files"])
logger = logging.getLogger(__name__)

@router.post("/upload", response_model=FileUploadResponse)
async def upload_file(
    file: UploadFile = File(...),
    category: str = Form("documents"),
    description: Optional[str] = Form(None),
    current_user: dict = Depends(get_current_active_user)
):
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞"""
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        file_info = await file_storage.save_upload_file(
            upload_file=file,
            category=category,
            max_size_mb=50,
            allowed_extensions=[".jpg", ".jpeg", ".png", ".pdf", ".doc", ".docx", ".txt"]
        )
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ –≤ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        # await save_file_to_db(file_info, current_user["id"], description)
        
        return FileUploadResponse(
            success=True,
            message="–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω",
            file=file_info,
            download_url=file_info["url"]
        )
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"File upload error: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª"
        )

@router.post("/upload/image")
async def upload_image(
    file: UploadFile = File(...),
    current_user: dict = Depends(get_current_active_user)
):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π"""
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (async –º–µ—Ç–æ–¥)
        validated_file = await FileUploadValidator.validate_image_file(
            file, max_size_mb=10
        )
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        file_info = await file_storage.save_upload_file(
            upload_file=validated_file,
            category="images",
            max_size_mb=10,
            allowed_extensions=[".jpg", ".jpeg", ".png", ".webp", ".gif"]
        )
        
        return {
            "success": True,
            "message": "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ",
            "file": file_info,
            "thumbnails": [
                f"{file_info['url']}?size=100x100",
                f"{file_info['url']}?size=300x300",
                f"{file_info['url']}?size=600x600"
            ]
        }
        
    except Exception as e:
        logger.error(f"Image upload error: {e}")
        raise

@router.post("/upload/multiple")
async def upload_multiple_files(
    files: List[UploadFile] = File(...),
    category: str = Form("documents"),
    current_user: dict = Depends(get_current_active_user)
):
    """–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤"""
    results = []
    
    for file in files:
        try:
            file_info = await file_storage.save_upload_file(
                upload_file=file,
                category=category,
                max_size_mb=50
            )
            results.append({
                "filename": file.filename,
                "success": True,
                "file_info": file_info
            })
        except Exception as e:
            results.append({
                "filename": file.filename,
                "success": False,
                "error": str(e)
            })
    
    successful = [r for r in results if r["success"]]
    failed = [r for r in results if not r["success"]]
    
    return {
        "total": len(files),
        "successful": len(successful),
        "failed": len(failed),
        "results": results
    }

@router.get("/download/{filepath:path}")
async def download_file(
    filepath: str,
    size: Optional[str] = None,
    as_attachment: bool = True
):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞"""
    try:
        # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞
        file_path = Path("uploads") / filepath
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if size and "images" in filepath:
            # –ü–∞—Ä—Å–∏–º —Ä–∞–∑–º–µ—Ä
            if "x" in size:
                width, height = map(int, size.split("x"))
                thumbnail_path = (
                    file_path.parent / "thumbnails" / 
                    f"{width}x{height}_{file_path.name}"
                )
                
                # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ webp, –º–µ–Ω—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                if thumbnail_path.suffix.lower() != '.webp':
                    thumbnail_path = thumbnail_path.with_suffix('.webp')
                
                if thumbnail_path.exists():
                    file_path = thumbnail_path
        
        if not file_path.exists():
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
            )
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME —Ç–∏–ø–∞
        import mimetypes
        mime_type, _ = mimetypes.guess_type(str(file_path))
        
        # –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π WebP
        if file_path.suffix.lower() == '.webp':
            mime_type = 'image/webp'
        
        # –í–æ–∑–≤—Ä–∞—Ç —Ñ–∞–π–ª–∞
        if as_attachment:
            return FileResponse(
                path=file_path,
                filename=file_path.name,
                media_type=mime_type
            )
        else:
            # –î–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
            return FileResponse(
                path=file_path,
                media_type=mime_type
            )
            
    except Exception as e:
        logger.error(f"File download error: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"
        )

@router.get("/image/{filepath:path}")
async def get_image(
    filepath: str,
    width: Optional[int] = None,
    height: Optional[int] = None,
    quality: int = 85,
    format: str = "webp"
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ—Å–∞–π–∑–∞"""
    try:
        file_path = Path("uploads") / filepath
        
        if not file_path.exists():
            raise HTTPException(404, "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–∑–º–µ—Ä—ã - —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –Ω–∞ –ª–µ—Ç—É
        if width or height:
            from PIL import Image
            import io
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            with Image.open(file_path) as img:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                original_width, original_height = img.size
                
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                if width and height:
                    new_width, new_height = width, height
                elif width:
                    ratio = width / original_width
                    new_width = width
                    new_height = int(original_height * ratio)
                elif height:
                    ratio = height / original_height
                    new_height = height
                    new_width = int(original_width * ratio)
                else:
                    new_width, new_height = original_width, original_height
                
                # –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä
                img = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                output = io.BytesIO()
                
                if format.lower() == "webp":
                    img.save(output, format="WEBP", quality=quality)
                    media_type = "image/webp"
                elif format.lower() == "jpeg":
                    img.save(output, format="JPEG", quality=quality)
                    media_type = "image/jpeg"
                elif format.lower() == "png":
                    img.save(output, format="PNG", optimize=True)
                    media_type = "image/png"
                else:
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                    return FileResponse(file_path)
                
                output.seek(0)
                
                return Response(
                    content=output.getvalue(),
                    media_type=media_type,
                    headers={
                        "Cache-Control": "public, max-age=86400",  # –ö—ç—à –Ω–∞ 1 –¥–µ–Ω—å
                        "Content-Disposition": f"inline; filename=\"resized_{file_path.name}\""
                    }
                )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        return FileResponse(file_path)
        
    except Exception as e:
        logger.error(f"Image processing error: {e}")
        raise HTTPException(500, "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")

@router.delete("/{filepath:path}")
async def delete_file(
    filepath: str,
    current_user: dict = Depends(require_librarian)
):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π)"""
    try:
        file_path = Path("uploads") / filepath
        
        if not await file_storage.delete_file(str(file_path)):
            raise HTTPException(404, "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        return {
            "success": True,
            "message": "–§–∞–π–ª —É–¥–∞–ª–µ–Ω"
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"File deletion error: {e}")
        raise HTTPException(500, "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª")

@router.get("/list/{category}")
async def list_files(
    category: str,
    page: int = 1,
    per_page: int = 20,
    current_user: dict = Depends(require_librarian)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–π)"""
    try:
        if category not in file_storage.directories:
            raise HTTPException(400, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è")
        
        directory = file_storage.directories[category]
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        files = []
        skip = (page - 1) * per_page
        
        for i, file_path in enumerate(directory.glob("*")):
            if file_path.is_file():
                if i >= skip and len(files) < per_page:
                    stat = file_path.stat()
                    files.append({
                        "name": file_path.name,
                        "size": stat.st_size,
                        "created": stat.st_ctime,
                        "modified": stat.st_mtime,
                        "url": f"/api/files/download/{category}/{file_path.name}"
                    })
        
        total_files = sum(1 for _ in directory.glob("*") if _.is_file())
        
        return {
            "category": category,
            "page": page,
            "per_page": per_page,
            "total_files": total_files,
            "total_pages": (total_files + per_page - 1) // per_page,
            "files": files
        }
        
    except Exception as e:
        logger.error(f"File listing error: {e}")
        raise HTTPException(500, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤")
```

### **3. CORS (Cross-Origin Resource Sharing)**

```python
# app/core/cors.py
from fastapi.middleware.cors import CORSMiddleware
from fastapi import Response
from typing import List, Union
from app.core.config import settings

def setup_cors(app):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS middleware"""
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö origins –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    origins = settings.BACKEND_CORS_ORIGINS
    
    if not origins:
        # –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ origins
        if settings.DEBUG:
            origins = ["*"]
        else:
            origins = []
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if isinstance(origins, str):
        if origins == "*":
            origins = ["*"]
        else:
            origins = [origin.strip() for origin in origins.split(",")]
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
        expose_headers=[
            "Content-Range",
            "X-Content-Range",
            "X-Total-Count",
            "X-Request-ID",
            "X-Process-Time"
        ],
        max_age=600,  # 10 –º–∏–Ω—É—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è preflight –∑–∞–ø—Ä–æ—Å–æ–≤
    )
    
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: CORSMiddleware —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç preflight –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏
    
    # –í production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ CORSMiddleware
    # –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ middleware –¥–ª—è CORS

# app/api/v1/endpoints/cors_test.py
from fastapi import APIRouter, Response
from typing import Optional

router = APIRouter(prefix="/cors-test", tags=["cors-test"])

@router.get("/")
async def cors_test_endpoint(
    origin: Optional[str] = None
):
    """Endpoint –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è CORS"""
    return {
        "message": "CORS —Ç–µ—Å—Ç–æ–≤—ã–π endpoint",
        "headers_received": {
            "origin": origin
        },
        "cors_info": {
            "allowed_methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
            "allowed_headers": ["Authorization", "Content-Type"],
            "allow_credentials": True
        }
    }

@router.post("/with-credentials")
async def cors_with_credentials(
    data: dict
):
    """Endpoint —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π credentials (cookies, authorization headers)"""
    return {
        "message": "–ó–∞–ø—Ä–æ—Å —Å credentials —É—Å–ø–µ—à–µ–Ω",
        "received_data": data,
        "credentials_supported": True
    }

@router.put("/custom-headers")
async def cors_custom_headers():
    """Endpoint —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏"""
    response = Response(
        content='{"message": "–ö–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏"}',
        media_type="application/json"
    )
    
    # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤ CORS
    response.headers["X-Custom-Header"] = "Custom Value"
    response.headers["X-Total-Count"] = "100"
    response.headers["X-Process-Time"] = "0.123"
    
    return response
```

### **4. –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```python
# tests/conftest.py
import asyncio
import pytest
import pytest_asyncio
from typing import AsyncGenerator, Generator
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from fastapi.testclient import TestClient

from app.main import app
from app.core.database import Base, get_db
from app.core.config import Settings
import os

# –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
test_settings = Settings(
    DATABASE_URL="sqlite+aiosqlite:///./test.db",
    SECRET_KEY="test-secret-key",
    DEBUG=True
)

# –¢–µ—Å—Ç–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –ë–î
test_engine = create_async_engine(
    test_settings.DATABASE_URL,
    echo=False,
)

# –¢–µ—Å—Ç–æ–≤–∞—è —Å–µ—Å—Å–∏—è
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–µ–º async_sessionmaker –¥–ª—è SQLAlchemy 2.0
from sqlalchemy.ext.asyncio import async_sessionmaker

TestAsyncSession = async_sessionmaker(
    test_engine,
    class_=AsyncSession,
    expire_on_commit=False,
)

# –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
@pytest_asyncio.fixture(scope="function")
async def test_db() -> AsyncGenerator[AsyncSession, None]:
    """
    –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ –ë–î
    
    –≠—Ç–∞ —Ñ–∏–∫—Å—Ç—É—Ä–∞:
    1. –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
    2. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –ë–î –¥–ª—è —Ç–µ—Å—Ç–∞
    3. –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    4. –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
    
    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
        - scope="function" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ñ–∏–∫—Å—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
        - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é —Ç–µ—Å—Ç–æ–≤ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    """
    # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
    async with TestAsyncSession() as session:
        try:
            yield session  # –¢–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É —Å–µ—Å—Å–∏—é
            await session.commit()  # –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
        except Exception:
            await session.rollback()  # –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            raise
        finally:
            await session.close()
    
    # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ - —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)

# –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ get_db
@pytest_asyncio.fixture(scope="function")
async def override_get_db(test_db: AsyncSession):
    """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ get_db –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    async def _override_get_db():
        yield test_db
    
    app.dependency_overrides[get_db] = _override_get_db
    yield
    app.dependency_overrides.clear()

# –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: TestClient —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ FastAPI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç async endpoints
# –î–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é async —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ httpx.AsyncClient
@pytest.fixture(scope="function")
def test_client(override_get_db):
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
    with TestClient(app) as client:
        yield client

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é async —Ç–µ—Å—Ç–æ–≤:
# @pytest_asyncio.fixture
# async def async_client():
#     async with httpx.AsyncClient(app=app, base_url="http://test") as client:
#         yield client

# –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@pytest_asyncio.fixture(scope="function")
async def authenticated_client(test_client: TestClient, test_db: AsyncSession):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    from app.services.auth_service import AuthService
    from app.schemas.auth import UserRegister
    
    auth_service = AuthService(test_db)
    
    user_data = UserRegister(
        email="test@example.com",
        username="testuser",
        password="TestPass123!",
        password_confirm="TestPass123!",
        full_name="Test User"
    )
    
    user = await auth_service.register(user_data)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    from app.schemas.auth import UserLogin
    login_data = UserLogin(
        username="testuser",
        password="TestPass123!"
    )
    
    _, tokens = await auth_service.login(
        login_data,
        user_agent="pytest",
        ip_address="127.0.0.1"
    )
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    test_client.headers.update({
        "Authorization": f"Bearer {tokens.access_token}"
    })
    
    return test_client, user, tokens

# –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
@pytest_asyncio.fixture(scope="function")
async def test_data(test_db: AsyncSession):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    from app.models.user import User, UserRole
    from app.models.book import Book, Author
    from datetime import datetime
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞
    author = Author(
        name="Test Author",
        biography="Test biography",
        country="Testland"
    )
    test_db.add(author)
    await test_db.commit()
    await test_db.refresh(author)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–Ω–∏–≥
    books = []
    for i in range(5):
        book = Book(
            title=f"Test Book {i+1}",
            isbn=f"978-0-00-00000-{i}",
            description=f"Test description {i+1}",
            publication_year=2020 + i,
            publisher="Test Publisher",
            price=1000.0 + (i * 100),
            total_copies=10,
            available_copies=10 - i,
            author_id=author.id
        )
        test_db.add(book)
        books.append(book)
    
    await test_db.commit()
    
    for book in books:
        await test_db.refresh(book)
    
    return {
        "author": author,
        "books": books
    }
```

#### **Unit —Ç–µ—Å—Ç—ã:**
```python
# tests/unit/test_security.py
import pytest
from datetime import datetime, timedelta
from app.core.security import (
    verify_password,
    get_password_hash,
    create_access_token,
    verify_token
)

def test_password_hashing():
    """–¢–µ—Å—Ç —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è"""
    password = "MySecurePassword123!"
    
    # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    hashed = get_password_hash(password)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞
    assert verify_password(password, hashed) == True
    assert verify_password("WrongPassword", hashed) == False

def test_jwt_token_creation():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ JWT —Ç–æ–∫–µ–Ω–∞"""
    user_id = 123
    additional_claims = {"role": "admin", "email": "test@example.com"}
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    token = create_access_token(
        subject=user_id,
        expires_delta=timedelta(minutes=30),
        additional_claims=additional_claims
    )
    
    # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
    payload = verify_token(token)
    
    assert payload is not None
    assert payload["sub"] == str(user_id)
    assert payload["role"] == "admin"
    assert payload["email"] == "test@example.com"
    assert payload["type"] == "access"

def test_expired_token():
    """–¢–µ—Å—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞"""
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
    token = create_access_token(
        subject=123,
        expires_delta=timedelta(seconds=-1)  # –ú–∏–Ω—É—Å 1 —Å–µ–∫—É–Ω–¥–∞
    )
    
    # –ü–æ–ø—ã—Ç–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    payload = verify_token(token)
    
    assert payload is None

# tests/unit/test_services.py
import pytest
from unittest.mock import AsyncMock, Mock, patch
from app.services.auth_service import AuthService
from app.schemas.auth import UserRegister

@pytest.mark.asyncio
async def test_user_registration():
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    # –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    mock_db = AsyncMock()
    mock_db.execute.return_value = AsyncMock()
    mock_db.execute.return_value.scalar_one_or_none.return_value = None
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
    auth_service = AuthService(mock_db)
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    user_data = UserRegister(
        email="test@example.com",
        username="testuser",
        password="TestPass123!",
        password_confirm="TestPass123!",
        full_name="Test User"
    )
    
    # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
    with patch('app.core.security.get_password_hash', return_value="hashed_password"):
        user = await auth_service.register(user_data)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    assert user.email == "test@example.com"
    assert user.username == "testuser"
    assert user.hashed_password == "hashed_password"
    mock_db.add.assert_called_once()
    mock_db.commit.assert_awaited_once()

@pytest.mark.asyncio
async def test_user_registration_duplicate_email():
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email"""
    mock_db = AsyncMock()
    
    # –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    from app.models.user import User
    existing_user = Mock(spec=User)
    existing_user.email = "existing@example.com"
    
    mock_db.execute.return_value.scalar_one_or_none.return_value = existing_user
    
    auth_service = AuthService(mock_db)
    
    user_data = UserRegister(
        email="existing@example.com",  # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π email
        username="newuser",
        password="TestPass123!",
        password_confirm="TestPass123!",
        full_name="New User"
    )
    
    # –û–∂–∏–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    with pytest.raises(Exception) as exc_info:
        await auth_service.register(user_data)
    
    assert "—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" in str(exc_info.value)
```

#### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API:**
```python
# tests/integration/test_auth_api.py
import pytest
from fastapi import status

def test_register_user(test_client):
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API"""
    user_data = {
        "email": "newuser@example.com",
        "username": "newuser",
        "password": "TestPass123!",
        "password_confirm": "TestPass123!",
        "full_name": "New User"
    }
    
    response = test_client.post("/api/v1/auth/register", json=user_data)
    
    assert response.status_code == status.HTTP_201_CREATED
    data = response.json()
    
    assert data["success"] == True
    assert "user_id" in data
    assert data["email"] == "newuser@example.com"

def test_login_user(test_client):
    """–¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API"""
    # –°–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = {
        "email": "loginuser@example.com",
        "username": "loginuser",
        "password": "TestPass123!",
        "password_confirm": "TestPass123!",
        "full_name": "Login User"
    }
    
    test_client.post("/api/v1/auth/register", json=user_data)
    
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏
    login_data = {
        "username": "loginuser",
        "password": "TestPass123!",
        "remember_me": False
    }
    
    response = test_client.post(
        "/api/v1/auth/login",
        data=login_data,
        headers={"Content-Type": "application/x-www-form-urlencoded"}
    )
    
    assert response.status_code == status.HTTP_200_OK
    data = response.json()
    
    assert "access_token" in data
    assert "refresh_token" in data
    assert data["token_type"] == "bearer"

def test_protected_endpoint_without_auth(test_client):
    """–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É endpoint –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    response = test_client.get("/api/v1/protected/authenticated")
    
    assert response.status_code == status.HTTP_401_UNAUTHORIZED

def test_protected_endpoint_with_auth(authenticated_client):
    """–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É endpoint —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π"""
    test_client, user, tokens = authenticated_client
    
    response = test_client.get("/api/v1/protected/authenticated")
    
    assert response.status_code == status.HTTP_200_OK
    data = response.json()
    
    assert data["message"] == f"–ü—Ä–∏–≤–µ—Ç, {user.username}!"

# tests/integration/test_files_api.py
import pytest
import io
from pathlib import Path

def test_file_upload(test_client):
    """–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ API"""
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç–∏
    test_file = io.BytesIO(b"Test file content")
    test_file.name = "test.txt"
    
    files = {
        "file": ("test.txt", test_file, "text/plain")
    }
    
    response = test_client.post(
        "/api/v1/files/upload",
        files=files,
        data={"category": "documents"}
    )
    
    assert response.status_code == status.HTTP_200_OK
    data = response.json()
    
    assert data["success"] == True
    assert "file" in data
    assert data["file"]["filename"] == "test.txt"

def test_image_upload_and_resize(test_client):
    """–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–µ—Å–∞–π–∑–∞"""
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫—Ä–∞—Å–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç 100x100)
    from PIL import Image
    import io
    
    img = Image.new('RGB', (100, 100), color='red')
    img_byte_arr = io.BytesIO()
    img.save(img_byte_arr, format='PNG')
    img_byte_arr.seek(0)
    
    files = {
        "file": ("red_square.png", img_byte_arr, "image/png")
    }
    
    # –ó–∞–≥—Ä—É–∑–∫–∞
    response = test_client.post("/api/v1/files/upload/image", files=files)
    assert response.status_code == 200
    
    data = response.json()
    image_url = data["file"]["url"]
    
    # –¢–µ—Å—Ç —Ä–µ—Å–∞–π–∑–∞ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    resized_url = f"{image_url}?width=50&height=50&format=webp"
    response = test_client.get(resized_url)
    
    assert response.status_code == 200
    assert response.headers["content-type"] == "image/webp"

# tests/integration/test_background_tasks.py
import pytest
import asyncio
from unittest.mock import patch, MagicMock

def test_background_task_scheduling(test_client):
    """–¢–µ—Å—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
    task_data = {
        "to_email": "test@example.com",
        "subject": "Test Email",
        "template_name": "welcome"
    }
    
    with patch('app.core.background_tasks.task_manager.add_task') as mock_add_task:
        response = test_client.post("/api/v1/background-tasks/send-email", json=task_data)
        
        assert response.status_code == status.HTTP_200_OK
        mock_add_task.assert_called_once()

def test_background_task_status(test_client):
    """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
    # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
    task_data = {
        "to_email": "test@example.com",
        "subject": "Test Email",
        "template_name": "welcome"
    }
    
    response = test_client.post("/api/v1/background-tasks/send-email", json=task_data)
    task_id = response.json()["task_id"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    response = test_client.get(f"/api/v1/background-tasks/status/{task_id}")
    
    assert response.status_code == status.HTTP_200_OK
    data = response.json()
    
    assert "status" in data
    assert data["task_id"] == task_id

# tests/integration/test_cors.py
def test_cors_preflight(test_client):
    """–¢–µ—Å—Ç preflight CORS –∑–∞–ø—Ä–æ—Å–∞"""
    headers = {
        "Origin": "http://localhost:3000",
        "Access-Control-Request-Method": "POST",
        "Access-Control-Request-Headers": "Content-Type"
    }
    
    response = test_client.options("/api/v1/cors-test/", headers=headers)
    
    assert response.status_code == 200
    assert "access-control-allow-origin" in response.headers
    assert "access-control-allow-methods" in response.headers

def test_cors_with_credentials(test_client):
    """–¢–µ—Å—Ç CORS —Å credentials"""
    headers = {
        "Origin": "http://localhost:3000"
    }
    
    response = test_client.post(
        "/api/v1/cors-test/with-credentials",
        json={"test": "data"},
        headers=headers
    )
    
    assert response.status_code == 200
    assert response.headers.get("access-control-allow-credentials") == "true"
    assert response.headers.get("access-control-allow-origin") == "http://localhost:3000"
```

#### **End-to-End —Ç–µ—Å—Ç—ã:**
```python
# tests/e2e/test_full_workflow.py
import pytest
from datetime import datetime, timedelta, timezone

def test_full_user_workflow(test_client):
    """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç workflow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –≤—Ö–æ–¥ ‚Üí –¥–µ–π—Å—Ç–≤–∏—è ‚Üí –≤—ã—Ö–æ–¥"""
    
    # 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    register_data = {
        "email": "workflow@example.com",
        "username": "workflowuser",
        "password": "WorkflowPass123!",
        "password_confirm": "WorkflowPass123!",
        "full_name": "Workflow User"
    }
    
    response = test_client.post("/api/v1/auth/register", json=register_data)
    assert response.status_code == 201
    
    # 2. –í—Ö–æ–¥
    login_data = {
        "username": "workflowuser",
        "password": "WorkflowPass123!"
    }
    
    response = test_client.post(
        "/api/v1/auth/login",
        data=login_data,
        headers={"Content-Type": "application/x-www-form-urlencoded"}
    )
    assert response.status_code == 200
    
    tokens = response.json()
    access_token = tokens["access_token"]
    refresh_token = tokens["refresh_token"]
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    headers = {"Authorization": f"Bearer {access_token}"}
    
    # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    response = test_client.get("/api/v1/auth/me", headers=headers)
    assert response.status_code == 200
    
    user_info = response.json()
    assert user_info["data"]["username"] == "workflowuser"
    
    # 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    test_file = io.BytesIO(b"Test document content")
    test_file.name = "document.txt"
    
    files = {"file": ("document.txt", test_file, "text/plain")}
    
    response = test_client.post(
        "/api/v1/files/upload",
        files=files,
        data={"category": "documents"},
        headers=headers
    )
    assert response.status_code == 200
    
    # 5. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    task_data = {
        "report_type": "monthly",
        "date_from": (datetime.now(timezone.utc) - timedelta(days=30)).isoformat(),
        "date_to": datetime.now(timezone.utc).isoformat()
    }
    
    response = test_client.post(
        "/api/v1/background-tasks/generate-report",
        json=task_data,
        headers=headers
    )
    assert response.status_code == 200
    
    # 6. –í—ã—Ö–æ–¥
    logout_data = {"refresh_token": refresh_token}
    response = test_client.post("/api/v1/auth/logout", json=logout_data, headers=headers)
    assert response.status_code == 200
    
    # 7. –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)
    response = test_client.get("/api/v1/auth/me", headers=headers)
    assert response.status_code == 401

def test_error_handling_workflow(test_client):
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö"""
    
    # 1. –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    invalid_register_data = {
        "email": "not-an-email",
        "username": "ab",  # –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ
        "password": "123",  # –°–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π
        "password_confirm": "456"  # –ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    }
    
    response = test_client.post("/api/v1/auth/register", json=invalid_register_data)
    assert response.status_code == 422  # Validation error
    
    # 2. –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint
    response = test_client.get("/api/v1/non-existent-endpoint")
    assert response.status_code == 404
    
    # 3. –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
    headers = {"Authorization": "Bearer invalid_token"}
    response = test_client.get("/api/v1/protected/authenticated", headers=headers)
    assert response.status_code == 401
    
    # 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞
    large_file = io.BytesIO(b"x" * (11 * 1024 * 1024))  # 11MB
    large_file.name = "large.txt"
    
    files = {"file": ("large.txt", large_file, "text/plain")}
    
    response = test_client.post(
        "/api/v1/files/upload",
        files=files,
        data={"category": "documents", "max_size_mb": 10}  # –õ–∏–º–∏—Ç 10MB
    )
    assert response.status_code == 400
```

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```python
# pytest.ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
asyncio_mode = auto
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# .github/workflows/tests.yml (–¥–ª—è CI/CD)
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run tests with pytest
      run: |
        pytest tests/ --cov=app --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

# requirements-test.txt
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
httpx==0.25.2
pillow==10.1.0
```

---

## **üèÜ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é 13**

### **–ß–∞—Å—Ç—å 1: –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏**

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –æ—Ç–ø—Ä–∞–≤–∫–∏ email –≤ —Ñ–æ–Ω–µ:**
   - –°–æ–∑–¥–∞–Ω–∏–µ HTML —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è email
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ SMTP
   - –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

2. **–î–æ–±–∞–≤—å—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–æ–≤:**
   - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ/–µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
   - –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF/Excel
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ email

3. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
   - –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏

### **–ß–∞—Å—Ç—å 2: –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏**

1. **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
   - –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ç–∏–ø–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ

2. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AWS S3 –∏–ª–∏ Yandex Cloud
   - CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

3. **–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º:**
   - –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–∏–ø—É, –¥–∞—Ç–µ
   - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –ü–∞–∫–µ—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ

### **–ß–∞—Å—Ç—å 3: CORS –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é CORS –ø–æ–ª–∏—Ç–∏–∫—É:**
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ origins
   - –†–∞–∑–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö endpoints
   - Preflight –∑–∞–ø—Ä–æ—Å—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

2. **–î–æ–±–∞–≤—å—Ç–µ –∑–∞—â–∏—Ç—É –æ—Ç CSRF:**
   - CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ñ–æ—Ä–º
   - SameSite cookies
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ Referer –∑–∞–≥–æ–ª–æ–≤–∫–∞

3. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ rate limiting:**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ IP
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö endpoints

### **–ß–∞—Å—Ç—å 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

1. **–ù–∞–ø–∏—à–∏—Ç–µ unit —Ç–µ—Å—Ç—ã:**
   - –¢–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —É—Ç–∏–ª–∏—Ç
   - Mocking –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - –¢–µ—Å—Ç—ã –Ω–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏

2. **–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
   - –¢–µ—Å—Ç—ã API endpoints
   - –¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
   - –¢–µ—Å—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ CI/CD:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
   - –û—Ç—á–µ—Ç—ã –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

## **üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏**

### **–ë–∞–∑–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (40 –±–∞–ª–ª–æ–≤):**
1. **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** (10 –±–∞–ª–ª–æ–≤):
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ BackgroundTasks
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–µ
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

2. **–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏** (15 –±–∞–ª–ª–æ–≤):
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

3. **CORS** (5 –±–∞–ª–ª–æ–≤):
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ middleware
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ credentials
   - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (10 –±–∞–ª–ª–æ–≤):
   - Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (30 –±–∞–ª–ª–æ–≤):**
1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (10 –±–∞–ª–ª–æ–≤):
   - –û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤** (10 –±–∞–ª–ª–æ–≤):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∏—Ä—É—Å—ã
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
   - –ü–æ–¥–ø–∏—Å—å URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

3. **CI/CD –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ** (10 –±–∞–ª–ª–æ–≤):
   - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –û—Ç—á–µ—Ç—ã –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∫–æ–¥–∞
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitHub Actions

### **–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (20 –±–∞–ª–ª–æ–≤):**
1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** (10 –±–∞–ª–ª–æ–≤):
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** (10 –±–∞–ª–ª–æ–≤):
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
   - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
   - –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

## **üéØ –ò—Ç–æ–≥ –Ω–µ–¥–µ–ª–∏ 13**

–ö –∫–æ–Ω—Ü—É –Ω–µ–¥–µ–ª–∏ –≤—ã –æ—Å–≤–æ–∏—Ç–µ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã**, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç production-ready –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞:

### **–ß—Ç–æ –≤—ã –∏–∑—É—á–∏–ª–∏:**

1. **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (Background Tasks)**
   - –ü—Ä–æ–±–ª–µ–º–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –µ—ë —Ä–µ—à–µ–Ω–∏–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FastAPI `BackgroundTasks` –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
   - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ (TaskTracker)
   - –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (Celery, ARQ, RQ)
   - –ü—Ä–∏–Ω—Ü–∏–ø—ã: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

2. **–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏**
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ FastAPI
   - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: –ª–æ–∫–∞–ª—å–Ω–æ, –æ–±–ª–∞–∫–æ, –ë–î, CDN
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞, —Ä–∞–∑–º–µ—Ä–∞, —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: –º–∏–Ω–∏–∞—Ç—é—Ä—ã, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ —á–µ—Ä–µ–∑ `aiofiles`

3. **CORS (Cross-Origin Resource Sharing)**
   - –ü—Ä–æ–±–ª–µ–º–∞ Same-Origin Policy –∏ –µ—ë —Ä–µ—à–µ–Ω–∏–µ
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS middleware –≤ FastAPI
   - Preflight –∑–∞–ø—Ä–æ—Å—ã –∏ –∏—Ö –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è production
   - –ü—Ä–∏–Ω—Ü–∏–ø—ã: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å credentials

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: Unit (70%), Integration (20%), E2E (10%)
   - –ü—Ä–∏–Ω—Ü–∏–ø—ã F.I.R.S.T. –∏ AAA (Arrange-Act-Assert)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å pytest –∏ pytest-asyncio
   - Unit —Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
   - E2E —Ç–µ—Å—Ç—ã –ø–æ–ª–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### **–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–≤—ã–∫–∏:**

- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –≤ —Ñ–æ–Ω–µ** - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º API –¥–æ–ª–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –º–µ–¥–∏–∞** - –≤–∞–ª–∏–¥–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞, —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–∂—Å–∞–π—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CORS
- ‚úÖ **–ù–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤** - unit, integration, E2E —Ç–µ—Å—Ç—ã
- ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - GitHub Actions, –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ:
- –°–æ–∑–¥–∞–≤–∞—Ç—å endpoints, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ–ª–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å –±—ç–∫–µ–Ω–¥–æ–º
- –ü–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ CI/CD

### **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

–≠—Ç–∏ –Ω–∞–≤—ã–∫–∏ –ø–æ–∑–≤–æ–ª—è—Ç –≤–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ, –Ω–∞–¥–µ–∂–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**, –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞–±–æ—Ç–µ –≤ production —Å—Ä–µ–¥–µ. –í—ã –Ω–∞—É—á–∏–ª–∏—Å—å –Ω–µ —Ç–æ–ª—å–∫–æ –ø–∏—Å–∞—Ç—å –∫–æ–¥, –Ω–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–æ, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è:**
- –ò–∑—É—á–∏—Ç–µ Celery –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
- –û—Å–≤–æ–π—Ç–µ –æ–±–ª–∞—á–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (AWS S3, Yandex Object Storage)
- –£–≥–ª—É–±–∏—Ç–µ—Å—å –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: property-based testing, mutation testing
- –ò–∑—É—á–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production